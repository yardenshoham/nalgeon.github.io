<!doctype html><html lang=en>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Ranking data with SQL Window Functions</title>
<meta name=description content="Making ratings and dividing data into partitions.">
<meta name=robots content="index, follow">
<link rel=stylesheet type=text/css href=/assets/css/style.d5574c61892ae0c9bca2eab9c37cfcbc17d93429a85b516e1dd46f7df294f4cc.css>
<link rel=icon href=/assets/favicon/favicon.ico sizes=any>
<link rel=icon type=image/svg+xml href=/assets/favicon/favicon.svg>
<link rel=apple-touch-icon href=/assets/favicon/apple-touch-icon.png>
<link rel=manifest href=/assets/favicon/manifest.json>
<link rel=canonical href=https://antonz.org/sql-window-functions-ranking/>
<meta name=author content="Anton Zhiyanov">
<meta property="og:type" content="article">
<meta property="og:title" content="Ranking data with SQL Window Functions">
<meta property="og:description" content="Making ratings and dividing data into partitions.">
<meta property="og:url" content="https://antonz.org/sql-window-functions-ranking/">
<meta property="og:image" content="https://antonz.org/sql-window-functions-ranking/cover.png">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:title content="Ranking data with SQL Window Functions">
<meta name=twitter:description content="Making ratings and dividing data into partitions.">
<meta name=twitter:url content="https://antonz.org/sql-window-functions-ranking/">
<meta name=twitter:site content="@ohmypy">
<meta name=twitter:image content="https://antonz.org/sql-window-functions-ranking/cover.png"></head>
<body>
<div class=header>
<div class=container>
<div class=row>
<div class="col-xs-6 col-sm-3">
<a class=img-link href=/>
<img src=/assets/logo.svg class=header-icon>
</a> 
<a href=/>
<strong>Anton Zhiyanov</strong>
</a>
</div>
<div class="col-xs-12 col-sm-6 col-md-4 hidden-mobile">
<a class=menu__link href=/all/>
<span>blog</span>
</a>
<a class=menu__link href=/#about>
<span>contacts</span>
</a>
<a class=menu__link href=https://antonz.ru>
<span>ru</span>
</a>
</div>
</div>
</div>
</div>
<div class=storey>
<div class=container>
<article class=post>
<div class=row>
<div class="col-xs-12 col-sm-10 article">
<header>
<h1>Ranking data with SQL Window Functions</h1>
</header>
<p><em>This is an excerpt from my book <a href=/sql-window-functions-book>SQL Window Functions Explained</a>. The book is a clear and visual introduction to the topic with lots of practical exercises.</em></p>
<p>Ranking means coming up with all kinds of ratings, starting from the winners of the World Swimming Championships and ending with the Forbes 500.</p>
<p>We will rank records from the toy <code>employees</code> table:</p>
<pre tabindex=0><code>┌────┬───────┬────────┬────────────┬────────┐
│ id │ name  │  city  │ department │ salary │
├────┼───────┼────────┼────────────┼────────┤
│ 11 │ Diane │ London │ hr         │ 70     │
│ 12 │ Bob   │ London │ hr         │ 78     │
│ 21 │ Emma  │ London │ it         │ 84     │
│ 22 │ Grace │ Berlin │ it         │ 90     │
│ 23 │ Henry │ London │ it         │ 104    │
│ 24 │ Irene │ Berlin │ it         │ 104    │
│ 25 │ Frank │ Berlin │ it         │ 120    │
│ 31 │ Cindy │ Berlin │ sales      │ 96     │
│ 32 │ Dave  │ London │ sales      │ 96     │
│ 33 │ Alice │ Berlin │ sales      │ 100    │
└────┴───────┴────────┴────────────┴────────┘
</code></pre><p><a href=https://sqlime.org/#employees.db>playground</a> • <a href=/sql-window-functions-book/employees.sql>download</a></p>
<p>Table of contents:</p>
<ul>
<li><a href=#salary-rating>Salary rating</a></li>
<li><a href=#window-ordering-vs-result-ordering>Window ordering vs. result ordering</a></li>
<li><a href=#sorting-uniqueness>Sorting uniqueness</a></li>
<li><a href=#salary-rating-by-department>​​Salary rating by department</a></li>
<li><a href=#salary-groups>Salary groups</a></li>
<li><a href=#ranking-functions>Ranking functions</a></li>
<li><a href=#keep-it-up>Keep it up</a></li>
</ul>
<div class=boxed>
<h3>Databases</h3>
<p>All modern relational databases support window functions to some extent. I tested this article on three of them:</p>
<ul>
<li>MySQL 8.0.2+ (MariaDB 10.2+)</li>
<li>PostgreSQL 11+</li>
<li>SQLite 3.28+</li>
</ul>
<p>Windows are fully implemented in PostgreSQL, and almost fully in SQLite. MySQL has all the core features but lacks some of the advanced ones.</p>
<p>Oracle 11g+, MS SQL 2012+, and Google BigQuery are also fine. They lack certain advanced capabilities, just like MySQL. If you use one of them — the article will also be helpful.</p>
<p>You can use any of the mentioned DBMS if you have one available. Or an <a href=https://sqlime.org/#employees.db>online playground</a>.</p>
</div>
<h2 id=salary-rating>Salary rating</h2>
<p>Let&rsquo;s make an employee rating by salary:</p>
<div class=row>
<div class="col-xs-12 col-sm-5">
before<br>
<figure><img src=before.png width=300 alt="Before ranking"></figure>
</div>
<div class="col-xs-12 col-sm-5">
after<br>
<figure><img src=rank-after.png width=300 alt="After ranking"></figure>
</div>
</div>
<p>Note that employees with the same salary received the same rank (Henry and Irene, Cindy and Dave).</p>
<p>How do we go from &ldquo;before&rdquo; to &ldquo;after&rdquo;?</p>
<p>First, let&rsquo;s sort the table in descending order of salary:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#a90d91>select</span>
  <span style=color:#a90d91>null</span> <span style=color:#a90d91>as</span> <span style=color:#c41a16>&#34;rank&#34;</span>,
  <span style=color:#000>name</span>, <span style=color:#000>department</span>, <span style=color:#000>salary</span>
<span style=color:#a90d91>from</span> <span style=color:#000>employees</span>
<span style=color:#a90d91>order</span> <span style=color:#a90d91>by</span> <span style=color:#000>salary</span> <span style=color:#a90d91>desc</span>, <span style=color:#000>id</span>;
</code></pre></div><pre tabindex=0><code>┌──────┬───────┬────────────┬────────┐
│ rank │ name  │ department │ salary │
├──────┼───────┼────────────┼────────┤
│      │ Frank │ it         │ 120    │
│      │ Henry │ it         │ 104    │
│      │ Irene │ it         │ 104    │
│      │ Alice │ sales      │ 100    │
│      │ Cindy │ sales      │ 96     │
│      │ Dave  │ sales      │ 96     │
│      │ Grace │ it         │ 90     │
│      │ Emma  │ it         │ 84     │
│      │ Bob   │ hr         │ 78     │
│      │ Diane │ hr         │ 70     │
└──────┴───────┴────────────┴────────┘
</code></pre><p>Now let&rsquo;s go from the first row to the last and calculate the rank of each record. We will start with one and increase the rank every time the salary value is less than the previous one:</p>
<div class=row>
<div class="col-xs-12 col-sm-5">
➀<br>
<figure><img src=rank/03.png width=300 alt="Ranking step #1"></figure>
</div>
<div class="col-xs-12 col-sm-5">
➁<br>
<figure><img src=rank/04.png width=300 alt="Ranking step #2"></figure>
</div>
</div>
<div class=row>
<div class="col-xs-12 col-sm-5">
➂<br>
<figure><img src=rank/05.png width=300 alt="Ranking step #3"></figure>
</div>
<div class="col-xs-12 col-sm-5">
➃<br>
<figure><img src=rank/06.png width=300 alt="Ranking step #4"></figure>
</div>
</div>
<div class=row>
<div class="col-xs-12 col-sm-5">
➄<br>
<figure><img src=rank/07.png width=300 alt="Ranking step #5"></figure>
</div>
<div class="col-xs-12 col-sm-5">
<p>and so on...</p>
</div>
</div>
<p>To compute the rank, at each step we will look at the <code>salary</code> values, highlighted with a blue frame. Let&rsquo;s call these values a <em>window</em>.</p>
<p>Let&rsquo;s describe the window contents in plain English:</p>
<ol>
<li>These are the values of the salary column.</li>
<li>They are ordered from larger to smaller values.</li>
</ol>
<p>Let&rsquo;s express it in SQL:</p>
<pre tabindex=0><code>window w as (order by salary desc)
</code></pre><ul>
<li><code>window</code> — a keyword announcing that the window definition will follow;</li>
<li><code>w</code> — the name of the window (could be anything);</li>
<li><code>(order by salary desc)</code> — the window definition (&ldquo;values of the salary column in descending order&rdquo;).</li>
</ul>
<p>Our goal is to calculate the rank over the window <code>w</code>. In SQL, this is written as <code>dense_rank() over w</code>.</p>
<p><code>dense_rank()</code> is a <em>window function</em> that counts the rank over the specified <em>window</em>. The logic of <code>dense_rank()</code> is the same as when we counted manually — start with one and increase the rank every time the next window value differs from the previous one.</p>
<p>Let&rsquo;s add the window definition and the window function to the original query:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#a90d91>select</span>
  <span style=color:#000>dense_rank</span>() <span style=color:#000>over</span> <span style=color:#000>w</span> <span style=color:#a90d91>as</span> <span style=color:#c41a16>&#34;rank&#34;</span>,
  <span style=color:#000>name</span>, <span style=color:#000>department</span>, <span style=color:#000>salary</span>
<span style=color:#a90d91>from</span> <span style=color:#000>employees</span>
<span style=color:#000>window</span> <span style=color:#000>w</span> <span style=color:#a90d91>as</span> (<span style=color:#a90d91>order</span> <span style=color:#a90d91>by</span> <span style=color:#000>salary</span> <span style=color:#a90d91>desc</span>)
<span style=color:#a90d91>order</span> <span style=color:#a90d91>by</span> <span style=color:#c41a16>&#34;rank&#34;</span>, <span style=color:#000>id</span>;
</code></pre></div><pre tabindex=0><code>┌──────┬───────┬────────────┬────────┐
│ rank │ name  │ department │ salary │
├──────┼───────┼────────────┼────────┤
│ 1    │ Frank │ it         │ 120    │
│ 2    │ Henry │ it         │ 104    │
│ 2    │ Irene │ it         │ 104    │
│ 3    │ Alice │ sales      │ 100    │
│ 4    │ Cindy │ sales      │ 96     │
│ 4    │ Dave  │ sales      │ 96     │
│ 5    │ Grace │ it         │ 90     │
│ 6    │ Emma  │ it         │ 84     │
│ 7    │ Bob   │ hr         │ 78     │
│ 8    │ Diane │ hr         │ 70     │
└──────┴───────┴────────────┴────────┘
</code></pre><p>Here&rsquo;s how the engine executes this query:</p>
<ol>
<li>Take the table specified in <code>from</code>.</li>
<li>Select all records from it.</li>
<li>Calculate the value of <code>dense_rank()</code> for each record using the window <code>w</code>.</li>
<li>Sort the result as specified in <code>order by</code>.</li>
</ol>
<p>Here&rsquo;s an animation of how the engine executes step 3, where the rank is assigned:</p>
<div class=row>
<div class="col-xs-12 col-sm-5">
<figure>
<img src=rank.gif width=300 alt="Ranking animation">
</figure>
</div>
</div>
<p>The <code>window</code> clause itself does not affect query results. It only defines the window that we can use in the query. If we remove the <code>dense_rank()</code> call, the query will work as if there is no window:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#a90d91>select</span>
  <span style=color:#a90d91>null</span> <span style=color:#a90d91>as</span> <span style=color:#c41a16>&#34;rank&#34;</span>,
  <span style=color:#000>name</span>, <span style=color:#000>department</span>, <span style=color:#000>salary</span>
<span style=color:#a90d91>from</span> <span style=color:#000>employees</span>
<span style=color:#000>window</span> <span style=color:#000>w</span> <span style=color:#a90d91>as</span> (<span style=color:#a90d91>order</span> <span style=color:#a90d91>by</span> <span style=color:#000>salary</span> <span style=color:#a90d91>desc</span>)
<span style=color:#a90d91>order</span> <span style=color:#a90d91>by</span> <span style=color:#000>salary</span> <span style=color:#a90d91>desc</span>, <span style=color:#000>id</span>;
</code></pre></div><pre tabindex=0><code>┌──────┬───────┬────────────┬────────┐
│ rank │ name  │ department │ salary │
├──────┼───────┼────────────┼────────┤
│      │ Frank │ it         │ 120    │
│      │ Henry │ it         │ 104    │
│      │ Irene │ it         │ 104    │
│      │ Alice │ sales      │ 100    │
│      │ Cindy │ sales      │ 96     │
│      │ Dave  │ sales      │ 96     │
│      │ Grace │ it         │ 90     │
│      │ Emma  │ it         │ 84     │
│      │ Bob   │ hr         │ 78     │
│      │ Diane │ hr         │ 70     │
└──────┴───────┴────────────┴────────┘
</code></pre><p>The window starts working only when a window function in <code>select</code> uses it.</p>
<hr>
<p><strong>Window queries in Oracle and MS SQL Server databases</strong></p>
<p>Neither Oracle nor SQL Server support the <code>window</code> clause. To make a window query work in these databases, move the window definition inside the <code>over</code> clause.</p>
<p>Instead of this:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#a90d91>select</span>
  <span style=color:#000>dense_rank</span>() <span style=color:#000>over</span> <span style=color:#000>w</span> <span style=color:#a90d91>as</span> <span style=color:#c41a16>&#34;rank&#34;</span>,
  <span style=color:#000>name</span>, <span style=color:#000>department</span>, <span style=color:#000>salary</span>
<span style=color:#a90d91>from</span> <span style=color:#000>employees</span>
<span style=color:#000>window</span> <span style=color:#000>w</span> <span style=color:#a90d91>as</span> (<span style=color:#a90d91>order</span> <span style=color:#a90d91>by</span> <span style=color:#000>salary</span> <span style=color:#a90d91>desc</span>)
<span style=color:#a90d91>order</span> <span style=color:#a90d91>by</span> <span style=color:#c41a16>&#34;rank&#34;</span>, <span style=color:#000>id</span>;
</code></pre></div><p>Do this:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#a90d91>select</span>
  <span style=color:#000>dense_rank</span>() <span style=color:#000>over</span> (
    <span style=color:#a90d91>order</span> <span style=color:#a90d91>by</span> <span style=color:#000>salary</span> <span style=color:#a90d91>desc</span>
  ) <span style=color:#a90d91>as</span> <span style=color:#c41a16>&#34;rank&#34;</span>,
  <span style=color:#000>name</span>, <span style=color:#000>department</span>, <span style=color:#000>salary</span>
<span style=color:#a90d91>from</span> <span style=color:#000>employees</span>
<span style=color:#a90d91>order</span> <span style=color:#a90d91>by</span> <span style=color:#c41a16>&#34;rank&#34;</span>, <span style=color:#000>id</span>;
</code></pre></div><hr>
<h2 id=window-ordering-vs-result-ordering>Window ordering vs. result ordering</h2>
<p>People often have questions about window sorting. Let&rsquo;s break them down.</p>
<p>Here is a query that calculates a salary rating:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#a90d91>select</span>
  <span style=color:#000>dense_rank</span>() <span style=color:#000>over</span> <span style=color:#000>w</span> <span style=color:#a90d91>as</span> <span style=color:#c41a16>&#34;rank&#34;</span>,
  <span style=color:#000>name</span>, <span style=color:#000>department</span>, <span style=color:#000>salary</span>
<span style=color:#a90d91>from</span> <span style=color:#000>employees</span>
<span style=color:#000>window</span> <span style=color:#000>w</span> <span style=color:#a90d91>as</span> (<span style=color:#a90d91>order</span> <span style=color:#a90d91>by</span> <span style=color:#000>salary</span> <span style=color:#a90d91>desc</span>)
<span style=color:#a90d91>order</span> <span style=color:#a90d91>by</span> <span style=color:#c41a16>&#34;rank&#34;</span>, <span style=color:#000>id</span>;
</code></pre></div><pre tabindex=0><code>┌──────┬───────┬────────────┬────────┐
│ rank │ name  │ department │ salary │
├──────┼───────┼────────────┼────────┤
│ 1    │ Frank │ it         │ 120    │
│ 2    │ Henry │ it         │ 104    │
│ 2    │ Irene │ it         │ 104    │
│ 3    │ Alice │ sales      │ 100    │
│ 4    │ Cindy │ sales      │ 96     │
│ 4    │ Dave  │ sales      │ 96     │
│ 5    │ Grace │ it         │ 90     │
│ 6    │ Emma  │ it         │ 84     │
│ 7    │ Bob   │ hr         │ 78     │
│ 8    │ Diane │ hr         │ 70     │
└──────┴───────┴────────────┴────────┘
</code></pre><p>Let&rsquo;s leave the <code>order by</code> in the window but remove it from the main query:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#a90d91>select</span>
  <span style=color:#000>dense_rank</span>() <span style=color:#000>over</span> <span style=color:#000>w</span> <span style=color:#a90d91>as</span> <span style=color:#c41a16>&#34;rank&#34;</span>,
  <span style=color:#000>name</span>, <span style=color:#000>department</span>, <span style=color:#000>salary</span>
<span style=color:#a90d91>from</span> <span style=color:#000>employees</span>
<span style=color:#000>window</span> <span style=color:#000>w</span> <span style=color:#a90d91>as</span> (<span style=color:#a90d91>order</span> <span style=color:#a90d91>by</span> <span style=color:#000>salary</span> <span style=color:#a90d91>desc</span>);
</code></pre></div><p>Nothing has changed:</p>
<pre tabindex=0><code>┌──────┬───────┬────────────┬────────┐
│ rank │ name  │ department │ salary │
├──────┼───────┼────────────┼────────┤
│ 1    │ Frank │ it         │ 120    │
│ 2    │ Henry │ it         │ 104    │
│ 2    │ Irene │ it         │ 104    │
│ 3    │ Alice │ sales      │ 100    │
│ 4    │ Cindy │ sales      │ 96     │
│ 4    │ Dave  │ sales      │ 96     │
│ 5    │ Grace │ it         │ 90     │
│ 6    │ Emma  │ it         │ 84     │
│ 7    │ Bob   │ hr         │ 78     │
│ 8    │ Diane │ hr         │ 70     │
└──────┴───────┴────────────┴────────┘
</code></pre><p>So why use <code>order by</code> in the main query?</p>
<p>The window&rsquo;s <code>order by</code> defines the window sorting, while the main query&rsquo;s <code>order by</code> defines the final result sorting after the rest of the query is complete.</p>
<p>Let&rsquo;s say we want to assign a rank in descending order of salary but sort in the opposite, ascending order:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#a90d91>select</span>
  <span style=color:#000>dense_rank</span>() <span style=color:#000>over</span> <span style=color:#000>w</span> <span style=color:#a90d91>as</span> <span style=color:#c41a16>&#34;rank&#34;</span>,
  <span style=color:#000>name</span>, <span style=color:#000>department</span>, <span style=color:#000>salary</span>
<span style=color:#a90d91>from</span> <span style=color:#000>employees</span>
<span style=color:#000>window</span> <span style=color:#000>w</span> <span style=color:#a90d91>as</span> (<span style=color:#a90d91>order</span> <span style=color:#a90d91>by</span> <span style=color:#000>salary</span> <span style=color:#a90d91>desc</span>)
<span style=color:#a90d91>order</span> <span style=color:#a90d91>by</span> <span style=color:#000>salary</span> <span style=color:#a90d91>asc</span>;
</code></pre></div><pre tabindex=0><code>┌──────┬───────┬────────────┬────────┐
│ rank │ name  │ department │ salary │
├──────┼───────┼────────────┼────────┤
│ 8    │ Diane │ hr         │ 70     │
│ 7    │ Bob   │ hr         │ 78     │
│ 6    │ Emma  │ it         │ 84     │
│ 5    │ Grace │ it         │ 90     │
│ 4    │ Cindy │ sales      │ 96     │
│ 4    │ Dave  │ sales      │ 96     │
│ 3    │ Alice │ sales      │ 100    │
│ 2    │ Henry │ it         │ 104    │
│ 2    │ Irene │ it         │ 104    │
│ 1    │ Frank │ it         │ 120    │
└──────┴───────┴────────────┴────────┘
</code></pre><p>As you can see, the rank is assigned according to the window sorting (<code>salary desc</code>), and the results are ordered according to the main query sorting (<code>salary asc</code>).</p>
<p>If the query&rsquo;s <code>order by</code> clause is not specified, the result order is undefined. Sometimes it might work out (as in the example with the ascending salary ranking), and sometimes it might not. It&rsquo;s not worth relying on luck, so always specify the order of results explicitly.</p>
<h2 id=sorting-uniqueness>Sorting uniqueness</h2>
<p>Another popular question is why to include the <code>id</code> column in the result ordering:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#a90d91>select</span>
  <span style=color:#000>dense_rank</span>() <span style=color:#000>over</span> <span style=color:#000>w</span> <span style=color:#a90d91>as</span> <span style=color:#c41a16>&#34;rank&#34;</span>,
  <span style=color:#000>name</span>, <span style=color:#000>department</span>, <span style=color:#000>salary</span>
<span style=color:#a90d91>from</span> <span style=color:#000>employees</span>
<span style=color:#000>window</span> <span style=color:#000>w</span> <span style=color:#a90d91>as</span> (<span style=color:#a90d91>order</span> <span style=color:#a90d91>by</span> <span style=color:#000>salary</span> <span style=color:#a90d91>desc</span>)
<span style=color:#a90d91>order</span> <span style=color:#a90d91>by</span> <span style=color:#c41a16>&#34;rank&#34;</span>, <span style=color:#000>id</span>;
</code></pre></div><pre tabindex=0><code>┌──────┬───────┬────────────┬────────┐
│ rank │ name  │ department │ salary │
├──────┼───────┼────────────┼────────┤
│ 1    │ Frank │ it         │ 120    │
│ 2    │ Henry │ it         │ 104    │
│ 2    │ Irene │ it         │ 104    │
│ 3    │ Alice │ sales      │ 100    │
│ 4    │ Cindy │ sales      │ 96     │
│ 4    │ Dave  │ sales      │ 96     │
│ 5    │ Grace │ it         │ 90     │
│ 6    │ Emma  │ it         │ 84     │
│ 7    │ Bob   │ hr         │ 78     │
│ 8    │ Diane │ hr         │ 70     │
└──────┴───────┴────────────┴────────┘
</code></pre><p>Why use <code>order by rank, id</code> instead of <code>order by rank</code>? To know how to sort employees with the same rank. Without the <code>id</code>, the order of records &ldquo;Henry-Irene&rdquo; and &ldquo;Cindy-Dave&rdquo; is undefined, and the DB engine can arrange them in any order. But with the <code>id</code>, everything is clear: &ldquo;Henry, then Irene&rdquo; and &ldquo;Cindy, then Dave&rdquo;.</p>
<div class=boxed>
<h3>✎ Exercise: Ranking by name</h3>
<p>Practice is crucial in turning abstract knowledge into skills, making theory alone insufficient. The book, unlike this article, contains a lot of exercises; that's why I recommend <a href=https://antonz.gumroad.com/l/sql-windows>getting it</a>.</p>
<p>If you are okay with just theory for now, though — let's continue.</p>
</div>
<h2 id=salary-rating-by-department>​​Salary rating by department</h2>
<p>Let&rsquo;s make an employee salary rating independently for each department:</p>
<div class=row>
<div class="col-xs-12 col-sm-5">
before<br>
<figure><img src=before.png width=300 alt="Before partitioned ranking"></figure>
</div>
<div class="col-xs-12 col-sm-5">
after<br>
<figure><img src=partition-after.png width=300 alt="After partitioned ranking"></figure>
</div>
</div>
<p>How do we go from &ldquo;before&rdquo; to &ldquo;after&rdquo;?</p>
<p>First, let&rsquo;s sort the table by department. Within the same department, let&rsquo;s sort in descending order of salary:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#a90d91>select</span>
  <span style=color:#a90d91>null</span> <span style=color:#a90d91>as</span> <span style=color:#c41a16>&#34;rank&#34;</span>,
  <span style=color:#000>name</span>, <span style=color:#000>department</span>, <span style=color:#000>salary</span>
<span style=color:#a90d91>from</span> <span style=color:#000>employees</span>
<span style=color:#a90d91>order</span> <span style=color:#a90d91>by</span> <span style=color:#000>department</span>, <span style=color:#000>salary</span> <span style=color:#a90d91>desc</span>, <span style=color:#000>id</span>;
</code></pre></div><pre tabindex=0><code>┌──────┬───────┬────────────┬────────┐
│ rank │ name  │ department │ salary │
├──────┼───────┼────────────┼────────┤
│      │ Bob   │ hr         │ 78     │
│      │ Diane │ hr         │ 70     │
│      │ Frank │ it         │ 120    │
│      │ Henry │ it         │ 104    │
│      │ Irene │ it         │ 104    │
│      │ Grace │ it         │ 90     │
│      │ Emma  │ it         │ 84     │
│      │ Alice │ sales      │ 100    │
│      │ Cindy │ sales      │ 96     │
│      │ Dave  │ sales      │ 96     │
└──────┴───────┴────────────┴────────┘
</code></pre><p>Now let&rsquo;s go from the first row to the last and calculate the rank of each record. We will start with one and increase the rank every time the <code>salary</code> value is less than the previous one. When switching between departments, we will reset the rank back to 1:</p>
<div class=row>
<div class="col-xs-12 col-sm-5">
➀<br>
<figure><img src=partition/03.png width=300 alt="Partitioned ranking step #1"></figure>
</div>
<div class="col-xs-12 col-sm-5">
➁<br>
<figure><img src=partition/04.png width=300 alt="Partitioned ranking step #2"></figure>
</div>
</div>
<div class=row>
<div class="col-xs-12 col-sm-5">
➂<br>
<figure><img src=partition/05.png width=300 alt="Partitioned ranking step #3"></figure>
</div>
<div class="col-xs-12 col-sm-5">
➃<br>
<figure><img src=partition/06.png width=300 alt="Partitioned ranking step #4"></figure>
</div>
</div>
<div class=row>
<div class="col-xs-12 col-sm-5">
➄<br>
<figure><img src=partition/07.png width=300 alt="Partitioned ranking step #5"></figure>
</div>
<div class="col-xs-12 col-sm-5">
<p>and so on...</p>
</div>
</div>
<p>To compute the rank, at each step we will look at the <code>salary</code> values, highlighted with a blue frame. It is the <em>window</em> in this case.</p>
<p>The window changes depending on which department the current record belongs to. Let&rsquo;s describe it in plain English:</p>
<ol>
<li>The window is split into several independent partitions — one for each department.</li>
<li>Inside each partition, records are ordered by decreasing salary.</li>
</ol>
<p>Let&rsquo;s express it in SQL:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#000>window</span> <span style=color:#000>w</span> <span style=color:#a90d91>as</span> (
  <span style=color:#000>partition</span> <span style=color:#a90d91>by</span> <span style=color:#000>department</span>
  <span style=color:#a90d91>order</span> <span style=color:#a90d91>by</span> <span style=color:#000>salary</span> <span style=color:#a90d91>desc</span>
)
</code></pre></div><ul>
<li><code>partition by department</code> specifies how to split the window into partitions;</li>
<li><code>order by salary desc</code> sets the sorting within the partition.</li>
</ul>
<p>The rank calculation function remains the same — <code>dense_rank()</code>.</p>
<p>Let&rsquo;s add the window definition and the window function to the original query:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#a90d91>select</span>
  <span style=color:#000>dense_rank</span>() <span style=color:#000>over</span> <span style=color:#000>w</span> <span style=color:#a90d91>as</span> <span style=color:#c41a16>&#34;rank&#34;</span>,
  <span style=color:#000>name</span>, <span style=color:#000>department</span>, <span style=color:#000>salary</span>
<span style=color:#a90d91>from</span> <span style=color:#000>employees</span>
<span style=color:#000>window</span> <span style=color:#000>w</span> <span style=color:#a90d91>as</span> (
  <span style=color:#000>partition</span> <span style=color:#a90d91>by</span> <span style=color:#000>department</span>
  <span style=color:#a90d91>order</span> <span style=color:#a90d91>by</span> <span style=color:#000>salary</span> <span style=color:#a90d91>desc</span>
)
<span style=color:#a90d91>order</span> <span style=color:#a90d91>by</span> <span style=color:#000>department</span>, <span style=color:#c41a16>&#34;rank&#34;</span>, <span style=color:#000>id</span>;
</code></pre></div><pre tabindex=0><code>┌──────┬───────┬────────────┬────────┐
│ rank │ name  │ department │ salary │
├──────┼───────┼────────────┼────────┤
│ 1    │ Bob   │ hr         │ 78     │
│ 2    │ Diane │ hr         │ 70     │
├──────┼───────┼────────────┼────────┤
│ 1    │ Frank │ it         │ 120    │
│ 2    │ Henry │ it         │ 104    │
│ 2    │ Irene │ it         │ 104    │
│ 3    │ Grace │ it         │ 90     │
│ 4    │ Emma  │ it         │ 84     │
├──────┼───────┼────────────┼────────┤
│ 1    │ Alice │ sales      │ 100    │
│ 2    │ Cindy │ sales      │ 96     │
│ 2    │ Dave  │ sales      │ 96     │
└──────┴───────┴────────────┴────────┘
</code></pre><p><em>I&rsquo;ve manually added the separators between departments for clarity</em></p>
<p>Here&rsquo;s an animation showing how the engine calculates the rank for each record:</p>
<div class=row>
<div class="col-xs-12 col-sm-5">
<figure>
<img src=partition.gif width=300 alt="Partitioned ranking animation">
</figure>
</div>
</div>
<div class=boxed>
<h3>✎ Exercise: Salary rating by city</h3>
<p>Practice is crucial in turning abstract knowledge into skills, making theory alone insufficient. The book, unlike this article, contains a lot of exercises; that's why I recommend <a href=https://antonz.gumroad.com/l/sql-windows>getting it</a>.</p>
<p>If you are okay with just theory for now, though — let's continue.</p>
</div>
<h2 id=salary-groups>Salary groups</h2>
<p>Let&rsquo;s divide the employees into three groups depending on the size of the salary:</p>
<ul>
<li>high-paid,</li>
<li>medium-paid,</li>
<li>low-paid.</li>
</ul>
<div class=row>
<div class="col-xs-12 col-sm-5">
before<br>
<figure><img src=before.png width=300 alt="Before tiles"></figure>
</div>
<div class="col-xs-12 col-sm-5">
after<br>
<figure><img src=ntile-after.png width=300 alt="After tiles"></figure>
</div>
</div>
<p>How do we go from &ldquo;before&rdquo; to &ldquo;after&rdquo;?</p>
<p>First, let&rsquo;s sort the table in descending order of salary:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#a90d91>select</span>
  <span style=color:#a90d91>null</span> <span style=color:#a90d91>as</span> <span style=color:#000>tile</span>,
  <span style=color:#000>name</span>, <span style=color:#000>department</span>, <span style=color:#000>salary</span>
<span style=color:#a90d91>from</span> <span style=color:#000>employees</span>
<span style=color:#a90d91>order</span> <span style=color:#a90d91>by</span> <span style=color:#000>salary</span> <span style=color:#a90d91>desc</span>, <span style=color:#000>id</span>;
</code></pre></div><pre tabindex=0><code>┌──────┬───────┬────────────┬────────┐
│ tile │ name  │ department │ salary │
├──────┼───────┼────────────┼────────┤
│      │ Frank │ it         │ 120    │
│      │ Henry │ it         │ 104    │
│      │ Irene │ it         │ 104    │
│      │ Alice │ sales      │ 100    │
│      │ Cindy │ sales      │ 96     │
│      │ Dave  │ sales      │ 96     │
│      │ Grace │ it         │ 90     │
│      │ Emma  │ it         │ 84     │
│      │ Bob   │ hr         │ 78     │
│      │ Diane │ hr         │ 70     │
└──────┴───────┴────────────┴────────┘
</code></pre><p>There are 10 records and 3 groups — which means two groups of 3 records and one of 4 records. For example:</p>
<pre tabindex=0><code>┌──────┬───────┬────────────┬────────┐
│ tile │ name  │ department │ salary │
├──────┼───────┼────────────┼────────┤
│      │ Frank │ it         │ 120    │
│      │ Henry │ it         │ 104    │
│      │ Irene │ it         │ 104    │
│      │ Alice │ sales      │ 100    │
├──────┼───────┼────────────┼────────┤
│      │ Cindy │ sales      │ 96     │
│      │ Dave  │ sales      │ 96     │
│      │ Grace │ it         │ 90     │
├──────┼───────┼────────────┼────────┤
│      │ Emma  │ it         │ 84     │
│      │ Bob   │ hr         │ 78     │
│      │ Diane │ hr         │ 70     │
└──────┴───────┴────────────┴────────┘
</code></pre><p>To draw the boundaries between the groups, we must analyze all the salaries, sorted in descending order. Therefore, the window is the same as we used for salary rating:</p>
<pre tabindex=0><code>window w as (order by salary desc)
</code></pre><p>But the function is different — <code>ntile(n)</code>, where <code>n</code> is the number of groups. In our case <code>n = 3</code>:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#a90d91>select</span>
  <span style=color:#000>ntile</span>(<span style=color:#1c01ce>3</span>) <span style=color:#000>over</span> <span style=color:#000>w</span> <span style=color:#a90d91>as</span> <span style=color:#000>tile</span>,
  <span style=color:#000>name</span>, <span style=color:#000>department</span>, <span style=color:#000>salary</span>
<span style=color:#a90d91>from</span> <span style=color:#000>employees</span>
<span style=color:#000>window</span> <span style=color:#000>w</span> <span style=color:#a90d91>as</span> (<span style=color:#a90d91>order</span> <span style=color:#a90d91>by</span> <span style=color:#000>salary</span> <span style=color:#a90d91>desc</span>)
<span style=color:#a90d91>order</span> <span style=color:#a90d91>by</span> <span style=color:#000>salary</span> <span style=color:#a90d91>desc</span>, <span style=color:#000>id</span>;
</code></pre></div><pre tabindex=0><code>┌──────┬───────┬────────────┬────────┐
│ tile │ name  │ department │ salary │
├──────┼───────┼────────────┼────────┤
│ 1    │ Frank │ it         │ 120    │
│ 1    │ Henry │ it         │ 104    │
│ 1    │ Irene │ it         │ 104    │
│ 1    │ Alice │ sales      │ 100    │
├──────┼───────┼────────────┼────────┤
│ 2    │ Cindy │ sales      │ 96     │
│ 2    │ Dave  │ sales      │ 96     │
│ 2    │ Grace │ it         │ 90     │
├──────┼───────┼────────────┼────────┤
│ 3    │ Emma  │ it         │ 84     │
│ 3    │ Bob   │ hr         │ 78     │
│ 3    │ Diane │ hr         │ 70     │
└──────┴───────┴────────────┴────────┘
</code></pre><p><em>I&rsquo;ve manually added the separators between groups for clarity</em></p>
<p><code>ntile(n)</code> splits all records into <code>n</code> groups and returns the group number for each record. If the total number of records (10 in our case) is not divisible by the group size (3), then the former groups will be larger than the latter.</p>
<p><code>ntile()</code> always tries to split the data so that the groups are of the same size. So records with the same salary value may end up in different (adjacent) groups:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#a90d91>select</span>
  <span style=color:#000>ntile</span>(<span style=color:#1c01ce>2</span>) <span style=color:#000>over</span> <span style=color:#000>w</span> <span style=color:#a90d91>as</span> <span style=color:#000>tile</span>,
  <span style=color:#000>name</span>, <span style=color:#000>department</span>, <span style=color:#000>salary</span>
<span style=color:#a90d91>from</span> <span style=color:#000>employees</span>
<span style=color:#000>window</span> <span style=color:#000>w</span> <span style=color:#a90d91>as</span> (<span style=color:#a90d91>order</span> <span style=color:#a90d91>by</span> <span style=color:#000>salary</span> <span style=color:#a90d91>desc</span>, <span style=color:#000>id</span>)
<span style=color:#a90d91>order</span> <span style=color:#a90d91>by</span> <span style=color:#000>salary</span> <span style=color:#a90d91>desc</span>, <span style=color:#000>tile</span>;
</code></pre></div><pre tabindex=0><code>┌──────┬───────┬────────────┬────────┐
│ tile │ name  │ department │ salary │
├──────┼───────┼────────────┼────────┤
│ 1    │ Frank │ it         │ 120    │
│ ...  │ ...   │ ...        │ ...    │
│ 1    │ Cindy │ sales      │ 96     │ &lt;-- (!)
├──────┼───────┼────────────┼────────┤
│ 2    │ Dave  │ sales      │ 96     │ &lt;-- (!)
│ ...  │ ...   │ ...        │ ...    │
│ 2    │ Diane │ hr         │ 70     │
└──────┴───────┴────────────┴────────┘
</code></pre><div class=boxed>
<h3>✎ Exercises: Salary groups in each of the cities (+1 more)</h3>
<p>Practice is crucial in turning abstract knowledge into skills, making theory alone insufficient. The book, unlike this article, contains a lot of exercises; that's why I recommend <a href=https://antonz.gumroad.com/l/sql-windows>getting it</a>.</p>
<p>If you are okay with just theory for now, though — let's continue.</p>
</div>
<h2 id=ranking-functions>Ranking functions</h2>
<p>Here are the ranking window functions:</p>
<table>
<thead>
<tr>
<th>Function</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>row_number()</code></td>
<td>returns the row ordinal number</td>
</tr>
<tr>
<td><code>dense_rank()</code></td>
<td>returns row rank</td>
</tr>
<tr>
<td><code>rank()</code></td>
<td>returns row rank with possible gaps (see below)</td>
</tr>
<tr>
<td><code>ntile(n)</code></td>
<td>splits all rows into <code>n</code> groups and returns the index of the group that the row belongs to</td>
</tr>
</tbody>
</table>
<p>We have already seen <code>dense_rank()</code> and <code>ntile()</code>.</p>
<p><code>row_number()</code> numbers the rows in the order specified in <code>order by</code>. No surprises here.</p>
<p><code>rank()</code> is similar to <code>dense_rank()</code>, and the difference is easier to explain with an example.</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#a90d91>select</span>
  <span style=color:#000>•••</span> <span style=color:#000>over</span> <span style=color:#000>w</span> <span style=color:#a90d91>as</span> <span style=color:#c41a16>&#34;rank&#34;</span>,
  <span style=color:#000>name</span>, <span style=color:#000>salary</span>
<span style=color:#a90d91>from</span> <span style=color:#000>employees</span>
<span style=color:#000>window</span> <span style=color:#000>w</span> <span style=color:#a90d91>as</span> (<span style=color:#a90d91>order</span> <span style=color:#a90d91>by</span> <span style=color:#000>salary</span> <span style=color:#a90d91>desc</span>)
<span style=color:#a90d91>order</span> <span style=color:#a90d91>by</span> <span style=color:#c41a16>&#34;rank&#34;</span>, <span style=color:#000>id</span>;
</code></pre></div><p>Let&rsquo;s try substituting <code>•••</code> with <code>dense_rank()</code> and <code>rank()</code>:</p>
<div class=row>
<div class="col-xs-12 col-sm-6">
dense_rank()<br>
<pre><code>┌──────┬───────┬────────┐
│ rank │ name  │ salary │
├──────┼───────┼────────┤
│ 1    │ Frank │ 120    │
│ 2    │ Henry │ 104    │
│ 2    │ Irene │ 104    │
│ 3    │ Alice │ 100    │ (!)
│ 4    │ Cindy │ 96     │
│ 4    │ Dave  │ 96     │
│ 5    │ Grace │ 90     │ (!)
│ 6    │ Emma  │ 84     │
│ 7    │ Bob   │ 78     │
│ 8    │ Diane │ 70     │
└──────┴───────┴────────┘</code></pre>
</div>
<div class="col-xs-12 col-sm-6">
rank()<br>
<pre><code>┌──────┬───────┬────────┐
│ rank │ name  │ salary │
├──────┼───────┼────────┤
│ 1    │ Frank │ 120    │
│ 2    │ Henry │ 104    │
│ 2    │ Irene │ 104    │
│ 4    │ Alice │ 100    │ (!)
│ 5    │ Cindy │ 96     │
│ 5    │ Dave  │ 96     │
│ 7    │ Grace │ 90     │ (!)
│ 8    │ Emma  │ 84     │
│ 9    │ Bob   │ 78     │
│ 10   │ Diane │ 70     │
└──────┴───────┴────────┘</code></pre>
</div>
</div>
<p><code>dense_rank()</code> assigns Alice the third place, while <code>rank()</code> assigns the fourth because Henry and Irene already occupied the second and third. It is the same with Grace after Cindy and Dave. That&rsquo;s the whole difference.</p>
<h2 id=keep-it-up>Keep it up</h2>
<p>You have learned what &ldquo;window&rdquo; and &ldquo;window functions&rdquo; are and how to use them to rank data. In the <a href=/sql-window-functions-offset>next chapter</a>, we will deal with window offsets and comparisons!</p>
<p>
<a class=button href=https://antonz.gumroad.com/l/sql-windows>
Get the book
</a>
</p>
<p><em>Follow <a href=https://twitter.com/ohmypy><strong>@ohmypy</strong></a> on Twitter to keep up with new posts</em> 🚀</p>
</div>
</div><footer class=post__footer>
<div class=row>
<div class=col-xs-12>
<div class=post__date>
<time datetime="2023-02-08 13:30:00 +0000 UTC">08 Feb, 2023</time>
</div>
<div class=post__tags>
<a href=https://antonz.org/tags/data/>data</a>&nbsp;
</div>
</div>
</div>
</footer></article>
<aside class=post__related>
<div class="post__nav article">
<div class=row>
<div class="col-xs-12 col-sm-6">
<p>&larr;&nbsp;<a href=https://antonz.org/go-1-20/>Cherry-Picked Features from Go 1.20</a></p>
</div>
<div class="col-xs-12 col-sm-6">
<p><a href=https://antonz.org/sqlite-pivot-table/>Building a Pivot Table in SQLite</a>&nbsp;&rarr;</p>
</div>
</div>
</div>
<div class=article>
<div class=row>
<div class="col-xs-12 col-sm-8 col-md-6">
<h3>See also</h3>
<p><a href=/why-use-sql-window-functions/>Why Use SQL Window Functions</a></p>
<p><a href=/sql-window-functions-book/>SQL Window Functions Explained</a></p>
<p><a href=/sqlean/>The Ultimate SQLite Extension Set</a></p>
</div>
</div>
</div>
</aside>
</div>
</div>
<footer class="container footer">
<ul class=naked-list>
<li class=footer__item>Subscribe:
<a href=https://twitter.com/ohmypy class=footer__social-link><i class="fab fa-twitter"></i><span>Twitter</span></a>
<a href=/index.xml class=footer__social-link><i class="fas fa-rss"></i><span>RSS</span></a>
</li>
<li class=footer__item>Email: <a href=mailto:m@antonz.org>m@antonz.org</a></li>
</ul>
</footer>
<script async src=//gc.zgo.at/count.js data-goatcounter=https://antonzorg.goatcounter.com/count></script></body>
</html>