<!doctype html><html lang=en>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Why Use SQL Window Functions</title>
<meta name=description content="To build great analytical reports without Excel.">
<meta name=robots content="index, follow">
<link rel=stylesheet type=text/css href=/assets/css/style.dae06b94a35dda9b879027b6992cd697b38cadbb716cfa226aabd905c0580a37.css>
<link rel=icon href=/assets/favicon/favicon.ico sizes=any>
<link rel=icon type=image/svg+xml href=/assets/favicon/favicon.svg>
<link rel=apple-touch-icon href=/assets/favicon/apple-touch-icon.png>
<link rel=manifest href=/assets/favicon/manifest.json>
<link rel=canonical href=https://antonz.org/why-use-sql-window-functions/>
<meta name=author content="Anton Zhiyanov">
<meta property="og:type" content="article">
<meta property="og:title" content="Why Use SQL Window Functions">
<meta property="og:description" content="To build great analytical reports without Excel.">
<meta property="og:url" content="https://antonz.org/why-use-sql-window-functions/">
<meta property="og:image" content="https://antonz.org/why-use-sql-window-functions/cover.jpg">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:title content="Why Use SQL Window Functions">
<meta name=twitter:description content="To build great analytical reports without Excel.">
<meta name=twitter:url content="https://antonz.org/why-use-sql-window-functions/">
<meta name=twitter:site content="@ohmypy">
<meta name=twitter:image content="https://antonz.org/why-use-sql-window-functions/cover.jpg"></head>
<body>
<div class=header>
<div class=container>
<div class=row>
<div class="col-xs-6 col-sm-3">
<a class=img-link href=/>
<img src=/assets/logo.svg class=header-icon>
</a> 
<a href=/>
<strong>Anton Zhiyanov</strong>
</a>
</div>
<div class="col-xs-12 col-sm-6 col-md-4 hidden-mobile">
<a class=menu__link href=/all/>
<span>blog</span>
</a>
<a class=menu__link href=/#about>
<span>contacts</span>
</a>
<a class=menu__link href=https://antonz.ru>
<span>ru</span>
</a>
</div>
</div>
</div>
</div>
<div class=storey>
<div class=container>
<article class=post>
<div class=row>
<div class="col-xs-12 col-sm-10 article">
<header>
<h1>Why Use SQL Window Functions</h1>
</header>
<p><em>This is an excerpt from my book <a href=/sql-window-functions-book>SQL Window Functions Explained</a>. The book is a clear and visual introduction to the topic with lots of practical exercises.</em></p>
<p>​In short, window functions assist in building great analytical reports without Excel.</p>
<p>The easiest way to explain it is through concrete examples. We will work with a toy employee table:</p>
<pre tabindex=0><code>┌────┬──────────┬────────┬────────────┬────────┐
│ id │   name   │  city  │ department │ salary │
├────┼──────────┼────────┼────────────┼────────┤
│ 11 │ Diane    │ London │ hr         │ 70     │
│ 12 │ Bob      │ London │ hr         │ 78     │
│ 21 │ Emma     │ London │ it         │ 84     │
│ 22 │ Grace    │ Berlin │ it         │ 90     │
│ 23 │ Henry    │ London │ it         │ 104    │
│ 24 │ Irene    │ Berlin │ it         │ 104    │
│ 25 │ Frank    │ Berlin │ it         │ 120    │
│ 31 │ Cindy    │ Berlin │ sales      │ 96     │
│ 32 │ Dave     │ London │ sales      │ 96     │
│ 33 │ Alice    │ Berlin │ sales      │ 100    │
└────┴──────────┴────────┴────────────┴────────┘
</code></pre><p>Let&rsquo;s look at some tasks that are convenient to solve with the help of SQL window functions. We&rsquo;ll save the technical details for the following chapters. For now, let&rsquo;s review the use cases.</p>
<h2 id=ranking>Ranking</h2>
<p>Ranking means coming up with all kinds of ratings, starting from the winners of the World Swimming Championships and ending with the Forbes 500.</p>
<p>We will rank employees.</p>
<h3 id=overall-salary-rating>Overall salary rating</h3>
<p>Let&rsquo;s make a rating of employees by salary:</p>
<div class=row>
<div class="col-xs-12 col-sm-6">
<figure>
<img src=ranking-1.png alt="Ranking example #1">
</figure>
</div>
</div>
<p>The <code>rank</code> column shows each employee&rsquo;s position in the overall rating.</p>
<p>Some colleagues have the same salary (Henry and Irene, Cindy and Dave) — so they receive the same rank.</p>
<h3 id=salary-rating-by-department>Salary rating by department</h3>
<p>Similar rating, but created for each department separately instead of the whole company:</p>
<div class=row>
<div class="col-xs-12 col-sm-6">
<figure>
<img src=ranking-2.png alt="Ranking example #2">
</figure>
</div>
</div>
<p>The <code>rank</code> column shows each employee&rsquo;s position in the department&rsquo;s rating.</p>
<h3 id=salary-groups>Salary groups</h3>
<p>Let&rsquo;s split the employees into three groups according to their salary:</p>
<ul>
<li>highly-paid,</li>
<li>medium-paid,</li>
<li>low-paid.</li>
</ul>
<div class=row>
<div class="col-xs-12 col-sm-6">
<figure>
<img src=ranking-3.png alt="Ranking example #3">
</figure>
</div>
</div>
<p>The <code>tile</code> column shows which group each employee belongs to.</p>
<h3 id=the-most-precious-colleagues>The most &ldquo;precious&rdquo; colleagues</h3>
<p>Let&rsquo;s find the highest-paid people in each department:</p>
<div class=row>
<div class="col-xs-12 col-sm-6">
<figure>
<img src=ranking-4.png alt="Ranking example #4">
</figure>
</div>
</div>
<p>No more salary raise for them, I guess.</p>
<h2 id=comparison-with-offset>Comparison with offset</h2>
<p>Comparing by offset means looking at the difference between neighboring values. For example, comparing the countries that occupy the 5th and 6th places in the world GDP rating — how different are they? What about 1st and 6th place?</p>
<p>Sometimes we compare with boundaries instead of neighbors. For example, there are 50 top tennis players worldwide, and Maria Sakkari is ranked 10th. How do her stats compare to Iga Swiatek, who is ranked 1st? How does she compare to Lin Zhou, who is ranked 50th?</p>
<p>We will compare employees.</p>
<h3 id=salary-difference-with-the-neighbor>Salary difference with the neighbor</h3>
<p>Let&rsquo;s arrange employees by salary and check whether the gap between neighbors is large:</p>
<div class=row>
<div class="col-xs-12 col-sm-6">
<figure>
<img src=offset-1.png alt="Offset example #1">
</figure>
</div>
</div>
<p>The <code>diff</code> column shows how much an employee&rsquo;s salary differs from the previous colleague&rsquo;s. As you can see, there are no significant gaps. The largest ones are Diane and Bob (11%) and Irene and Frank (15%).</p>
<h3 id=salary-range-in-the-department>Salary range in the department</h3>
<p>Let&rsquo;s see how an employee&rsquo;s salary compares to the minimum and maximum wages in his department:</p>
<div class=row>
<div class="col-xs-12 col-sm-6">
<figure>
<img src=offset-2.png alt="Offset example #2">
</figure>
</div>
</div>
<p>For each employee, the <code>low</code> column shows the minimum salary in the department, and the <code>high</code> column shows the maximum. As you can see, the HR and Sales salary ranges are narrow, but the IT range is much broader.</p>
<h2 id=aggregation>Aggregation</h2>
<p>Aggregation means counting totals or averages. For example, the average salary per city. Or the total number of gold medals for each country in the Olympic Games standings.</p>
<p>We will aggregate employee salaries.</p>
<h3 id=comparing-with-the-salary-fund>Comparing with the salary fund</h3>
<p>Each department has a salary fund — money spent monthly on paying employees' salaries. Let&rsquo;s see what percentage of this fund amounts to the salary of each employee:</p>
<div class=row>
<div class="col-xs-12 col-sm-6">
<figure>
<img src=aggregation-1.png alt="Aggregation example #1">
</figure>
</div>
</div>
<p>The <code>fund</code> column shows the department&rsquo;s salary fund, and the <code>perc</code> column shows the employee&rsquo;s salary share of this fund. As you can see, everything is more or less even in HR and Sales, but IT has a noticeable spread of salaries.</p>
<h3 id=comparing-to-the-average-salary>Comparing to the average salary</h3>
<p>I wonder how large is the spread of salaries inside departments. Let&rsquo;s calculate the deviation of each employee&rsquo;s salary from the average department salary:</p>
<div class=row>
<div class="col-xs-12 col-sm-6">
<figure>
<img src=aggregation-2.png alt="Aggregation example #2">
</figure>
</div>
</div>
<p>The result confirms the previous observation: IT salaries range from -16% to +20% of the average, while other departments are within 5%.</p>
<h2 id=rolling-aggregates>Rolling aggregates</h2>
<p>​Rolling aggregates (aka sliding or moving aggregates) are just totals — sum or average. But instead of calculating them across all elements, we use a different approach.</p>
<p>Consider the company our employees work for. Here is a table with its income and expenses for nine months of the year:</p>
<pre tabindex=0><code>┌──────┬───────┬────────┬─────────┐
│ year │ month │ income │ expense │
├──────┼───────┼────────┼─────────┤
│ 2020 │ 1     │ 94     │ 82      │
│ 2020 │ 2     │ 94     │ 75      │
│ 2020 │ 3     │ 94     │ 104     │
│ 2020 │ 4     │ 100    │ 94      │
│ 2020 │ 5     │ 100    │ 99      │
│ 2020 │ 6     │ 100    │ 105     │
│ 2020 │ 7     │ 100    │ 95      │
│ 2020 │ 8     │ 100    │ 110     │
│ 2020 │ 9     │ 104    │ 104     │
└──────┴───────┴────────┴─────────┘
</code></pre><h3 id=expenses-moving-average>Expenses moving average</h3>
<p>Judging by the data, the income is growing: 94 in January → 104 in September. But are the expenses growing as well? It&rsquo;s hard to say right away: expenses differ month by month. To smooth out these spikes, we&rsquo;ll use the &ldquo;3-month average&rdquo; — the average between the previous, current, and next month&rsquo;s expenses for each month:</p>
<ul>
<li>moving average for February = (January + February + March) / 3;</li>
<li>for March = (February + March + April) / 3;</li>
<li>for April = (March + April + May) / 3;</li>
<li>etc.</li>
</ul>
<p>Let&rsquo;s calculate the moving average for all months:</p>
<div class=row>
<div class="col-xs-12 col-sm-6">
<figure>
<img src=rolling-1.png alt="Rolling aggregates example #1">
</figure>
</div>
</div>
<p>Now it is clear that expenses are steadily growing.</p>
<h3 id=cumulative-income>Cumulative income</h3>
<p>Thanks to the moving average, we know that income and expenses are growing. But how do they relate to each other? We want to understand whether the company is &ldquo;in the black&rdquo; or &ldquo;in the red&rdquo;, considering all the money earned and spent.</p>
<p>It is essential to see the values for each month, not only for the end of the year. If at the end of the year everything is OK, but in June the company went into negative — this is a potential problem (companies call this situation a &ldquo;cash gap&rdquo;).</p>
<p>Let&rsquo;s calculate income and expenses by month as a cumulative total:</p>
<ul>
<li>cumulative income for January = January;</li>
<li>for February = January + February;</li>
<li>for March = January + February + March;</li>
<li>for April = January + February + March + April;</li>
<li>etc.</li>
</ul>
<div class=row>
<div class="col-xs-12 col-sm-8">
<figure>
<img src=rolling-2.png alt="Rolling aggregates example #2">
</figure>
</div>
</div>
<p>Now it is clear the company is doing well. In some months, expenses exceed income, but thanks to the accumulated cash reserve, there is no gap.</p>
<h2 id=summary>Summary</h2>
<p>SQL window functions help to solve the following tasks:</p>
<ul>
<li>Ranking (all kinds of ratings).</li>
<li>Comparison with offset (neighboring elements and boundaries).</li>
<li>Aggregation (sum and average).</li>
<li>Rolling aggregates (sum and average in dynamics).</li>
</ul>
<p>Of course, this is not an exhaustive list. But I hope now it is clear why window functions are beneficial for data analysis. In the <a href=/sql-window-functions-ranking>next chapter</a>, we will examine what windows are and how to use them.</p>
<p>
<a class=button href=https://antonz.gumroad.com/l/sql-windows>
Get the book
</a>
</p>
<p><em>Follow <a href=https://twitter.com/ohmypy><strong>@ohmypy</strong></a> on Twitter to keep up with new posts</em> 🚀</p>
</div>
</div><footer class=post__footer>
<div class=row>
<div class=col-xs-12>
<div class=post__date>
<time datetime="2023-01-31 08:30:00 +0000 UTC">31 Jan, 2023</time>
</div>
<div class=post__tags>
<a href=https://antonz.org/tags/data/>data</a>&nbsp;
</div>
</div>
</div>
</footer></article>
<aside class=post__related>
<div class="post__nav article">
<div class=row>
<div class="col-xs-12 col-sm-6">
<p>&larr;&nbsp;<a href=https://antonz.org/sql-window-functions-book/>SQL Window Functions Explained</a></p>
</div>
<div class="col-xs-12 col-sm-6">
<p><a href=https://antonz.org/sqlean-regexp/>Regular Expressions in SQLite</a>&nbsp;&rarr;</p>
</div>
</div>
</div>
<div class=article>
<div class=row>
<div class="col-xs-12 col-sm-8 col-md-6">
<h3>See also</h3>
<p><a href=/sql-window-functions-book/>SQL Window Functions Explained</a></p>
<p><a href=/sqlean/>The Ultimate SQLite Extension Set</a></p>
<p><a href=/sqlite-3-37/>What's new in SQLite 3.37</a></p>
</div>
</div>
</div>
</aside>
</div>
</div>
<footer class="container footer">
<ul class=naked-list>
<li class=footer__item>Subscribe:
<a href=https://twitter.com/ohmypy class=footer__social-link><i class="fab fa-twitter"></i><span>Twitter</span></a>
<a href=/index.xml class=footer__social-link><i class="fas fa-rss"></i><span>RSS</span></a>
</li>
<li class=footer__item>Email: <a href=mailto:m@antonz.org>m@antonz.org</a></li>
</ul>
</footer>
<script async src=//gc.zgo.at/count.js data-goatcounter=https://antonzorg.goatcounter.com/count></script></body>
</html>