<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/"><channel><title>Anton Zhiyanov</title><description>Everything about SQLite, Python, open data and awesome software.</description><link>https://antonz.org/</link><image><url>https://antonz.org/assets/favicon/favicon.png</url><title>Anton Zhiyanov</title><link>https://antonz.org/</link></image><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Wed, 18 May 2022 20:30:00 +0000</lastBuildDate><atom:link href="https://antonz.org/index.xml" rel="self" type="application/rss+xml"/><item><title>Temporary tables in SQLite</title><link>https://antonz.org/temp-tables/</link><pubDate>Wed, 18 May 2022 20:30:00 +0000</pubDate><guid>https://antonz.org/temp-tables/</guid><description>For faster exploratory data analysis.</description><content:encoded><![CDATA[<p>Sometimes you want to combine data from multiple tables into one and query the results. For example, join vacancies together with employers and regions:</p>
<p><img src="combine-then-query.png" alt="Combine, then query"></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#a90d91">select</span> <span style="color:#000">v</span>.<span style="color:#000">*</span>, <span style="color:#000">e</span>.<span style="color:#000">name</span>, <span style="color:#000">a</span>.<span style="color:#000">name</span>
<span style="color:#a90d91">from</span> <span style="color:#000">vacancy</span> <span style="color:#a90d91">as</span> <span style="color:#000">v</span>
  <span style="color:#a90d91">join</span> <span style="color:#000">employer</span> <span style="color:#a90d91">as</span> <span style="color:#000">e</span> <span style="color:#a90d91">on</span> <span style="color:#000">e</span>.<span style="color:#000">id</span> <span style="color:#000">=</span> <span style="color:#000">v</span>.<span style="color:#000">employer_id</span>
  <span style="color:#a90d91">join</span> <span style="color:#000">area</span> <span style="color:#a90d91">as</span> <span style="color:#000">a</span> <span style="color:#a90d91">on</span> <span style="color:#000">a</span>.<span style="color:#000">id</span> <span style="color:#000">=</span> <span style="color:#000">v</span>.<span style="color:#000">area_id</span>
</code></pre></div><p>The question is how to reference the combined dataset in further queries. There are three ways of doing that:</p>
<ol>
<li>Common Table Expressions (CTEs)</li>
<li>Views</li>
<li>Temporary tables</li>
</ol>
<p><img src="cte.png" alt="CTE"></p>
<p>A <strong>Common Table Expression</strong> is basically a named subquery:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#a90d91">with</span> <span style="color:#000">combined_cte</span> <span style="color:#a90d91">as</span> (
  <span style="color:#a90d91">select</span> <span style="color:#000">v</span>.<span style="color:#000">*</span>, <span style="color:#000">e</span>.<span style="color:#000">name</span>, <span style="color:#000">a</span>.<span style="color:#000">name</span>
  <span style="color:#a90d91">from</span> <span style="color:#000">vacancy</span> <span style="color:#a90d91">as</span> <span style="color:#000">v</span>
    <span style="color:#a90d91">join</span> <span style="color:#000">employer</span> <span style="color:#a90d91">as</span> <span style="color:#000">e</span> <span style="color:#a90d91">on</span> <span style="color:#000">e</span>.<span style="color:#000">id</span> <span style="color:#000">=</span> <span style="color:#000">v</span>.<span style="color:#000">employer_id</span>
    <span style="color:#a90d91">join</span> <span style="color:#000">area</span> <span style="color:#a90d91">as</span> <span style="color:#000">a</span> <span style="color:#a90d91">on</span> <span style="color:#000">a</span>.<span style="color:#000">id</span> <span style="color:#000">=</span> <span style="color:#000">v</span>.<span style="color:#000">area_id</span>
)
<span style="color:#a90d91">select</span> ...
<span style="color:#a90d91">from</span> <span style="color:#000">combined_cte</span>
<span style="color:#a90d91">where</span> ...
<span style="color:#a90d91">group</span> <span style="color:#a90d91">by</span> ...
<span style="color:#a90d91">order</span> <span style="color:#a90d91">by</span> ...
</code></pre></div><p>The CTE is repeated in each query and computed on the fly. So if the subquery for the combined dataset is slow, the entire query will be even slower.</p>
<p><img src="view.png" alt="View"></p>
<p>A <strong>view</strong> works like a CTE, but you can reference it by name and not repeat the subquery every time. Views are computed on the fly, similar to CTEs.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#177500">-- 1) create once
</span><span style="color:#177500"></span><span style="color:#a90d91">create</span> <span style="color:#a90d91">view</span> <span style="color:#000">combined_view</span> <span style="color:#a90d91">as</span>
<span style="color:#a90d91">select</span> <span style="color:#000">v</span>.<span style="color:#000">*</span>, <span style="color:#000">e</span>.<span style="color:#000">name</span>, <span style="color:#000">a</span>.<span style="color:#000">name</span>
<span style="color:#a90d91">from</span> <span style="color:#000">vacancy</span> <span style="color:#a90d91">as</span> <span style="color:#000">v</span>
  <span style="color:#a90d91">join</span> <span style="color:#000">employer</span> <span style="color:#a90d91">as</span> <span style="color:#000">e</span> <span style="color:#a90d91">on</span> <span style="color:#000">e</span>.<span style="color:#000">id</span> <span style="color:#000">=</span> <span style="color:#000">v</span>.<span style="color:#000">employer_id</span>
  <span style="color:#a90d91">join</span> <span style="color:#000">area</span> <span style="color:#a90d91">as</span> <span style="color:#000">a</span> <span style="color:#a90d91">on</span> <span style="color:#000">a</span>.<span style="color:#000">id</span> <span style="color:#000">=</span> <span style="color:#000">v</span>.<span style="color:#000">area_id</span>;

<span style="color:#177500">-- 2) use everywhere
</span><span style="color:#177500"></span><span style="color:#a90d91">select</span> ...
<span style="color:#a90d91">from</span> <span style="color:#000">combined_view</span>
<span style="color:#a90d91">where</span> ...
<span style="color:#a90d91">group</span> <span style="color:#a90d91">by</span> ...
<span style="color:#a90d91">order</span> <span style="color:#a90d91">by</span> ...
</code></pre></div><p>PostgreSQL and others have materialized views, which store data on disk. But not SQLite.</p>
<p><img src="temp-table.png" alt="Temporary table"></p>
<p>A <strong>temporary table</strong> is like a real table: it stores data on disk, and you can build indexes. But it exists only while the database connection is open.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#177500">-- 1) create once
</span><span style="color:#177500"></span><span style="color:#a90d91">create</span> <span style="color:#000">temp</span> <span style="color:#a90d91">table</span> <span style="color:#000">combined_temp</span> <span style="color:#a90d91">as</span>
<span style="color:#a90d91">select</span> <span style="color:#000">v</span>.<span style="color:#000">*</span>, <span style="color:#000">e</span>.<span style="color:#000">name</span>, <span style="color:#000">a</span>.<span style="color:#000">name</span>
<span style="color:#a90d91">from</span> <span style="color:#000">vacancy</span> <span style="color:#a90d91">as</span> <span style="color:#000">v</span>
  <span style="color:#a90d91">join</span> <span style="color:#000">employer</span> <span style="color:#a90d91">as</span> <span style="color:#000">e</span> <span style="color:#a90d91">on</span> <span style="color:#000">e</span>.<span style="color:#000">id</span> <span style="color:#000">=</span> <span style="color:#000">v</span>.<span style="color:#000">employer_id</span>
  <span style="color:#a90d91">join</span> <span style="color:#000">area</span> <span style="color:#a90d91">as</span> <span style="color:#000">a</span> <span style="color:#a90d91">on</span> <span style="color:#000">a</span>.<span style="color:#000">id</span> <span style="color:#000">=</span> <span style="color:#000">v</span>.<span style="color:#000">area_id</span>;

<span style="color:#177500">-- 2) use everywhere
</span><span style="color:#177500"></span><span style="color:#a90d91">select</span> ...
<span style="color:#a90d91">from</span> <span style="color:#000">combined_temp</span>
<span style="color:#a90d91">where</span> ...
<span style="color:#a90d91">group</span> <span style="color:#a90d91">by</span> ...
<span style="color:#a90d91">order</span> <span style="color:#a90d91">by</span> ...
</code></pre></div><p>Technically, SQLite stores temporary tables in a separate <code>temp</code> database. It keeps that database in a separate file on disk, visible only to the current database connection. The temporary database is deleted automatically as soon as the connection is closed.</p>
<div class="boxed">
<p><strong>Temporary database location</strong></p>
<p>On unix-like systems, the directory for storing the temp database can be one of the following:</p>
<ol>
<li>The directory set by <code>PRAGMA temp_store_directory</code> (deprecated)</li>
<li>The <code>SQLITE_TMPDIR</code> environment variable</li>
<li>The <code>TMPDIR</code> environment variable</li>
<li><code>/var/tmp</code></li>
<li><code>/usr/tmp</code></li>
<li><code>/tmp</code></li>
<li>The current working directory (<code>.</code>)</li>
</ol>
<p>SQLite picks the first one with both write and execute permissions.</p>
<p>To store the temp database in memory, set <code>PRAGMA temp_store = MEMORY</code>.</p>
<p><a href="https://sqlite.org/tempfiles.html">documentation</a></p>
</div>
<p>Temporary tables are great for experimenting when you&rsquo;re just getting to know the data. Do whatever you want — everything will be forgotten after disconnecting from the database ツ</p>
]]></content:encoded></item><item><title>JSON and virtual columns in SQLite</title><link>https://antonz.org/json-virtual-columns/</link><pubDate>Sun, 15 May 2022 11:25:00 +0000</pubDate><guid>https://antonz.org/json-virtual-columns/</guid><description>Faster JSON handling in a relational database.</description><content:encoded><![CDATA[<p><a href="/generated-columns/">Generated columns</a> have another great use case.</p>
<p><img src="json-data.png" alt="JSON data"></p>
<p>Let&rsquo;s say you decide to keep a log of events that occur in the system. There are different types of events, each with its own set of fields. For example, sign-in:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
    <span style="color:#000">&#34;timestamp&#34;</span>: <span style="color:#c41a16">&#34;2022-05-15T09:31:00Z&#34;</span>,
    <span style="color:#000">&#34;object&#34;</span>: <span style="color:#c41a16">&#34;user&#34;</span>,
    <span style="color:#000">&#34;object_id&#34;</span>: <span style="color:#1c01ce">11</span>,
    <span style="color:#000">&#34;action&#34;</span>: <span style="color:#c41a16">&#34;login&#34;</span>,
    <span style="color:#000">&#34;details&#34;</span>: {
        <span style="color:#000">&#34;ip&#34;</span>: <span style="color:#c41a16">&#34;192.168.0.1&#34;</span>
    }
}
</code></pre></div><p>Or account deposit:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
    <span style="color:#000">&#34;timestamp&#34;</span>: <span style="color:#c41a16">&#34;2022-05-15T09:32:00Z&#34;</span>,
    <span style="color:#000">&#34;object&#34;</span>: <span style="color:#c41a16">&#34;account&#34;</span>,
    <span style="color:#000">&#34;object_id&#34;</span>: <span style="color:#1c01ce">12</span>,
    <span style="color:#000">&#34;action&#34;</span>: <span style="color:#c41a16">&#34;deposit&#34;</span>,
    <span style="color:#000">&#34;details&#34;</span>: {
        <span style="color:#000">&#34;amount&#34;</span>: <span style="color:#c41a16">&#34;1000&#34;</span>,
        <span style="color:#000">&#34;currency&#34;</span>: <span style="color:#c41a16">&#34;USD&#34;</span>
    }
}
</code></pre></div><p><img src="json-functions.png" alt="JSON functions"></p>
<p>You decide to store the raw JSON, as normalization is non-trivial. You create an <code>events</code> table with a single <code>value</code> field:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#a90d91">select</span> <span style="color:#000">value</span> <span style="color:#a90d91">from</span> <span style="color:#000">events</span>;
</code></pre></div><pre tabindex="0"><code>{&quot;timestamp&quot;:&quot;2022-05-15T09:31:00Z&quot;,&quot;object&quot;:&quot;user&quot;,&quot;object_id&quot;:11,&quot;action&quot;:&quot;login&quot;,&quot;details&quot;:{&quot;ip&quot;:&quot;192.168.0.1&quot;}}
{&quot;timestamp&quot;:&quot;2022-05-15T09:32:00Z&quot;,&quot;object&quot;:&quot;account&quot;,&quot;object_id&quot;:12,&quot;action&quot;:&quot;deposit&quot;,&quot;details&quot;:{&quot;amount&quot;:&quot;1000&quot;,&quot;currency&quot;:&quot;USD&quot;}}
{&quot;timestamp&quot;:&quot;2022-05-15T09:33:00Z&quot;,&quot;object&quot;:&quot;company&quot;,&quot;object_id&quot;:13,&quot;action&quot;:&quot;edit&quot;,&quot;details&quot;:{&quot;fields&quot;:[&quot;address&quot;,&quot;phone&quot;]}}
</code></pre><p>And select events for a specific object:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#a90d91">select</span>
  <span style="color:#000">json_extract</span>(<span style="color:#000">value</span>, <span style="color:#c41a16">&#39;$.object&#39;</span>) <span style="color:#a90d91">as</span> <span style="color:#a90d91">object</span>,
  <span style="color:#000">json_extract</span>(<span style="color:#000">value</span>, <span style="color:#c41a16">&#39;$.action&#39;</span>) <span style="color:#a90d91">as</span> <span style="color:#000">action</span>
<span style="color:#a90d91">from</span> <span style="color:#000">events</span>
<span style="color:#a90d91">where</span> <span style="color:#000">json_extract</span>(<span style="color:#000">value</span>, <span style="color:#c41a16">&#39;$.object_id&#39;</span>) <span style="color:#000">=</span> <span style="color:#1c01ce">11</span>;
</code></pre></div><pre tabindex="0"><code>┌────────┬────────┐
│ object │ action │
├────────┼────────┤
│ user   │ login  │
└────────┴────────┘
</code></pre><p>So far, so good. But <code>json_extract()</code> parses the text on each call, so for hundreds of thousands of records the query is slow. What should you do?</p>
<p><img src="json-columns.png" alt="JSON columns"></p>
<p>Define virtual columns:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#a90d91">alter</span> <span style="color:#a90d91">table</span> <span style="color:#000">events</span>
<span style="color:#a90d91">add</span> <span style="color:#a90d91">column</span> <span style="color:#000">object_id</span> <span style="color:#a90d91">integer</span>
<span style="color:#a90d91">as</span> (<span style="color:#000">json_extract</span>(<span style="color:#000">value</span>, <span style="color:#c41a16">&#39;$.object_id&#39;</span>));

<span style="color:#a90d91">alter</span> <span style="color:#a90d91">table</span> <span style="color:#000">events</span>
<span style="color:#a90d91">add</span> <span style="color:#a90d91">column</span> <span style="color:#a90d91">object</span> <span style="color:#a90d91">text</span>
<span style="color:#a90d91">as</span> (<span style="color:#000">json_extract</span>(<span style="color:#000">value</span>, <span style="color:#c41a16">&#39;$.object&#39;</span>));

<span style="color:#a90d91">alter</span> <span style="color:#a90d91">table</span> <span style="color:#000">events</span>
<span style="color:#a90d91">add</span> <span style="color:#a90d91">column</span> <span style="color:#000">action</span> <span style="color:#a90d91">text</span>
<span style="color:#a90d91">as</span> (<span style="color:#000">json_extract</span>(<span style="color:#000">value</span>, <span style="color:#c41a16">&#39;$.action&#39;</span>));
</code></pre></div><p>Build an index:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#a90d91">create</span> <span style="color:#a90d91">index</span> <span style="color:#000">events_object_id</span> <span style="color:#a90d91">on</span> <span style="color:#000">events</span>(<span style="color:#000">object_id</span>);
</code></pre></div><p>Now the query works instantly:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#a90d91">select</span> <span style="color:#a90d91">object</span>, <span style="color:#000">action</span>
<span style="color:#a90d91">from</span> <span style="color:#000">events</span>
<span style="color:#a90d91">where</span> <span style="color:#000">object_id</span> <span style="color:#000">=</span> <span style="color:#1c01ce">11</span>;
</code></pre></div><p>Thanks to virtual columns, we almost have a NoSQL database ツ</p>
<p><a href="https://sqlime.org/#gist:c284f7c22684eb74b5dab92d98f7d773">Playground</a></p>
]]></content:encoded></item><item><title>Compact objects in Python</title><link>https://antonz.org/compact-objects/</link><pubDate>Fri, 13 May 2022 20:25:00 +0000</pubDate><guid>https://antonz.org/compact-objects/</guid><description>Tuple vs dataclass, until numpy interferes</description><content:encoded><![CDATA[<p>Python is an object language. This is nice and cozy until you are out of memory holding 10 million objects at once. Let&rsquo;s talk about how to reduce appetite.</p>
<p><em>Visit the <a href="https://colab.research.google.com/drive/1oKl4rda2apWORLxYYtN9J49r3Mj3L6J9?usp=sharing">Playground</a> to try out the code samples</em></p>
<h2 id="tuples">Tuples</h2>
<p>Imagine you have a simple <code>Pet</code> object with the <code>name</code> (string) and <code>price</code> (integer) attributes. Intuitively, it seems that the most compact representation is a tuple:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">(<span style="color:#c41a16">&#34;Frank the Pigeon&#34;</span>, <span style="color:#1c01ce">50000</span>)
</code></pre></div><p>Let&rsquo;s measure how much memory this beauty eats:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">import</span> <span style="color:#000">random</span>
<span style="color:#a90d91">from</span> <span style="color:#000">pympler.asizeof</span> <span style="color:#a90d91">import</span> <span style="color:#000">asizeof</span>

<span style="color:#a90d91">def</span> <span style="color:#000">fields</span>():
    <span style="color:#000">name_gen</span> <span style="color:#000">=</span> (<span style="color:#000">random</span><span style="color:#000">.</span><span style="color:#000">choice</span>(<span style="color:#000">string</span><span style="color:#000">.</span><span style="color:#000">ascii_uppercase</span>) <span style="color:#a90d91">for</span> <span style="color:#000">_</span> <span style="color:#000">in</span> <span style="color:#a90d91">range</span>(<span style="color:#1c01ce">10</span>))
    <span style="color:#000">name</span> <span style="color:#000">=</span> <span style="color:#c41a16">&#34;&#34;</span><span style="color:#000">.</span><span style="color:#000">join</span>(<span style="color:#000">name_gen</span>)
    <span style="color:#000">price</span> <span style="color:#000">=</span> <span style="color:#000">random</span><span style="color:#000">.</span><span style="color:#000">randint</span>(<span style="color:#1c01ce">10000</span>, <span style="color:#1c01ce">99999</span>)
    <span style="color:#a90d91">return</span> (<span style="color:#000">name</span>, <span style="color:#000">price</span>)

<span style="color:#a90d91">def</span> <span style="color:#000">measure</span>(<span style="color:#000">name</span>, <span style="color:#000">fn</span>, <span style="color:#000">n</span><span style="color:#000">=</span><span style="color:#1c01ce">10_000</span>):
    <span style="color:#000">pets</span> <span style="color:#000">=</span> [<span style="color:#000">fn</span>() <span style="color:#a90d91">for</span> <span style="color:#000">_</span> <span style="color:#000">in</span> <span style="color:#a90d91">range</span>(<span style="color:#000">n</span>)]
    <span style="color:#000">size</span> <span style="color:#000">=</span> <span style="color:#a90d91">round</span>(<span style="color:#000">asizeof</span>(<span style="color:#000">pets</span>) <span style="color:#000">/</span> <span style="color:#000">n</span>)
    <span style="color:#a90d91">print</span>(<span style="color:#c41a16">f</span><span style="color:#c41a16">&#34;Pet size (</span><span style="color:#c41a16">{</span><span style="color:#000">name</span><span style="color:#c41a16">}</span><span style="color:#c41a16">) = </span><span style="color:#c41a16">{</span><span style="color:#000">size</span><span style="color:#c41a16">}</span><span style="color:#c41a16"> bytes&#34;</span>)
    <span style="color:#a90d91">return</span> <span style="color:#000">size</span>

<span style="color:#000">baseline</span> <span style="color:#000">=</span> <span style="color:#000">measure</span>(<span style="color:#c41a16">&#34;tuple&#34;</span>, <span style="color:#000">fields</span>)
</code></pre></div><pre tabindex="0"><code>Pet size (tuple) = 161 bytes
</code></pre><p>161 bytes. Let&rsquo;s use it as a baseline for further comparison.</p>
<h2 id="dataclasses-vs-named-tuples">Dataclasses vs named tuples</h2>
<p>But who works with tuples these days? You would probably choose a dataclass:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">from</span> <span style="color:#000">dataclasses</span> <span style="color:#a90d91">import</span> <span style="color:#000">dataclass</span>

<span style="color:#000">@dataclass</span>
<span style="color:#a90d91">class</span> <span style="color:#3f6e75">PetData</span>:
    <span style="color:#000">name</span>: <span style="color:#a90d91">str</span>
    <span style="color:#000">price</span>: <span style="color:#a90d91">int</span>

<span style="color:#000">fn</span> <span style="color:#000">=</span> <span style="color:#a90d91">lambda</span>: <span style="color:#000">PetData</span>(<span style="color:#000">*</span><span style="color:#000">fields</span>())
<span style="color:#000">measure</span>(<span style="color:#c41a16">&#34;dataclass&#34;</span>, <span style="color:#000">fn</span>)
</code></pre></div><pre tabindex="0"><code>Pet size (dataclass) = 257 bytes
x1.60 to baseline
</code></pre><p>Thing is, it&rsquo;s 1.6 times larger than a tuple.</p>
<p>Let&rsquo;s try a named tuple then:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">from</span> <span style="color:#000">typing</span> <span style="color:#a90d91">import</span> <span style="color:#000">NamedTuple</span>

<span style="color:#a90d91">class</span> <span style="color:#3f6e75">PetTuple</span>(<span style="color:#000">NamedTuple</span>):
    <span style="color:#000">name</span>: <span style="color:#a90d91">str</span>
    <span style="color:#000">price</span>: <span style="color:#a90d91">int</span>


<span style="color:#000">fn</span> <span style="color:#000">=</span> <span style="color:#a90d91">lambda</span>: <span style="color:#000">PetTuple</span>(<span style="color:#000">*</span><span style="color:#000">fields</span>())
<span style="color:#000">measure</span>(<span style="color:#c41a16">&#34;named tuple&#34;</span>, <span style="color:#000">fn</span>)
</code></pre></div><pre tabindex="0"><code>Pet size (named tuple) = 161 bytes
x1.00 to baseline
</code></pre><p>Looks like a dataclass, works like a tuple. Perfect. Or not?</p>
<h2 id="slots">Slots</h2>
<p>Python 3.10 received dataclasses with slots:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">@dataclass</span>(<span style="color:#000">slots</span><span style="color:#000">=</span><span style="color:#a90d91">True</span>)
<span style="color:#a90d91">class</span> <span style="color:#3f6e75">PetData</span>:
    <span style="color:#000">name</span>: <span style="color:#a90d91">str</span>
    <span style="color:#000">price</span>: <span style="color:#a90d91">int</span>


<span style="color:#000">fn</span> <span style="color:#000">=</span> <span style="color:#a90d91">lambda</span>: <span style="color:#000">PetData</span>(<span style="color:#000">*</span><span style="color:#000">fields</span>())
<span style="color:#000">measure</span>(<span style="color:#c41a16">&#34;dataclass w/slots&#34;</span>, <span style="color:#000">fn</span>)
</code></pre></div><pre tabindex="0"><code>Pet size (dataclass w/slots) = 153 bytes
x0.95 to baseline
</code></pre><p>Wow! Slots magic creates special skinny objects without an underlying dictionary, unlike regular Python objects. Such dataclass is even lighter than a tuple.</p>
<p>What if 3.10 is out of the question yet? Use <code>NamedTuple</code>. Or add a slots dunder manually:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">@dataclass</span>
<span style="color:#a90d91">class</span> <span style="color:#3f6e75">PetData</span>:
    <span style="color:#000">__slots__</span> <span style="color:#000">=</span> (<span style="color:#c41a16">&#34;name&#34;</span>, <span style="color:#c41a16">&#34;price&#34;</span>)
    <span style="color:#000">name</span>: <span style="color:#a90d91">str</span>
    <span style="color:#000">price</span>: <span style="color:#a90d91">int</span>
</code></pre></div><p>Slot objects have their own shortcomings. But they are great for simple cases (without inheritance and other complex stuff).</p>
<h2 id="numpy-arrays">numpy arrays</h2>
<p>The real winner, of course, is the <code>numpy</code> array:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">import</span> <span style="color:#000">string</span>
<span style="color:#a90d91">import</span> <span style="color:#000">numpy</span> <span style="color:#a90d91">as</span> <span style="color:#000">np</span>

<span style="color:#000">PetNumpy</span> <span style="color:#000">=</span> <span style="color:#000">np</span><span style="color:#000">.</span><span style="color:#000">dtype</span>([(<span style="color:#c41a16">&#34;name&#34;</span>, <span style="color:#c41a16">&#34;S10&#34;</span>), (<span style="color:#c41a16">&#34;price&#34;</span>, <span style="color:#c41a16">&#34;i4&#34;</span>)])
<span style="color:#000">generator</span> <span style="color:#000">=</span> (<span style="color:#000">fields</span>() <span style="color:#a90d91">for</span> <span style="color:#000">_</span> <span style="color:#000">in</span> <span style="color:#a90d91">range</span>(<span style="color:#000">n</span>))
<span style="color:#000">pets</span> <span style="color:#000">=</span> <span style="color:#000">np</span><span style="color:#000">.</span><span style="color:#000">fromiter</span>(<span style="color:#000">generator</span>, <span style="color:#000">dtype</span><span style="color:#000">=</span><span style="color:#000">PetNumpy</span>)
<span style="color:#000">size</span> <span style="color:#000">=</span> <span style="color:#a90d91">round</span>(<span style="color:#000">asizeof</span>(<span style="color:#000">pets</span>) <span style="color:#000">/</span> <span style="color:#000">n</span>)
</code></pre></div><pre tabindex="0"><code>Pet size (numpy array) = 14 bytes
x0.09 to baseline
</code></pre><p>But there are nuances with <code>numpy</code> as well. If names are unicode (<code>U</code> type instead of <code>S</code>), the advantage is not so impressive:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">PetNumpy</span> <span style="color:#000">=</span> <span style="color:#000">np</span><span style="color:#000">.</span><span style="color:#000">dtype</span>([(<span style="color:#c41a16">&#34;name&#34;</span>, <span style="color:#c41a16">&#34;U10&#34;</span>), (<span style="color:#c41a16">&#34;price&#34;</span>, <span style="color:#c41a16">&#34;i4&#34;</span>)])
</code></pre></div><pre tabindex="0"><code>Pet size (numpy U10) = 44 bytes
x0.27 to baseline
</code></pre><p>If the name length is not strictly 10 characters, but varies, say, up to 50 characters (<code>U50</code> instead of <code>U10</code>) — the advantage disappears completely:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">def</span> <span style="color:#000">fields</span>():
    <span style="color:#000">name_len</span> <span style="color:#000">=</span> <span style="color:#000">random</span><span style="color:#000">.</span><span style="color:#000">randint</span>(<span style="color:#1c01ce">10</span>, <span style="color:#1c01ce">50</span>)
    <span style="color:#000">name_gen</span> <span style="color:#000">=</span> (<span style="color:#000">random</span><span style="color:#000">.</span><span style="color:#000">choice</span>(<span style="color:#000">string</span><span style="color:#000">.</span><span style="color:#000">ascii_uppercase</span>) <span style="color:#a90d91">for</span> <span style="color:#000">_</span> <span style="color:#000">in</span> <span style="color:#a90d91">range</span>(<span style="color:#000">name_len</span>))
    <span style="color:#177500"># ...</span>

<span style="color:#000">PetNumpy</span> <span style="color:#000">=</span> <span style="color:#000">np</span><span style="color:#000">.</span><span style="color:#000">dtype</span>([(<span style="color:#c41a16">&#34;name&#34;</span>, <span style="color:#c41a16">&#34;U50&#34;</span>), (<span style="color:#c41a16">&#34;price&#34;</span>, <span style="color:#c41a16">&#34;i4&#34;</span>)])
</code></pre></div><pre tabindex="0"><code>Pet size (tuple) = 179 bytes

Pet size (numpy U50) = 204 bytes
x1.14 to baseline
</code></pre><h2 id="others">Others</h2>
<p>Let&rsquo;s consider alternatives for completeness.</p>
<p>A regular class is no different than a dataclass:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">class</span> <span style="color:#3f6e75">PetClass</span>:
    <span style="color:#a90d91">def</span> <span style="color:#000">__init__</span>(<span style="color:#5b269a">self</span>, <span style="color:#000">name</span>: <span style="color:#a90d91">str</span>, <span style="color:#000">price</span>: <span style="color:#a90d91">int</span>):
        <span style="color:#5b269a">self</span><span style="color:#000">.</span><span style="color:#000">name</span> <span style="color:#000">=</span> <span style="color:#000">name</span>
        <span style="color:#5b269a">self</span><span style="color:#000">.</span><span style="color:#000">price</span> <span style="color:#000">=</span> <span style="color:#000">price</span>
</code></pre></div><pre tabindex="0"><code>Pet size (class) = 257 bytes
x1.60 to baseline
</code></pre><p>And a frozen (immutable) dataclass too:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">@dataclass</span>(<span style="color:#000">frozen</span><span style="color:#000">=</span><span style="color:#a90d91">True</span>)
<span style="color:#a90d91">class</span> <span style="color:#3f6e75">PetDataFrozen</span>:
    <span style="color:#000">name</span>: <span style="color:#a90d91">str</span>
    <span style="color:#000">price</span>: <span style="color:#a90d91">int</span>
</code></pre></div><pre tabindex="0"><code>Pet size (frozen dataclass) = 257 bytes
x1.60 to baseline
</code></pre><p>Pydantic model sets an anti-record (no wonder, it uses inheritance):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">from</span> <span style="color:#000">pydantic</span> <span style="color:#a90d91">import</span> <span style="color:#000">BaseModel</span>

<span style="color:#a90d91">class</span> <span style="color:#3f6e75">PetModel</span>(<span style="color:#000">BaseModel</span>):
    <span style="color:#000">name</span>: <span style="color:#a90d91">str</span>
    <span style="color:#000">price</span>: <span style="color:#a90d91">int</span>
</code></pre></div><pre tabindex="0"><code>Pet size (pydantic) = 385 bytes
x2.39 to baseline
</code></pre><p class="align-center">⌘&nbsp;⌘&nbsp;⌘</p>
<p>Compact (and not so compact) objects in Python:</p>
<div class="row">
<div class="col-xs-12 col-sm-4">
<figure><img alt="Tuple" src="tuple.png"></figure>
</div>
<div class="col-xs-12 col-sm-4">
<figure><img alt="Dataclass" src="dataclass.png"></figure>
</div>
<div class="col-xs-12 col-sm-4">
<figure><img alt="Named tuple" src="named-tuple.png"></figure>
</div>
</div>
<div class="row">
<div class="col-xs-12 col-sm-4">
<figure><img alt="Dataclass with slots" src="dataclass-slots.png"></figure>
</div>
<div class="col-xs-12 col-sm-4">
<figure><img alt="Manual slots" src="manual-slots.png"></figure>
</div>
<div class="col-xs-12 col-sm-4">
<figure><img alt="numpy array" src="np-array.png"></figure>
</div>
</div>
]]></content:encoded></item><item><title>Python Standard Library changes in recent years</title><link>https://antonz.org/python-stdlib-changes/</link><pubDate>Wed, 11 May 2022 12:40:00 +0000</pubDate><guid>https://antonz.org/python-stdlib-changes/</guid><description>17 modules with new and improved features.</description><content:encoded><![CDATA[<p>With each major Python release, all the attention goes to the new language features: the walrus operator, dictionary merging, pattern matching. There is also a lot of writing about <code>asyncio</code> and <code>typing</code> modules — they are developing rapidly and are obviously important for the core team.</p>
<p>The rest of the standard library modules receive undeservedly little attention. I want to fix this and tell you about the novelties introduced in versions 3.8–3.10.</p>
<blockquote>
<p>This is not an exhaustive list, of course. I write only about those changes that interested me personally. But since I am not too much different from the &ldquo;average&rdquo; Python backend developer, it is likely that you will also be interested. Let me know if I missed something.</p>
</blockquote>
<p>The modules are in alphabetical order, so if you get bored with the first (little-known) ones, do not be discouraged — it gets more exciting further.</p>
<p><a href="#array">array</a> • <a href="#base64">base64</a> • <a href="#bisect">bisect</a> • <a href="#builtins">builtins</a> • <a href="#dataclasses">dataclasses</a> • <a href="#datetime">datetime</a> • <a href="#fractions">fractions</a> • <a href="#functools">functools</a> • <a href="#glob">glob</a> • <a href="#graphlib">graphlib</a> • <a href="#itertools">itertools</a> • <a href="#math">math</a> • <a href="#random">random</a> • <a href="#shlex">shlex</a> • <a href="#shutil">shutil</a> • <a href="#statistics">statistics</a> • <a href="#zoneinfo">zoneinfo</a></p>
<p>All new features and improvements in the article are accompanied by examples. You can try them in the playground or run locally. If you have an older local Python, run it using Docker:</p>
<pre tabindex="0"><code>$ docker run -it --rm python:3.10-alpine
</code></pre><h2 id="array">array</h2>
<p><a href="https://docs.python.org/3/library/array"><code>array</code></a> module provides compact typed numeric arrays. It is used much less frequently than the famous <code>list</code> counterpart.</p>
<p><a href="https://docs.python.org/3/library/array#array.array.index"><code>array.index()</code></a> methods finds the value in the array and returns the index of the found element. Now it supports optional <code>start</code> and <code>stop</code> parameters, which define the search interval (3.10+):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">from</span> <span style="color:#000">array</span> <span style="color:#a90d91">import</span> <span style="color:#000">array</span>
<span style="color:#000">arr</span> <span style="color:#000">=</span> <span style="color:#000">array</span>(<span style="color:#c41a16">&#34;i&#34;</span>, [<span style="color:#1c01ce">7</span>, <span style="color:#1c01ce">11</span>, <span style="color:#1c01ce">19</span>, <span style="color:#1c01ce">42</span>])

<span style="color:#000">idx</span> <span style="color:#000">=</span> <span style="color:#000">arr</span><span style="color:#000">.</span><span style="color:#000">index</span>(<span style="color:#1c01ce">11</span>)
<span style="color:#177500"># idx == 1</span>

<span style="color:#000">idx</span> <span style="color:#000">=</span> <span style="color:#000">arr</span><span style="color:#000">.</span><span style="color:#000">index</span>(<span style="color:#1c01ce">11</span>, <span style="color:#1c01ce">2</span>)
<span style="color:#177500"># ValueError: array.index(x): x not in array</span>
</code></pre></div><p><a href="https://stepik.org/lesson/717024/step/2">playground</a></p>
<p>Contributed by: <a href="https://github.com/Phaqui">Anders Lorentsen</a> • <a href="https://github.com/ZackerySpytz">Zackery Spytz</a></p>
<h2 id="base64">base64</h2>
<p><a href="https://docs.python.org/3/library/base64"><code>base64</code></a> module encodes binary data into ASCII strings using Base16, Base32, and Base64 algorithms.</p>
<p>It received a couple of new functions: <a href="https://docs.python.org/3/library/base64#base64.b32hexencode"><code>b32hexencode()</code></a> and <a href="https://docs.python.org/3/library/base64#base64.b32hexdecode"><code>b32hexdecode()</code></a>, which use an extended 32-character alphabet according to <a href="https://datatracker.ietf.org/doc/html/rfc4648.html#section-7">RFC 4648</a> (3.10+):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">import</span> <span style="color:#000">base64</span>
<span style="color:#a90d91">bytes</span> <span style="color:#000">=</span> <span style="color:#c41a16">b</span><span style="color:#c41a16">&#34;python is awesome&#34;</span>

<span style="color:#000">base64</span><span style="color:#000">.</span><span style="color:#000">b32encode</span>(<span style="color:#a90d91">bytes</span>)
<span style="color:#177500"># b&#39;OB4XI2DPNYQGS4ZAMF3WK43PNVSQ====&#39;</span>

<span style="color:#000">base64</span><span style="color:#000">.</span><span style="color:#000">b32hexencode</span>(<span style="color:#a90d91">bytes</span>)
<span style="color:#177500"># b&#39;E1SN8Q3FDOG6ISP0C5RMASRFDLIG====&#39;</span>
</code></pre></div><p><a href="https://stepik.org/lesson/717024/step/3">playground</a></p>
<p>Contributed by: <a href="https://github.com/FFY00">Filipe Laíns</a></p>
<h2 id="bisect">bisect</h2>
<p><a href="https://docs.python.org/3/library/bisect"><code>bisect</code></a> module works with sorted lists using binary search method. Main functions are:</p>
<ul>
<li><a href="https://docs.python.org/3/library/bisect#bisect.bisect"><code>bisect()</code></a> finds an item in the list;</li>
<li><a href="https://docs.python.org/3/library/bisect#bisect.insort"><code>insort()</code></a> adds an item while retaining the order.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">import</span> <span style="color:#000">bisect</span>

<span style="color:#000">lst</span> <span style="color:#000">=</span> [<span style="color:#1c01ce">7</span>, <span style="color:#1c01ce">11</span>, <span style="color:#1c01ce">19</span>, <span style="color:#1c01ce">42</span>]
<span style="color:#000">idx</span> <span style="color:#000">=</span> <span style="color:#000">bisect</span><span style="color:#000">.</span><span style="color:#000">bisect</span>(<span style="color:#000">lst</span>, <span style="color:#1c01ce">12</span>)
<span style="color:#177500"># idx == 2</span>

<span style="color:#000">bisect</span><span style="color:#000">.</span><span style="color:#000">insort</span>(<span style="color:#000">lst</span>, <span style="color:#1c01ce">12</span>)
<span style="color:#177500"># [7, 11, 12, 19, 42]</span>
</code></pre></div><p>Since version 3.10, all module functions support the optional <code>key</code> parameter. It is a function that returns the value of a list item. It is convenient to use if the elements cannot be compared directly:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">import</span> <span style="color:#000">bisect</span>
<span style="color:#a90d91">import</span> <span style="color:#000">operator</span>

<span style="color:#000">p1</span> <span style="color:#000">=</span> {<span style="color:#c41a16">&#34;id&#34;</span>: <span style="color:#1c01ce">11</span>, <span style="color:#c41a16">&#34;name&#34;</span>: <span style="color:#c41a16">&#34;Diane&#34;</span>}
<span style="color:#000">p2</span> <span style="color:#000">=</span> {<span style="color:#c41a16">&#34;id&#34;</span>: <span style="color:#1c01ce">12</span>, <span style="color:#c41a16">&#34;name&#34;</span>: <span style="color:#c41a16">&#34;Bob&#34;</span>}
<span style="color:#000">p3</span> <span style="color:#000">=</span> {<span style="color:#c41a16">&#34;id&#34;</span>: <span style="color:#1c01ce">13</span>, <span style="color:#c41a16">&#34;name&#34;</span>: <span style="color:#c41a16">&#34;Emma&#34;</span>}

<span style="color:#000">key</span> <span style="color:#000">=</span> <span style="color:#000">operator</span><span style="color:#000">.</span><span style="color:#000">itemgetter</span>(<span style="color:#c41a16">&#34;name&#34;</span>)
<span style="color:#000">people</span> <span style="color:#000">=</span> <span style="color:#a90d91">sorted</span>([<span style="color:#000">p1</span>, <span style="color:#000">p2</span>, <span style="color:#000">p3</span>], <span style="color:#000">key</span><span style="color:#000">=</span><span style="color:#000">key</span>)
<span style="color:#177500"># Bob, Diane, Emma</span>

<span style="color:#000">idx</span> <span style="color:#000">=</span> <span style="color:#000">bisect</span><span style="color:#000">.</span><span style="color:#000">bisect</span>(<span style="color:#000">people</span>, <span style="color:#c41a16">&#34;Dan&#34;</span>)
<span style="color:#177500"># TypeError: &#39;&lt;&#39; not supported between instances of &#39;str&#39; and &#39;dict&#39;</span>

<span style="color:#000">idx</span> <span style="color:#000">=</span> <span style="color:#000">bisect</span><span style="color:#000">.</span><span style="color:#000">bisect</span>(<span style="color:#000">people</span>, <span style="color:#c41a16">&#34;Dan&#34;</span>, <span style="color:#000">key</span><span style="color:#000">=</span><span style="color:#000">key</span>)
<span style="color:#177500"># idx == 1</span>
</code></pre></div><p><a href="https://stepik.org/lesson/717024/step/4">playground</a></p>
<p>Contributed by: <a href="https://github.com/rhettinger">Raymond Hettinger</a></p>
<h2 id="builtins">builtins</h2>
<p><a href="https://docs.python.org/3/library/builtins"><code>builtins</code></a> module contains all the built-in functions and classes that programmers use without imports: <code>int</code>, <code>list</code>, <code>len()</code>, <code>open()</code> and the like.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">import</span> <span style="color:#000">builtins</span>

<span style="color:#a90d91">list</span> <span style="color:#000">is</span> <span style="color:#000">builtins</span><span style="color:#000">.</span><span style="color:#000">list</span>
<span style="color:#177500"># True</span>

<span style="color:#a90d91">len</span> <span style="color:#000">is</span> <span style="color:#000">builtins</span><span style="color:#000">.</span><span style="color:#000">len</span>
<span style="color:#177500"># True</span>
</code></pre></div><p>The <strong>string</strong> received <a href="https://docs.python.org/3/library/stdtypes#str.removeprefix"><code>str.removeprefix()</code></a> and <a href="https://docs.python.org/3/library/stdtypes#str.removesuffix"><code>str.removesuffix()</code></a> methods, which cut off the string head and tail respectively (3.9+):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">s</span> <span style="color:#000">=</span> <span style="color:#c41a16">&#34;Python is awesome&#34;</span>

<span style="color:#000">s</span><span style="color:#000">.</span><span style="color:#000">removeprefix</span>(<span style="color:#c41a16">&#34;Python is &#34;</span>)
<span style="color:#177500"># &#39;awesome&#39;</span>

<span style="color:#000">s</span><span style="color:#000">.</span><span style="color:#000">removesuffix</span>(<span style="color:#c41a16">&#34; is awesome&#34;</span>)
<span style="color:#177500"># &#39;Python&#39;</span>
</code></pre></div><p>The <strong>integer</strong> received the <a href="https://docs.python.org/3/library/stdtypes#int.bit_count"><code>int.bit_count()</code></a> method, which returns the number of ones in the binary representation of the integer (3.10+):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">n</span> <span style="color:#000">=</span> <span style="color:#1c01ce">42</span>

<span style="color:#a90d91">bin</span>(<span style="color:#000">n</span>)
<span style="color:#177500"># &#39;0b101010&#39;</span>

<span style="color:#000">n</span><span style="color:#000">.</span><span style="color:#000">bit_count</span>()
<span style="color:#177500"># 3</span>
</code></pre></div><p>The <strong>dictionary</strong> methods <code>dict.key()</code>, <code>dict.values()</code> and <code>dict.items()</code> return view objects that reference dictionary data. Previously, it was impossible to get a reverse link to the dictionary from these objects, but now it can be done — through the <code>.mapping</code> attribute (3.10+):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">people</span> <span style="color:#000">=</span> {
    <span style="color:#c41a16">&#34;Diane&#34;</span>: <span style="color:#1c01ce">70</span>,
    <span style="color:#c41a16">&#34;Bob&#34;</span>: <span style="color:#1c01ce">78</span>,
    <span style="color:#c41a16">&#34;Emma&#34;</span>: <span style="color:#1c01ce">84</span>
}

<span style="color:#000">keys</span> <span style="color:#000">=</span> <span style="color:#000">people</span><span style="color:#000">.</span><span style="color:#000">keys</span>()
<span style="color:#177500"># dict_keys([&#39;Diane&#39;, &#39;Bob&#39;, &#39;Emma&#39;])</span>

<span style="color:#000">keys</span><span style="color:#000">.</span><span style="color:#000">mapping</span>[<span style="color:#c41a16">&#34;Bob&#34;</span>]
<span style="color:#177500"># 78</span>
</code></pre></div><p><strong>Collection merging</strong> <a href="https://docs.python.org/3/library/functions#zip"><code>zip()</code></a> function received the <code>strict</code> parameter. It ensures that the sequences are of the same length (3.10+):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">keys</span> <span style="color:#000">=</span> [<span style="color:#c41a16">&#34;Diane&#34;</span>, <span style="color:#c41a16">&#34;Bob&#34;</span>, <span style="color:#c41a16">&#34;Emma&#34;</span>]
<span style="color:#000">vals</span> <span style="color:#000">=</span> [<span style="color:#1c01ce">70</span>, <span style="color:#1c01ce">78</span>, <span style="color:#1c01ce">84</span>, <span style="color:#1c01ce">42</span>]

<span style="color:#000">pairs</span> <span style="color:#000">=</span> <span style="color:#a90d91">zip</span>(<span style="color:#000">keys</span>, <span style="color:#000">vals</span>)
<span style="color:#a90d91">list</span>(<span style="color:#000">pairs</span>)
<span style="color:#177500"># [(&#39;Diane&#39;, 70), (&#39;Bob&#39;, 78), (&#39;Emma&#39;, 84)]</span>

<span style="color:#000">pairs</span> <span style="color:#000">=</span> <span style="color:#a90d91">zip</span>(<span style="color:#000">keys</span>, <span style="color:#000">vals</span>, <span style="color:#000">strict</span><span style="color:#000">=</span><span style="color:#a90d91">True</span>)
<span style="color:#a90d91">list</span>(<span style="color:#000">pairs</span>)
<span style="color:#177500"># ValueError: zip() argument 2 is longer than argument 1</span>
</code></pre></div><p><a href="https://stepik.org/lesson/717024/step/5">playground</a></p>
<p>Contributed by: <a href="https://github.com/sweeneyde">Dennis Sweeney</a> • <a href="https://github.com/niklasf">Niklas Fiekas</a> • <a href="https://github.com/brandtbucher">Brandt Bucher</a></p>
<h2 id="dataclasses">dataclasses</h2>
<p><a href="https://docs.python.org/3/library/dataclasses"><code>dataclasses</code></a> module generates classes according to the specification.</p>
<p>Dataclasses can now use <a href="https://docs.python.org/3/reference/datamodel.html#slots"><code>slots</code></a> for compact objects with a fixed set of properties (3.10+).</p>
<p>Regular dataclass:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">from</span> <span style="color:#000">dataclasses</span> <span style="color:#a90d91">import</span> <span style="color:#000">dataclass</span>

<span style="color:#000">@dataclass</span>
<span style="color:#a90d91">class</span> <span style="color:#3f6e75">Person</span>:
    <span style="color:#a90d91">id</span>: <span style="color:#a90d91">int</span>
    <span style="color:#000">name</span>: <span style="color:#a90d91">str</span>

<span style="color:#000">diane</span> <span style="color:#000">=</span> <span style="color:#000">Person</span>(<span style="color:#a90d91">id</span><span style="color:#000">=</span><span style="color:#1c01ce">11</span>, <span style="color:#000">name</span><span style="color:#000">=</span><span style="color:#c41a16">&#34;Diane&#34;</span>)
<span style="color:#000">diane</span><span style="color:#000">.</span><span style="color:#000">__dict__</span>
<span style="color:#177500"># {&#39;id&#39;: 11, &#39;name&#39;: &#39;Diane&#39;}</span>
<span style="color:#000">diane</span><span style="color:#000">.</span><span style="color:#000">salary</span> <span style="color:#000">=</span> <span style="color:#1c01ce">70</span>
<span style="color:#177500"># ok</span>
</code></pre></div><p>Dataclass with slots:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">from</span> <span style="color:#000">dataclasses</span> <span style="color:#a90d91">import</span> <span style="color:#000">dataclass</span>

<span style="color:#000">@dataclass</span>(<span style="color:#000">slots</span><span style="color:#000">=</span><span style="color:#a90d91">True</span>)
<span style="color:#a90d91">class</span> <span style="color:#3f6e75">SlotPerson</span>:
    <span style="color:#a90d91">id</span>: <span style="color:#a90d91">int</span>
    <span style="color:#000">name</span>: <span style="color:#a90d91">str</span>

<span style="color:#000">bob</span> <span style="color:#000">=</span> <span style="color:#000">SlotPerson</span>(<span style="color:#a90d91">id</span><span style="color:#000">=</span><span style="color:#1c01ce">12</span>, <span style="color:#000">name</span><span style="color:#000">=</span><span style="color:#c41a16">&#34;Bob&#34;</span>)
<span style="color:#000">bob</span><span style="color:#000">.</span><span style="color:#000">__dict__</span>
<span style="color:#177500"># AttributeError: &#39;SlotPerson&#39; object has no attribute &#39;__dict__&#39;</span>
<span style="color:#000">bob</span><span style="color:#000">.</span><span style="color:#000">__slots__</span>
<span style="color:#177500"># (&#39;id&#39;, &#39;name&#39;)</span>
<span style="color:#000">bob</span><span style="color:#000">.</span><span style="color:#000">salary</span> <span style="color:#000">=</span> <span style="color:#1c01ce">78</span>
<span style="color:#177500"># AttributeError: &#39;SlotPerson&#39; object has no attribute &#39;salary&#39;</span>
</code></pre></div><p>Besides, the dataclass can now be forced to accept keyword-only parameters when creating an object (3.10+):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">from</span> <span style="color:#000">dataclasses</span> <span style="color:#a90d91">import</span> <span style="color:#000">dataclass</span>

<span style="color:#000">@dataclass</span>(<span style="color:#000">kw_only</span><span style="color:#000">=</span><span style="color:#a90d91">True</span>)
<span style="color:#a90d91">class</span> <span style="color:#3f6e75">KeywordPerson</span>:
    <span style="color:#a90d91">id</span>: <span style="color:#a90d91">int</span>
    <span style="color:#000">name</span>: <span style="color:#a90d91">str</span>

<span style="color:#000">diane</span> <span style="color:#000">=</span> <span style="color:#000">KeywordPerson</span>(<span style="color:#a90d91">id</span><span style="color:#000">=</span><span style="color:#1c01ce">11</span>, <span style="color:#000">name</span><span style="color:#000">=</span><span style="color:#c41a16">&#34;Diane&#34;</span>)
<span style="color:#177500"># ok</span>
<span style="color:#000">diane</span> <span style="color:#000">=</span> <span style="color:#000">KeywordPerson</span>(<span style="color:#1c01ce">11</span>, <span style="color:#c41a16">&#34;Diane&#34;</span>)
<span style="color:#177500"># TypeError: KeywordPerson.__init__() takes 1 positional argument but 3 were given</span>
</code></pre></div><p><a href="https://stepik.org/lesson/717024/step/6">playground</a></p>
<p>Contributed by: <a href="https://github.com/uriyyo">Yurii Karabas</a> • <a href="https://github.com/ericvsmith">Eric V. Smith</a></p>
<h2 id="datetime">datetime</h2>
<p><a href="https://docs.python.org/3/library/datetime"><code>datetime</code></a> module (unsurprisingly) deals with date and time.</p>
<p>It received new <a href="https://docs.python.org/3/library/datetime#datetime.date.fromisocalendar"><code>date.fromisocalendar()</code></a> and <a href="https://docs.python.org/3/library/datetime#datetime.datetime.fromisocalendar"><code>datetime.fromisocalendar()</code></a> constructors, which create a date from the <code>(year, week, week_day)</code> trio (3.8+):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">import</span> <span style="color:#000">datetime</span> <span style="color:#a90d91">as</span> <span style="color:#000">dt</span>

<span style="color:#000">day</span> <span style="color:#000">=</span> <span style="color:#000">dt</span><span style="color:#000">.</span><span style="color:#000">date</span>(<span style="color:#1c01ce">2022</span>, <span style="color:#1c01ce">9</span>, <span style="color:#1c01ce">13</span>)
<span style="color:#000">day</span><span style="color:#000">.</span><span style="color:#000">isocalendar</span>()
<span style="color:#177500"># datetime.IsoCalendarDate(year=2022, week=37, weekday=2)</span>

<span style="color:#000">year</span>, <span style="color:#000">week</span>, <span style="color:#000">day</span> <span style="color:#000">=</span> <span style="color:#000">day</span><span style="color:#000">.</span><span style="color:#000">isocalendar</span>()
<span style="color:#000">next_day</span> <span style="color:#000">=</span> <span style="color:#000">dt</span><span style="color:#000">.</span><span style="color:#000">date</span><span style="color:#000">.</span><span style="color:#000">fromisocalendar</span>(<span style="color:#000">year</span>, <span style="color:#000">week</span>, <span style="color:#000">day</span><span style="color:#000">+</span><span style="color:#1c01ce">1</span>)
<span style="color:#177500"># datetime.date(2022, 9, 14)</span>
</code></pre></div><p>Besides, the <code>.isocalendar()</code> method now returns a named <code>IsoCalendarDate</code> instead of the regular tuple (3.9+). You can see it in the example above.</p>
<p><a href="https://stepik.org/lesson/717024/step/7">playground</a></p>
<p>Contributed by: <a href="https://github.com/pganssle">Paul Ganssle</a> • <a href="https://github.com/corona10">Dong-hee Na</a></p>
<h2 id="fractions">fractions</h2>
<p><a href="https://docs.python.org/3/library/fractions"><code>fractions</code></a> module works with rational numbers.</p>
<p>It received the <a href="https://docs.python.org/3/library/fractions#fractions.Fraction.as_integer_ratio"><code>Fraction.as_integer_ratio()</code></a> method to return a fraction as a <code>(numerator, denominator)</code> pair, thereby fixing the age-old shame of the usual <code>float</code> (3.8+):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">(<span style="color:#1c01ce">0.25</span>)<span style="color:#000">.</span><span style="color:#000">as_integer_ratio</span>()
<span style="color:#177500"># (1, 4)</span>

(<span style="color:#1c01ce">0.5</span>)<span style="color:#000">.</span><span style="color:#000">as_integer_ratio</span>()
<span style="color:#177500"># (1, 2)</span>

(<span style="color:#1c01ce">0.2</span>)<span style="color:#000">.</span><span style="color:#000">as_integer_ratio</span>()
<span style="color:#177500"># (3602879701896397, 18014398509481984)</span>
<span style="color:#177500"># oopsie</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">from</span> <span style="color:#000">fractions</span> <span style="color:#a90d91">import</span> <span style="color:#000">Fraction</span>

<span style="color:#000">Fraction</span>(<span style="color:#c41a16">&#34;0.2&#34;</span>)<span style="color:#000">.</span><span style="color:#000">as_integer_ratio</span>()
<span style="color:#177500"># (1, 5)</span>
<span style="color:#177500"># so much better</span>
</code></pre></div><p>To be fair, <code>decimal.Decimal</code> learned to do this back in 3.6. But it&rsquo;s still nice.</p>
<p><a href="https://stepik.org/lesson/717024/step/8">playground</a></p>
<p>Contributed by: <a href="https://github.com/lisroach">Lisa Roach</a> • <a href="https://github.com/rhettinger">Raymond Hettinger</a></p>
<h2 id="functools">functools</h2>
<p><a href="https://docs.python.org/3/library/functools"><code>functools</code></a> module is a collection of higher-order auxiliary functions. One of them is <a href="https://docs.python.org/3/library/functools#functools.lru_cache"><code>lru_cache()</code></a>, which caches expensive calculations:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">import</span> <span style="color:#000">functools</span>
<span style="color:#a90d91">import</span> <span style="color:#000">time</span>

<span style="color:#000">@functools</span><span style="color:#000">.</span><span style="color:#000">lru_cache</span>(<span style="color:#000">maxsize</span><span style="color:#000">=</span><span style="color:#1c01ce">256</span>)
<span style="color:#a90d91">def</span> <span style="color:#000">find_user</span>(<span style="color:#000">name</span>):
    <span style="color:#177500"># imitating slow search</span>
    <span style="color:#000">time</span><span style="color:#000">.</span><span style="color:#000">sleep</span>(<span style="color:#1c01ce">1</span>)
    <span style="color:#000">user</span> <span style="color:#000">=</span> {<span style="color:#c41a16">&#34;id&#34;</span>: <span style="color:#1c01ce">11</span>, <span style="color:#c41a16">&#34;name&#34;</span>: <span style="color:#c41a16">&#34;Diane&#34;</span>}
    <span style="color:#a90d91">return</span> <span style="color:#000">user</span>

<span style="color:#000">find_user</span>(<span style="color:#c41a16">&#34;Diane&#34;</span>)
<span style="color:#177500"># kinda slow</span>

<span style="color:#000">find_user</span>(<span style="color:#c41a16">&#34;Diane&#34;</span>)
<span style="color:#177500"># blazingly fast</span>
</code></pre></div><p>Previously, it required to explicitly set the cache size. And now you can specify <code>@lru_cache</code> without arguments, using the default size of <code>128</code> (3.8+).</p>
<p>Besides, you can get the cache parameters (3.9+):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">find_user</span><span style="color:#000">.</span><span style="color:#000">cache_parameters</span>()
<span style="color:#177500"># {&#39;maxsize&#39;: 256, &#39;typed&#39;: False}</span>
</code></pre></div><p>If you don&rsquo;t mind the memory usage, you can use the unlimited <a href="https://docs.python.org/3/library/functools#functools.cache"><code>@cache</code></a> instead of <code>@lru_cache</code> (3.9+).</p>
<p>New <a href="https://docs.python.org/3/library/functools#functools.cached_property"><code>@cached_property</code></a> decorator caches the calculated object property (3.8+):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">import</span> <span style="color:#000">functools</span>
<span style="color:#a90d91">import</span> <span style="color:#000">statistics</span>

<span style="color:#a90d91">class</span> <span style="color:#3f6e75">Dataset</span>:
    <span style="color:#a90d91">def</span> <span style="color:#000">__init__</span>(<span style="color:#5b269a">self</span>, <span style="color:#000">seq</span>):
        <span style="color:#5b269a">self</span><span style="color:#000">.</span><span style="color:#000">_data</span> <span style="color:#000">=</span> <span style="color:#a90d91">tuple</span>(<span style="color:#000">seq</span>)

    <span style="color:#000">@functools</span><span style="color:#000">.</span><span style="color:#000">cached_property</span>
    <span style="color:#a90d91">def</span> <span style="color:#000">stdev</span>(<span style="color:#5b269a">self</span>):
        <span style="color:#a90d91">return</span> <span style="color:#000">statistics</span><span style="color:#000">.</span><span style="color:#000">stdev</span>(<span style="color:#5b269a">self</span><span style="color:#000">.</span><span style="color:#000">_data</span>)

<span style="color:#000">dataset</span> <span style="color:#000">=</span> <span style="color:#000">Dataset</span>(<span style="color:#a90d91">range</span>(<span style="color:#1c01ce">1_000_000</span>))

<span style="color:#000">dataset</span><span style="color:#000">.</span><span style="color:#000">stdev</span>
<span style="color:#177500"># kinda slow</span>

<span style="color:#000">dataset</span><span style="color:#000">.</span><span style="color:#000">stdev</span>
<span style="color:#177500"># blazingly fast</span>
</code></pre></div><p>And <a href="https://docs.python.org/3/library/functools#functools.singledispatchmethod"><code>@singledispatchmethod</code></a> overloads the method depending on the parameter type (3.8+):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">import</span> <span style="color:#000">functools</span>

<span style="color:#a90d91">class</span> <span style="color:#3f6e75">Divider</span>:
    <span style="color:#000">@functools</span><span style="color:#000">.</span><span style="color:#000">singledispatchmethod</span>
    <span style="color:#a90d91">def</span> <span style="color:#000">divide</span>(<span style="color:#5b269a">self</span>, <span style="color:#000">dividend</span>, <span style="color:#000">divisor</span>):
        <span style="color:#a90d91">raise</span> <span style="color:#000">NotImplementedError</span>(<span style="color:#c41a16">&#34;Do not know how to divide those&#34;</span>)

    <span style="color:#000">@divide</span><span style="color:#000">.</span><span style="color:#000">register</span>
    <span style="color:#a90d91">def</span> <span style="color:#000">_</span>(<span style="color:#5b269a">self</span>, <span style="color:#000">dividend</span>: <span style="color:#a90d91">int</span>, <span style="color:#000">divisor</span>: <span style="color:#a90d91">int</span>):
        <span style="color:#a90d91">return</span> <span style="color:#000">dividend</span> <span style="color:#000">//</span> <span style="color:#000">divisor</span>

    <span style="color:#000">@divide</span><span style="color:#000">.</span><span style="color:#000">register</span>
    <span style="color:#a90d91">def</span> <span style="color:#000">_</span>(<span style="color:#5b269a">self</span>, <span style="color:#000">dividend</span>: <span style="color:#a90d91">str</span>, <span style="color:#000">divisor</span>: <span style="color:#a90d91">int</span>):
        <span style="color:#177500"># this is really stupid, I know</span>
        <span style="color:#000">newlen</span> <span style="color:#000">=</span> <span style="color:#a90d91">len</span>(<span style="color:#000">dividend</span>) <span style="color:#000">//</span> <span style="color:#000">divisor</span>
        <span style="color:#a90d91">return</span> <span style="color:#000">dividend</span>[:<span style="color:#000">newlen</span>]

<span style="color:#000">divider</span> <span style="color:#000">=</span> <span style="color:#000">Divider</span>()
<span style="color:#000">divider</span><span style="color:#000">.</span><span style="color:#000">divide</span>(<span style="color:#1c01ce">10</span>, <span style="color:#1c01ce">2</span>)
<span style="color:#177500"># 5</span>

<span style="color:#000">divider</span><span style="color:#000">.</span><span style="color:#000">divide</span>(<span style="color:#c41a16">&#34;hello world&#34;</span>, <span style="color:#1c01ce">2</span>)
<span style="color:#177500"># &#39;hello&#39;</span>
</code></pre></div><p>Smells like Java to me.</p>
<p><a href="https://stepik.org/lesson/717024/step/9">playground</a></p>
<p>Contributed by: <a href="https://github.com/rhettinger">Raymond Hettinger</a> • <a href="https://github.com/carljm">Carl Meyer</a> • <a href="https://github.com/ethanhs">Ethan Smith</a></p>
<h2 id="glob">glob</h2>
<p><a href="https://docs.python.org/3/library/glob"><code>glob</code></a> module searches for files and directories that match the template.</p>
<p>Now thanks to the <code>root_dir</code> parameter in <a href="https://docs.python.org/3/library/glob#glob.glob"><code>glob()</code></a> and <a href="https://docs.python.org/3/library/glob#glob.iglob"><code>iglob()</code></a> functions you can specify the root directory of the search (3.10+):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">import</span> <span style="color:#000">glob</span>
<span style="color:#a90d91">import</span> <span style="color:#000">os</span>

<span style="color:#000">os</span><span style="color:#000">.</span><span style="color:#000">getcwd</span>()
<span style="color:#177500"># &#39;/&#39;</span>

<span style="color:#000">glob</span><span style="color:#000">.</span><span style="color:#000">glob</span>(<span style="color:#c41a16">&#34;*&#34;</span>, <span style="color:#000">root_dir</span><span style="color:#000">=</span><span style="color:#c41a16">&#34;/usr&#34;</span>)
<span style="color:#177500"># [&#39;local&#39;, &#39;share&#39;, &#39;bin&#39;, &#39;lib&#39;, &#39;sbin&#39;, &#39;src&#39;]</span>
</code></pre></div><p>It&rsquo;s a small thing, but it&rsquo;s nice.</p>
<p><a href="https://stepik.org/lesson/717024/step/10">playground</a></p>
<p>Contributed by: <a href="https://github.com/serhiy-storchaka">Serhiy Storchaka</a></p>
<h2 id="graphlib">graphlib</h2>
<p><a href="https://docs.python.org/3/library/graphlib"><code>graphlib</code></a> module works with graphs. And you know what? This is a brand-new module! (3.9+)</p>
<p>So far, it has only one feature — topological graph sorting (an ordering of vertices such that for any <code>u → v</code>, the vertex <code>u</code> comes before <code>v</code>):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">from</span> <span style="color:#000">graphlib</span> <span style="color:#a90d91">import</span> <span style="color:#000">TopologicalSorter</span>

<span style="color:#000">graph</span> <span style="color:#000">=</span> {<span style="color:#c41a16">&#34;Diane&#34;</span>: {<span style="color:#c41a16">&#34;Bob&#34;</span>, <span style="color:#c41a16">&#34;Cindy&#34;</span>}, <span style="color:#c41a16">&#34;Cindy&#34;</span>: {<span style="color:#c41a16">&#34;Alice&#34;</span>}, <span style="color:#c41a16">&#34;Bob&#34;</span>: {<span style="color:#c41a16">&#34;Alice&#34;</span>}}
<span style="color:#177500"># Alice → Bob → Diane</span>
<span style="color:#177500">#     ↳ Cindy ↗</span>

<span style="color:#000">sorter</span> <span style="color:#000">=</span> <span style="color:#000">TopologicalSorter</span>(<span style="color:#000">graph</span>)
<span style="color:#a90d91">list</span>(<span style="color:#000">sorter</span><span style="color:#000">.</span><span style="color:#000">static_order</span>())
<span style="color:#177500"># [&#39;Alice&#39;, &#39;Cindy&#39;, &#39;Bob&#39;, &#39;Diane&#39;]</span>
</code></pre></div><p><a href="https://stepik.org/lesson/717025/step/2">playground</a></p>
<p>Contributed by: <a href="https://github.com/pablogsal">Pablo Galindo</a> • <a href="https://github.com/tim-one">Tim Peters</a> • <a href="https://github.com/larryhastings">Larry Hastings</a></p>
<h2 id="itertools">itertools</h2>
<p><a href="https://docs.python.org/3/library/itertools"><code>itertools</code></a> module provides a variety of iterators for memory-efficient collection processing.</p>
<p>One of them is the <a href="https://docs.python.org/3/library/itertools#itertools.accumulate"><code>accumulate()</code></a> function, which calculates the rolling aggregate. Now it allows the <code>initial</code> parameter, which sets the initial value (3.8+):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">import</span> <span style="color:#000">itertools</span>

<span style="color:#000">seq</span> <span style="color:#000">=</span> [<span style="color:#1c01ce">7</span>, <span style="color:#1c01ce">11</span>, <span style="color:#1c01ce">19</span>, <span style="color:#1c01ce">42</span>]

<span style="color:#000">accumulator</span> <span style="color:#000">=</span> <span style="color:#000">itertools</span><span style="color:#000">.</span><span style="color:#000">accumulate</span>(<span style="color:#000">seq</span>)
<span style="color:#a90d91">list</span>(<span style="color:#000">accumulator</span>)
<span style="color:#177500"># [7, 18, 37, 79]</span>

<span style="color:#000">accumulator</span> <span style="color:#000">=</span> <span style="color:#000">itertools</span><span style="color:#000">.</span><span style="color:#000">accumulate</span>(<span style="color:#000">seq</span>, <span style="color:#000">initial</span><span style="color:#000">=</span><span style="color:#1c01ce">100</span>)
<span style="color:#a90d91">list</span>(<span style="color:#000">accumulator</span>)
<span style="color:#177500"># [100, 107, 118, 137, 179]</span>
</code></pre></div><p>And the shiny new <a href="https://docs.python.org/3/library/itertools#itertools.pairwise"><code>pairwise()</code></a> function traverses the collection and yields pairs of consecutive elements (3.10+):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">import</span> <span style="color:#000">itertools</span>

<span style="color:#000">seq</span> <span style="color:#000">=</span> [<span style="color:#1c01ce">7</span>, <span style="color:#1c01ce">11</span>, <span style="color:#1c01ce">19</span>, <span style="color:#1c01ce">42</span>]
<span style="color:#000">pairer</span> <span style="color:#000">=</span> <span style="color:#000">itertools</span><span style="color:#000">.</span><span style="color:#000">pairwise</span>(<span style="color:#000">seq</span>)

<span style="color:#a90d91">list</span>(<span style="color:#000">pairer</span>)
<span style="color:#177500"># [(7, 11), (11, 19), (19, 42)]</span>
</code></pre></div><p><a href="https://stepik.org/lesson/717025/step/3">playground</a></p>
<p>Contributed by: <a href="https://github.com/lisroach">Lisa Roach</a> • <a href="https://github.com/rhettinger">Raymond Hettinger</a></p>
<h2 id="math">math</h2>
<p><a href="https://docs.python.org/3/library/math"><code>math</code></a> module includes an abundance of mathematical functions.</p>
<p>There are a lot of news here:</p>
<ul>
<li><a href="https://docs.python.org/3/library/math#math.dist"><code>dist()</code></a> calculates the Euclidean distance between points (3.8+);</li>
<li><a href="https://docs.python.org/3/library/math#math.perm"><code>perm()</code></a> and <a href="https://docs.python.org/3/library/math#math.comb"><code>comb()</code></a> count the number of permutations and combinations (3.8+);</li>
<li><a href="https://docs.python.org/3/library/math#math.lcm"><code>lcm()</code></a> computes the least common multiple (3.9+);</li>
<li><a href="https://docs.python.org/3/library/math#math.gcd"><code>gcd()</code></a> now computes the greatest common divisor for an arbitrary number of arguments (3.9+).</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">import</span> <span style="color:#000">math</span>

<span style="color:#000">math</span><span style="color:#000">.</span><span style="color:#000">dist</span>((<span style="color:#1c01ce">1</span>,<span style="color:#1c01ce">1</span>), (<span style="color:#1c01ce">4</span>, <span style="color:#1c01ce">5</span>))
<span style="color:#177500"># 5.0</span>

<span style="color:#000">math</span><span style="color:#000">.</span><span style="color:#000">perm</span>(<span style="color:#1c01ce">5</span>, <span style="color:#1c01ce">2</span>)
<span style="color:#177500"># 20</span>

<span style="color:#000">math</span><span style="color:#000">.</span><span style="color:#000">comb</span>(<span style="color:#1c01ce">5</span>, <span style="color:#1c01ce">2</span>)
<span style="color:#177500"># 10</span>

<span style="color:#000">math</span><span style="color:#000">.</span><span style="color:#000">lcm</span>(<span style="color:#1c01ce">9</span>, <span style="color:#1c01ce">27</span>, <span style="color:#1c01ce">60</span>)
<span style="color:#177500"># 540</span>

<span style="color:#000">math</span><span style="color:#000">.</span><span style="color:#000">gcd</span>(<span style="color:#1c01ce">9</span>, <span style="color:#1c01ce">27</span>, <span style="color:#1c01ce">60</span>)
<span style="color:#177500"># 3</span>
</code></pre></div><p>And <a href="https://docs.python.org/3/library/math#math.prod"><code>prod()</code></a> multiplies the sequence elements (3.8+):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">import</span> <span style="color:#000">math</span>

<span style="color:#000">seq</span> <span style="color:#000">=</span> <span style="color:#a90d91">range</span>(<span style="color:#1c01ce">3</span>, <span style="color:#1c01ce">9</span>)
<span style="color:#000">math</span><span style="color:#000">.</span><span style="color:#000">prod</span>(<span style="color:#000">seq</span>)
<span style="color:#177500"># 20160</span>
</code></pre></div><p><a href="https://stepik.org/lesson/717025/step/4">playground</a></p>
<p>Contributed by: <a href="https://github.com/rhettinger">Raymond Hettinger</a> • <a href="https://github.com/FR4NKESTI3N">Yash Aggarwal</a> • <a href="https://github.com/KellerFuchs">Keller Fuchs</a> • <a href="https://github.com/serhiy-storchaka">Serhiy Storchaka</a> • <a href="https://github.com/mdickinson">Mark Dickinson</a> • <a href="https://github.com/ananthan-123">Ananthakrishnan</a> • <a href="https://github.com/pablogsal">Pablo Galindo</a></p>
<h2 id="random">random</h2>
<p><a href="https://docs.python.org/3/library/random"><code>random</code></a> module handles random numbers.</p>
<p>New <a href="https://docs.python.org/3/library/random#random.randbytes"><code>randbytes()</code></a> method generates a random byte string (3.9+):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">import</span> <span style="color:#000">random</span>

<span style="color:#000">random</span><span style="color:#000">.</span><span style="color:#000">randbytes</span>(<span style="color:#1c01ce">4</span>)
<span style="color:#177500"># b&#39;\x8b\xd4\x8f\xc9&#39;</span>
</code></pre></div><p><a href="https://stepik.org/lesson/717025/step/5">playground</a></p>
<p>Contributed by: <a href="https://github.com/vstinner">Victor Stinner</a></p>
<h2 id="shlex">shlex</h2>
<p><a href="https://docs.python.org/3/library/shlex"><code>shlex</code></a> module splits the string into tokens according to the Unix command line rules.</p>
<p>And now it also joins the tokens back into the string — thanks to the <a href="https://docs.python.org/3/library/shlex#shlex.join"><code>join()</code></a> function (3.8+):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">import</span> <span style="color:#000">shlex</span>

<span style="color:#000">tokens</span> <span style="color:#000">=</span> [<span style="color:#c41a16">&#34;echo&#34;</span>, <span style="color:#c41a16">&#34;-n&#34;</span>, <span style="color:#c41a16">&#34;Python is awesome&#34;</span>]
<span style="color:#000">shlex</span><span style="color:#000">.</span><span style="color:#000">join</span>(<span style="color:#000">tokens</span>)
<span style="color:#177500"># &#34;echo -n &#39;Python is awesome&#39;&#34;</span>
</code></pre></div><p><a href="https://stepik.org/lesson/717025/step/6">playground</a></p>
<p>Contributed by: <a href="https://github.com/bbayles">Bo Bayles</a></p>
<h2 id="shutil">shutil</h2>
<p><a href="https://docs.python.org/3/library/shutil"><code>shutil</code></a> module works with files and directories: copies, moves and deletes them.</p>
<p>Copying directories has now become a little more convenient — kudos to the <code>dirs_exist_ok</code> parameter in the <a href="https://docs.python.org/3/library/shutil#shutil.copytree"><code>copytree()</code></a> function (3.8+). If it is on, the function allows the target directory to exist:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">from</span> <span style="color:#000">pathlib</span> <span style="color:#a90d91">import</span> <span style="color:#000">Path</span>
<span style="color:#a90d91">import</span> <span style="color:#000">shutil</span>

<span style="color:#000">tmp</span> <span style="color:#000">=</span> <span style="color:#000">Path</span>(<span style="color:#c41a16">&#34;/tmp&#34;</span>)

<span style="color:#000">src</span> <span style="color:#000">=</span> <span style="color:#000">tmp</span><span style="color:#000">.</span><span style="color:#000">joinpath</span>(<span style="color:#c41a16">&#34;src&#34;</span>)
<span style="color:#000">src</span><span style="color:#000">.</span><span style="color:#000">mkdir</span>()
<span style="color:#000">src</span><span style="color:#000">.</span><span style="color:#000">joinpath</span>(<span style="color:#c41a16">&#34;src.txt&#34;</span>)<span style="color:#000">.</span><span style="color:#000">touch</span>()
<span style="color:#177500"># /tmp/src</span>
<span style="color:#177500"># /tmp/src/src.txt</span>

<span style="color:#000">dst</span> <span style="color:#000">=</span> <span style="color:#000">tmp</span><span style="color:#000">.</span><span style="color:#000">joinpath</span>(<span style="color:#c41a16">&#34;dst&#34;</span>)
<span style="color:#000">dst</span><span style="color:#000">.</span><span style="color:#000">mkdir</span>()
<span style="color:#177500"># /tmp/dst</span>

<span style="color:#000">shutil</span><span style="color:#000">.</span><span style="color:#000">copytree</span>(<span style="color:#000">src</span>, <span style="color:#000">dst</span>)
<span style="color:#177500"># FileExistsError: [Errno 17] File exists: &#39;/tmp/dst&#39;</span>
<span style="color:#000">shutil</span><span style="color:#000">.</span><span style="color:#000">copytree</span>(<span style="color:#000">src</span>, <span style="color:#000">dst</span>, <span style="color:#000">dirs_exist_ok</span><span style="color:#000">=</span><span style="color:#a90d91">True</span>)
<span style="color:#177500"># PosixPath(&#39;/tmp/dst&#39;)</span>
</code></pre></div><p><a href="https://stepik.org/lesson/717025/step/7">playground</a></p>
<p>Contributed by: <a href="https://github.com/jab">Josh Bronson</a></p>
<h2 id="statistics">statistics</h2>
<p><a href="https://docs.python.org/3/library/statistics"><code>statistics</code></a> module handles mathematical statistics. Like <code>math</code>, it has greatly improved in recent releases. Not <code>scipy</code> yet, but it&rsquo;s not the kindergarten version Python had in 3.4.</p>
<p>See for yourself:</p>
<ul>
<li><a href="https://docs.python.org/3/library/statistics#statistics.fmean"><code>fmean()</code></a> computes the arithmetic mean (like <code>mean()</code>, only faster) (3.8+);</li>
<li><a href="https://docs.python.org/3/library/statistics#statistics.geometric_mean"><code>geometric_mean()</code></a> computes the geometric mean (3.8+);</li>
<li><a href="https://docs.python.org/3/library/statistics#statistics.multimode"><code>multimode()</code></a> returns the modes (the most frequent values in the dataset), even if there are multiple ones (in contrast to <code>mode()</code>) (3.8+);</li>
<li><a href="https://docs.python.org/3/library/statistics#statistics.quantiles"><code>quantiles()</code></a> splits the dataset into quantiles and returns the cut points (3.8+).</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">import</span> <span style="color:#000">statistics</span>

<span style="color:#000">seq</span> <span style="color:#000">=</span> <span style="color:#a90d91">list</span>(<span style="color:#a90d91">range</span>(<span style="color:#1c01ce">1</span>, <span style="color:#1c01ce">10</span>))

<span style="color:#000">statistics</span><span style="color:#000">.</span><span style="color:#000">fmean</span>(<span style="color:#000">seq</span>)
<span style="color:#177500"># 5.0</span>

<span style="color:#000">statistics</span><span style="color:#000">.</span><span style="color:#000">geometric_mean</span>(<span style="color:#000">seq</span>)
<span style="color:#177500"># 4.147166274396913</span>

<span style="color:#000">statistics</span><span style="color:#000">.</span><span style="color:#000">multimode</span>(<span style="color:#000">seq</span>)
<span style="color:#177500"># [1, 2, 3, 4, 5, 6, 7, 8, 9]</span>
<span style="color:#000">statistics</span><span style="color:#000">.</span><span style="color:#000">multimode</span>(<span style="color:#c41a16">&#34;python is awesome&#34;</span>)
<span style="color:#177500"># [&#39;o&#39;, &#39; &#39;, &#39;s&#39;, &#39;e&#39;]</span>

<span style="color:#000">statistics</span><span style="color:#000">.</span><span style="color:#000">quantiles</span>(<span style="color:#000">seq</span>)
<span style="color:#177500"># [2.5, 5.0, 7.5]</span>
</code></pre></div><p><a href="https://docs.python.org/3/library/statistics#statistics.NormalDist"><code>NormalDist</code></a> describes the normal distribution of a random variable (3.8+):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">from</span> <span style="color:#000">statistics</span> <span style="color:#a90d91">import</span> <span style="color:#000">NormalDist</span>

<span style="color:#000">birth_weights</span> <span style="color:#000">=</span> <span style="color:#000">NormalDist</span><span style="color:#000">.</span><span style="color:#000">from_samples</span>([<span style="color:#1c01ce">2.5</span>, <span style="color:#1c01ce">3.1</span>, <span style="color:#1c01ce">2.1</span>, <span style="color:#1c01ce">2.4</span>, <span style="color:#1c01ce">2.7</span>, <span style="color:#1c01ce">3.5</span>])
<span style="color:#000">drug_effects</span> <span style="color:#000">=</span> <span style="color:#000">NormalDist</span>(<span style="color:#1c01ce">0.4</span>, <span style="color:#1c01ce">0.15</span>)
<span style="color:#000">combined</span> <span style="color:#000">=</span> <span style="color:#000">birth_weights</span> <span style="color:#000">+</span> <span style="color:#000">drug_effects</span>

<span style="color:#a90d91">round</span>(<span style="color:#000">combined</span><span style="color:#000">.</span><span style="color:#000">mean</span>, <span style="color:#1c01ce">1</span>)
<span style="color:#177500"># 3.1</span>

<span style="color:#a90d91">round</span>(<span style="color:#000">combined</span><span style="color:#000">.</span><span style="color:#000">stdev</span>, <span style="color:#1c01ce">1</span>)
<span style="color:#177500"># 0.5</span>
</code></pre></div><p>The module received Pearson <a href="https://docs.python.org/3/library/statistics#statistics.correlation"><code>correlation()</code></a> and <a href="https://docs.python.org/3/library/statistics#statistics.covariance"><code>covariance()</code></a> functions (3.10+):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">import</span> <span style="color:#000">statistics</span>

<span style="color:#000">x</span> <span style="color:#000">=</span> [<span style="color:#1c01ce">1</span>, <span style="color:#1c01ce">2</span>, <span style="color:#1c01ce">3</span>, <span style="color:#1c01ce">4</span>, <span style="color:#1c01ce">5</span>, <span style="color:#1c01ce">6</span>, <span style="color:#1c01ce">7</span>, <span style="color:#1c01ce">8</span>, <span style="color:#1c01ce">9</span>]
<span style="color:#000">y</span> <span style="color:#000">=</span> [<span style="color:#1c01ce">9</span>, <span style="color:#1c01ce">8</span>, <span style="color:#1c01ce">7</span>, <span style="color:#1c01ce">6</span>, <span style="color:#1c01ce">5</span>, <span style="color:#1c01ce">4</span>, <span style="color:#1c01ce">3</span>, <span style="color:#1c01ce">2</span>, <span style="color:#1c01ce">1</span>]

<span style="color:#000">statistics</span><span style="color:#000">.</span><span style="color:#000">correlation</span>(<span style="color:#000">x</span>, <span style="color:#000">x</span>)
<span style="color:#177500"># 1.0</span>

<span style="color:#000">statistics</span><span style="color:#000">.</span><span style="color:#000">correlation</span>(<span style="color:#000">x</span>, <span style="color:#000">y</span>)
<span style="color:#177500"># -1.0</span>

<span style="color:#000">statistics</span><span style="color:#000">.</span><span style="color:#000">covariance</span>(<span style="color:#000">x</span>, <span style="color:#000">x</span>)
<span style="color:#177500"># 7.5</span>

<span style="color:#000">statistics</span><span style="color:#000">.</span><span style="color:#000">covariance</span>(<span style="color:#000">x</span>, <span style="color:#000">y</span>)
<span style="color:#177500"># -7.5</span>
</code></pre></div><p>And even the <a href="https://docs.python.org/3/library/statistics#statistics.linear_regression"><code>linear_regression()</code></a> calculator (3.10+):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">import</span> <span style="color:#000">statistics</span>

<span style="color:#000">movies_by_year</span> <span style="color:#000">=</span> {
    <span style="color:#1c01ce">2000</span>: <span style="color:#1c01ce">371</span>,
    <span style="color:#1c01ce">2003</span>: <span style="color:#1c01ce">507</span>,
    <span style="color:#1c01ce">2006</span>: <span style="color:#1c01ce">608</span>,
    <span style="color:#1c01ce">2009</span>: <span style="color:#1c01ce">520</span>,
    <span style="color:#1c01ce">2012</span>: <span style="color:#1c01ce">669</span>,
    <span style="color:#1c01ce">2015</span>: <span style="color:#1c01ce">708</span>,
    <span style="color:#1c01ce">2018</span>: <span style="color:#1c01ce">873</span>,
    <span style="color:#1c01ce">2021</span>: <span style="color:#1c01ce">403</span>,
}

<span style="color:#000">x</span> <span style="color:#000">=</span> <span style="color:#000">movies_by_year</span><span style="color:#000">.</span><span style="color:#000">keys</span>()
<span style="color:#000">y</span> <span style="color:#000">=</span> <span style="color:#000">movies_by_year</span><span style="color:#000">.</span><span style="color:#000">values</span>()
<span style="color:#000">slope</span>, <span style="color:#000">intercept</span> <span style="color:#000">=</span> <span style="color:#000">statistics</span><span style="color:#000">.</span><span style="color:#000">linear_regression</span>(<span style="color:#000">x</span>, <span style="color:#000">y</span>)

<span style="color:#000">year_2022</span> <span style="color:#000">=</span> <span style="color:#a90d91">round</span>(<span style="color:#000">slope</span> <span style="color:#000">*</span> <span style="color:#1c01ce">2022</span> <span style="color:#000">+</span> <span style="color:#000">intercept</span>)
<span style="color:#177500"># 697</span>
</code></pre></div><p>By the way, the <code>statistics</code> module is also famous for its excellent documentation. Check it out.</p>
<p><a href="https://stepik.org/lesson/717025/step/8">playground</a></p>
<p>Contributed by: <a href="https://github.com/rhettinger">Raymond Hettinger</a> • <a href="https://github.com/stevendaprano">Steven D’Aprano</a> • <a href="https://github.com/twolodzko">Timothy Wolodzko</a></p>
<h2 id="zoneinfo">zoneinfo</h2>
<p><a href="https://docs.python.org/3/library/zoneinfo"><code>zoneinfo</code></a> module provides information about time zones around the world. Another new module! (3.9+)</p>
<p>Before the <code>zoneinfo</code> appearance, Python had a single ascetic <code>timezone.utc</code> time zone. Well, not anymore:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">import</span> <span style="color:#000">datetime</span> <span style="color:#a90d91">as</span> <span style="color:#000">dt</span>
<span style="color:#a90d91">from</span> <span style="color:#000">zoneinfo</span> <span style="color:#a90d91">import</span> <span style="color:#000">ZoneInfo</span>

<span style="color:#000">utc</span> <span style="color:#000">=</span> <span style="color:#000">dt</span><span style="color:#000">.</span><span style="color:#000">datetime</span>(<span style="color:#1c01ce">2022</span>, <span style="color:#1c01ce">9</span>, <span style="color:#1c01ce">13</span>, <span style="color:#000">hour</span><span style="color:#000">=</span><span style="color:#1c01ce">21</span>, <span style="color:#000">tzinfo</span><span style="color:#000">=</span><span style="color:#000">dt</span><span style="color:#000">.</span><span style="color:#000">timezone</span><span style="color:#000">.</span><span style="color:#000">utc</span>)
<span style="color:#177500"># 2022-09-13 21:00:00+00:00</span>

<span style="color:#000">paris</span> <span style="color:#000">=</span> <span style="color:#000">utc</span><span style="color:#000">.</span><span style="color:#000">astimezone</span>(<span style="color:#000">ZoneInfo</span>(<span style="color:#c41a16">&#34;Europe/Paris&#34;</span>))
<span style="color:#177500"># 2022-09-13 23:00:00+02:00</span>

<span style="color:#000">tokyo</span> <span style="color:#000">=</span> <span style="color:#000">utc</span><span style="color:#000">.</span><span style="color:#000">astimezone</span>(<span style="color:#000">ZoneInfo</span>(<span style="color:#c41a16">&#34;Asia/Tokyo&#34;</span>))
<span style="color:#177500"># 2022-09-14 06:00:00+09:00</span>

<span style="color:#000">sydney</span> <span style="color:#000">=</span> <span style="color:#000">utc</span><span style="color:#000">.</span><span style="color:#000">astimezone</span>(<span style="color:#000">ZoneInfo</span>(<span style="color:#c41a16">&#34;Australia/Sydney&#34;</span>))
<span style="color:#177500"># 2022-09-14 07:00:00+10:00</span>
</code></pre></div><p><a href="https://stepik.org/lesson/717025/step/9">playground</a></p>
<p>Contributed by: <a href="https://github.com/pganssle">Paul Ganssle</a></p>
<h2 id="summary">Summary</h2>
<p>We have reviewed as many as 17 modules contributed by 27 devs — and this is without taking into account <code>asyncio</code>, <code>typing</code> and many other lower-level ones. As you can see, the standard library is actively developing. And the new features are quite reasonable. I hope you will find the described novelties useful!</p>
<p>I would also like to specifically thank the contributors for their amazing work:</p>
<ul>
<li><a href="https://twitter.com/carljm">Carl Meyer</a> for the <code>functools.cached_property()</code> decorator;</li>
<li><a href="https://github.com/sweeneyde">Dennis Sweeney</a> for the <code>str.removeprefix()</code> and <code>str.removesuffix()</code> methods;</li>
<li><a href="https://twitter.com/ethanhs">Ethan Smith</a> for the <code>functools.singledispatchmethod()</code> decorator;</li>
<li><a href="https://twitter.com/missingclara">Filipe Laíns</a> for the <code>base64.b32hexencode()</code> and <code>base64.b32hexdecode()</code> functions;</li>
<li><a href="https://twitter.com/lisroach">Lisa Roach</a> for the <code>Fraction.as_integer_ratio()</code> method and <code>itertools.accumulate()</code> improvements;</li>
<li><a href="https://twitter.com/niklasfiekas">Niklas Fiekas</a> for the <code>int.bit_count()</code> method;</li>
<li><a href="https://twitter.com/pyblogsal">Pablo Galindo</a> for the whole <code>graphlib</code> module and <code>math.prod()</code> function;</li>
<li><a href="https://twitter.com/pganssle">Paul Ganssle</a> for the whole <code>zoneinfo</code> module;</li>
<li><a href="https://twitter.com/raymondh">Raymond Hettinger</a> for lots of functions in the <code>statistics</code> module, <code>itertools.pairwise()</code> function, <code>key</code> parameter in the <code>bisect</code> module and his community work;</li>
<li><a href="https://twitter.com/serhiystorchaka">Serhiy Storchaka</a> and <a href="https://github.com/FR4NKESTI3N">Yash Aggarwal</a> for the combinatorics in the <code>math</code> module;</li>
<li><a href="https://twitter.com/tymwol">Timothy Wolodzko</a> for the <code>covariance()</code>, <code>correlation()</code>, and <code>linear_regression()</code> functions in the <code>statistics</code> module;</li>
<li><a href="https://twitter.com/victorstinner">Victor Stinner</a> for the <code>random.randbytes()</code> method.</li>
</ul>
]]></content:encoded></item><item><title>Storing state in the URL</title><link>https://antonz.org/storing-state/</link><pubDate>Sun, 08 May 2022 11:30:00 +0000</pubDate><guid>https://antonz.org/storing-state/</guid><description>So that the app does not reset to zero after page refresh.</description><content:encoded><![CDATA[<p>If you are developing a web application, sooner or later you will face the problem of saving the local system state for the user.</p>
<p>Imagine you sell elite potatoes over the Internet. The buyer visits the website and enters the search criteria:</p>
<ul>
<li>strictly from Bolivia or South Africa,</li>
<li>harvest of 2022,</li>
<li>tuber size from 3 to 7 cm,</li>
<li>preferably in the form of a sea seal.</li>
</ul>
<p>The buyer then receives a list of 300 items (seal-shaped potatoes are quite popular in South Africa), split into 6 pages of 50 items each. They load the third page, open the potato card and freeze in silent admiration for a few seconds. And then accidentally refresh the page. What will your application do?</p>
<p>It depends on how the application stores the filter state. Let&rsquo;s look at the options, and then consider one of them in more detail.</p>
<h2 id="how-to-store-state">How to store state</h2>
<p>JavaScript applications traditionally work with local state in the form of in-memory objects. This is convenient because it supports complex data structures without storage limits, and one does not have to deal with serialization. But will it suit our potato shop? Let&rsquo;s figure it out.</p>
<h3 id="dont-store-state-at-all">Don&rsquo;t store state at all</h3>
<p>Let&rsquo;s say you didn&rsquo;t bother to store the state and keep it in memory. Then after page reload the current context will be lost. The user will be redirected to the main page, where they will stare in disbelief at the giant &ldquo;ELITE POTATOES&rdquo; heading.</p>
<p>This is how Google calendar used to behave. No matter how you navigate around the calendar, no matter what filters you apply, the URL always stayed the same:</p>
<pre><code>https://www.google.com/calendar/render
</code></pre>
<p>Refresh the page — and the calendar happily resets to the current week. Ouch.</p>
<h3 id="store-state-locally">Store state locally</h3>
<p>Most services understand that it is not OK to lose context after page refresh. They store the state on the client side (using Web Storage, IndexedDB or other means). This solves the problem with page refreshes, but still won&rsquo;t help with bookmarking.</p>
<p>Plus, such approach creates a problem with conflicting state changes. I opened two browser tabs, went to your potato website, searched for &ldquo;young potatoes&rdquo; in the first tab and for &ldquo;bushy leaves&rdquo; in the second one. Which query will the app remember?</p>
<h3 id="store-a-set-of-url-parameters">Store a set of URL parameters</h3>
<p>Ever since the days when the dynamic nature of websites was limited to the <code>&lt;blink&gt;</code> tag, some considered a best practice to store the state in the URL (<em>URL parameters</em>, also known as <em>GET parameters</em> or <em>query string</em>). Such URL is great for emailing or bookmarking — there is no problem restoring the context:</p>
<pre><code>https://potato.shop/catalog/?search=wild+potatoes&amp;country=bo,za&amp;size=3-7&amp;page=5
</code></pre>
<p>URL state makes each browser tab completely independent. No shared data in the local storage means no conflicts. It simplifies developer&rsquo;s life, and the user does not have to scratch their head over the mysterious system glitches.</p>
<h3 id="store-serialized-state">Store serialized state</h3>
<p>URL parameters do an excellent job with scalar values (strings, numbers, booleans). But they are less suitable for collections and more complex structures. That&rsquo;s why programmers sometimes do this:</p>
<ul>
<li>represent the state in the form of a dictionary;</li>
<li>serialize it to Base64;</li>
<li>pass it as the single URL parameter.</li>
</ul>
<p>For example, for this state:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
    <span style="color:#000">&#34;search&#34;</span>: <span style="color:#c41a16">&#34;wild potatoes&#34;</span>,
    <span style="color:#000">&#34;country&#34;</span>: [<span style="color:#c41a16">&#34;bo&#34;</span>, <span style="color:#c41a16">&#34;za&#34;</span>],
    <span style="color:#000">&#34;size&#34;</span>: { <span style="color:#000">&#34;min&#34;</span>: <span style="color:#1c01ce">3</span>, <span style="color:#000">&#34;max&#34;</span>: <span style="color:#1c01ce">7</span> },
    <span style="color:#000">&#34;page&#34;</span>: <span style="color:#1c01ce">5</span>
}
</code></pre></div><p>One will get this URL:</p>
<pre><code>https://potato.shop/catalog/?state=eyJzZWFyY2giOiJ3aWxkIHBvdGF0b2VzIiwiY291bnRyeSI6WyJibyIsInphIl0sInNpemUiOnsibWluIjozLCJtYXgiOjd9LCJwYWdlIjo1fQ==
</code></pre>
<h3 id="hybrid-approaches">Hybrid approaches</h3>
<p>One can store only the main parameters in the URL, and additional ones in the local storage:</p>
<pre><code>https://potato.shop/catalog/?search=wild+potatoes&amp;page=10
</code></pre>
<p>One can pass the main parameters explicitly, and the additional ones as the serialized blob:</p>
<pre><code>https://potato.shop/catalog/?search=wild+potatoes&amp;state=eyJjb3VudHJ5IjpbImJvIiwiemEiXSwic2l6ZSI6eyJtaW4iOjMsIm1heCI6N30sInBhZ2UiOjV9
</code></pre>
<p>There are also more creative options.</p>
<p>For example, one can store the state of the potato list locally. When a visitor requests a specific potato item, open it in a new tab — to not bother restoring the list state later.</p>
<p>Or one can implement an URL shortener of sorts. Store the full state on the server, generate a unique link like <code>https://potato.shop/catalog/xKda7</code> and serve it to the client.</p>
<p>We have sorted out the options, now let&rsquo;s look at one of them in more detail.</p>
<h2 id="how-to-store-state-in-url-parameters">How to store state in URL parameters</h2>
<p>At first glance, storing the state as a set of URL parameters is all nice and easy.</p>
<p>State:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
    <span style="color:#000">&#34;search&#34;</span>: <span style="color:#c41a16">&#34;wild potatoes&#34;</span>,
    <span style="color:#000">&#34;page&#34;</span>: <span style="color:#1c01ce">5</span>
}
</code></pre></div><p>URL params (this and further examples do not use url escaping):</p>
<pre><code>?search=wild+potatoes&amp;page=5
</code></pre>
<p>Indeed, it is easy to pass strings and numbers in the parameters. It gets more interesting with other data types.</p>
<h3 id="boolean-value">Boolean value</h3>
<p>Booleans are typically passed as <code>true</code> / <code>false</code> or <code>1</code> / <code>0</code>.</p>
<p>State:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
    <span style="color:#000">&#34;search&#34;</span>: <span style="color:#c41a16">&#34;potatoes&#34;</span>,
    <span style="color:#000">&#34;popular&#34;</span>: <span style="color:#a90d91">true</span>
}
</code></pre></div><p>URL params:</p>
<pre><code>?search=potatoes&amp;popular=true
?search=potatoes&amp;popular=1
</code></pre>
<h3 id="date-and-time">Date and time</h3>
<p>Date/time typically uses <a href="https://datatracker.ietf.org/doc/html/rfc3339">RFC 3339</a> (<code>2020-01-02T10:11:12Z</code>) or <a href="https://en.wikipedia.org/wiki/Unix_time">Unix Time</a> (seconds after midnight 01/01/1970).</p>
<p>State (since the example is in JSON, I pass the date in RFC3339; your language has a native representation):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
    <span style="color:#000">&#34;search&#34;</span>: <span style="color:#c41a16">&#34;potatoes&#34;</span>,
    <span style="color:#000">&#34;after&#34;</span>: <span style="color:#c41a16">&#34;2020-01-02T10:11:12Z&#34;</span>
}
</code></pre></div><p>URL params:</p>
<pre><code>?search=potatoes&amp;after=2020-01-02T10:11:12Z
?search=potatoes&amp;after=1577959872
</code></pre>
<p>Unix time in milliseconds is less common:</p>
<pre><code>?search=potatoes&amp;after=1577959872000
</code></pre>
<h3 id="empty-value">Empty value</h3>
<p>If some property is not set, it is usually passed empty, or not passed at all.</p>
<p>State:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
    <span style="color:#000">&#34;search&#34;</span>: <span style="color:#c41a16">&#34;potatoes&#34;</span>,
    <span style="color:#000">&#34;country&#34;</span>: <span style="color:#a90d91">null</span>
}
</code></pre></div><p>URL params:</p>
<pre><code>?search=potatoes&amp;country=
?search=potatoes
</code></pre>
<p>Sometimes devs use a special empty value (e.g. <code>null</code>):</p>
<pre><code>?search=potatoes&amp;country=null
</code></pre>
<h3 id="list-array">List (array)</h3>
<p>So far we have been dealing with scalar values. It becomes more fun with lists.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
    <span style="color:#000">&#34;search&#34;</span>: <span style="color:#c41a16">&#34;potatoes&#34;</span>,
    <span style="color:#000">&#34;country&#34;</span>: [<span style="color:#c41a16">&#34;bo&#34;</span>, <span style="color:#c41a16">&#34;za&#34;</span>]
}
</code></pre></div><p>The classic option is to repeat the property name for each value, as dictated by <a href="https://datatracker.ietf.org/doc/html/rfc6570#section-2.4.2">RFC 6570</a>:</p>
<pre><code>?search=potatoes&amp;country=bo&amp;country=za
</code></pre>
<p>Sometimes a <code>[]</code> is added to stress the list nature:</p>
<pre><code>?search=potatoes&amp;country[]=bo&amp;country[]=za
</code></pre>
<p>Sometimes even with an index:</p>
<pre><code>?search=potatoes&amp;country[0]=bo&amp;country[1]=za
</code></pre>
<p>Brevity fans pass the property name once, and separate the values with a comma:</p>
<pre><code>?search=potatoes&amp;country=bo,za
</code></pre>
<h3 id="dictionary-map">Dictionary (map)</h3>
<p>A list includes a set of values. A dictionary contains nested properties:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
    <span style="color:#000">&#34;search&#34;</span>: <span style="color:#c41a16">&#34;potatoes&#34;</span>,
    <span style="color:#000">&#34;size&#34;</span>: { <span style="color:#000">&#34;min&#34;</span>: <span style="color:#1c01ce">3</span>, <span style="color:#000">&#34;max&#34;</span>: <span style="color:#1c01ce">7</span> }
}
</code></pre></div><p>Internet standards do not mention passing composite objects in the URL. So the developers have invented their own options.</p>
<p>Most often people repeat the top-level property name and pass nested property names in <code>[]</code>:</p>
<pre><code>?search=potatoes&amp;size[min]=3&amp;size[max]=7
</code></pre>
<p>Dot notation is more rare:</p>
<pre><code>?search=potatoes&amp;size.min=3&amp;size.max=7
</code></pre>
<p>Deeper nesting is not typically used. It would be very nontrivial to deserialize such URL parameters back into the object.</p>
<h2 id="summary">Summary</h2>
<p>The main ways of storing the local state are:</p>
<ul>
<li>no storage;</li>
<li>local storage;</li>
<li>URL parameters;</li>
<li>serialized blob.</li>
</ul>
<p>Memory and local storage are great for &ldquo;private&rdquo; state — settings, caches, history. URL parameters are good for the &ldquo;public&rdquo; state, so that one could bookmark or forward the stateful link. URLs with parameters are self-evident and allow one to pass rather complex data structures.</p>
<div class="row">
<div class="col-xs-12 col-sm-4">
<figure><img alt="String or number" src="state-scalar.png"></figure>
</div>
<div class="col-xs-12 col-sm-4">
<figure><img alt="Boolean value" src="state-bool.png"></figure>
</div>
<div class="col-xs-12 col-sm-4">
<figure><img alt="Date and time" src="state-date.png"></figure>
</div>
</div>
<div class="row">
<div class="col-xs-12 col-sm-4">
<figure><img alt="Empty value" src="state-empty.png"></figure>
</div>
<div class="col-xs-12 col-sm-4">
<figure><img alt="List (array)" src="state-list.png"></figure>
</div>
<div class="col-xs-12 col-sm-4">
<figure><img alt="Dictionary (map)" src="state-dict.png"></figure>
</div>
</div>
<p>Most importantly, whichever approach you choose — make sure to save and restore the context transparently for the user.</p>
]]></content:encoded></item><item><title>Generated columns in SQLite</title><link>https://antonz.org/generated-columns/</link><pubDate>Sat, 07 May 2022 17:10:00 +0000</pubDate><guid>https://antonz.org/generated-columns/</guid><description>Simplify queries without storing additional data.</description><content:encoded><![CDATA[<p>Sometimes an SQL query field is calculated based on other table columns. Imagine a table with <code>income</code> and <code>tax_rate</code> columns:</p>
<pre tabindex="0"><code>┌────────┬──────────┐
│ income │ tax_rate │
├────────┼──────────┤
│ 70     │ 0.22     │
│ 84     │ 0.22     │
│ 90     │ 0.24     │
└────────┴──────────┘
</code></pre><p>You can calculate the annual tax:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#a90d91">select</span>
  <span style="color:#000">id</span>,
  <span style="color:#000">income</span> <span style="color:#000">*</span> <span style="color:#000">tax_rate</span> <span style="color:#a90d91">as</span> <span style="color:#000">tax</span>
<span style="color:#a90d91">from</span> <span style="color:#000">people</span>;
</code></pre></div><p>In order not to repeat these calculations everywhere, it is convenient to create a virtual <em>generated column</em>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#a90d91">alter</span> <span style="color:#a90d91">table</span> <span style="color:#000">people</span>
<span style="color:#a90d91">add</span> <span style="color:#a90d91">column</span> <span style="color:#000">tax</span> <span style="color:#a90d91">real</span> <span style="color:#a90d91">as</span> (
  <span style="color:#000">income</span> <span style="color:#000">*</span> <span style="color:#000">tax_rate</span>
);
</code></pre></div><p>After that, the column can be used in queries in the same way as regular columns:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#a90d91">select</span> <span style="color:#000">id</span>, <span style="color:#000">tax</span>
<span style="color:#a90d91">from</span> <span style="color:#000">people</span>;
</code></pre></div><p>Virtual columns are not stored in the database and are calculated on the fly. But you can build an index on them to speed up data retrieval.</p>
<blockquote>
<p>Strictly speaking, SQLite has <em>virtual</em> generated columns and <em>stored</em> ones. The latter are stored on disk, but it is impossible to create them via <code>alter table</code>, so people mostly use virtual ones.</p>
</blockquote>
<p>In general, the syntax is as follows:</p>
<pre tabindex="0"><code>alter table TABLE
add column COLUMN TYPE as (EXPRESSION);
</code></pre><p>Generated column expression can include any table columns, but not other tables or subquery results. It&rsquo;s for the best: for more complex combinations, there are <em>views</em> and <em>temp tables</em>. Let&rsquo;s talk about them some other time.</p>
<p><a href="https://sqlite.org/gencol.html">Documentation</a> • <a href="https://sqlime.org/#gist:5208177f89a0e38ccfae8ead90a35631">Playground</a></p>
]]></content:encoded></item><item><title>Page iterator in Python</title><link>https://antonz.org/page-iterator/</link><pubDate>Mon, 02 May 2022 13:00:00 +0000</pubDate><guid>https://antonz.org/page-iterator/</guid><description>Traverse dataset in pages for faster batch processing.</description><content:encoded><![CDATA[<p>Suppose you are counting stats for a huge dataset of toys sold across the country over the past year:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">reader</span> <span style="color:#000">=</span> <span style="color:#000">fetch_toys</span>()
<span style="color:#a90d91">for</span> <span style="color:#000">item</span> <span style="color:#000">in</span> <span style="color:#000">reader</span>:
    <span style="color:#000">process_single</span>(<span style="color:#000">item</span>)
</code></pre></div><p><code>process_single()</code> takes 10 ms, so 400 million toys will be processed in 46 days 😱</p>
<p>After a number of intense conversations, you manage to convince the developers that it&rsquo;s not very fast. <code>process_batch()</code> function enters the scene. It processes 10,000 toys in 1 second. It means 11 hours for all the toys — much nicer.</p>
<p>Now we need to iterate over the dataset in batches of 10 thousand records. This is where the page iterator comes in handy!</p>
<h2 id="naive-paginator">Naive paginator</h2>
<p>Let&rsquo;s go through the initial sequence, gradually filling the page. As soon as it is filled, return it through <code>yield</code> and start filling in the next one. Continue until the original sequence is exhausted:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">def</span> <span style="color:#000">paginate</span>(<span style="color:#000">iterable</span>, <span style="color:#000">page_size</span>):
    <span style="color:#000">page</span> <span style="color:#000">=</span> []
    <span style="color:#a90d91">for</span> <span style="color:#000">item</span> <span style="color:#000">in</span> <span style="color:#000">iterable</span>:
        <span style="color:#000">page</span><span style="color:#000">.</span><span style="color:#000">append</span>(<span style="color:#000">item</span>)
        <span style="color:#a90d91">if</span> <span style="color:#a90d91">len</span>(<span style="color:#000">page</span>) <span style="color:#000">==</span> <span style="color:#000">page_size</span>:
            <span style="color:#a90d91">yield</span> <span style="color:#000">page</span>
            <span style="color:#000">page</span> <span style="color:#000">=</span> []
    <span style="color:#a90d91">yield</span> <span style="color:#000">page</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">reader</span> <span style="color:#000">=</span> <span style="color:#000">fetch_toys</span>()
<span style="color:#000">page_size</span> <span style="color:#000">=</span> <span style="color:#1c01ce">10_000</span>
<span style="color:#a90d91">for</span> <span style="color:#000">page</span> <span style="color:#000">in</span> <span style="color:#000">paginate</span>(<span style="color:#000">reader</span>, <span style="color:#000">page_size</span>):
    <span style="color:#000">process_batch</span>(<span style="color:#000">page</span>)
</code></pre></div><p>The implementation is working, but there is a problem. Such page-by-page traversal is noticeably slower than the one-by-one iteration.</p>
<h2 id="iteration-speed">Iteration speed</h2>
<p>Let&rsquo;s compare two traversals — one-by-one and paginated:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">def</span> <span style="color:#000">one_by_one</span>(<span style="color:#000">a</span>, <span style="color:#000">b</span>):
    <span style="color:#c41a16">&#34;&#34;&#34;Processes records one-by-one, without pagination&#34;&#34;&#34;</span>
    <span style="color:#000">rdr</span> <span style="color:#000">=</span> <span style="color:#000">reader</span>(<span style="color:#000">a</span>, <span style="color:#000">b</span>)
    <span style="color:#a90d91">for</span> <span style="color:#000">record</span> <span style="color:#000">in</span> <span style="color:#000">rdr</span>:
        <span style="color:#000">process_single</span>(<span style="color:#000">record</span>)

<span style="color:#a90d91">def</span> <span style="color:#000">batch</span>(<span style="color:#000">page_size</span>, <span style="color:#000">a</span>, <span style="color:#000">b</span>):
    <span style="color:#c41a16">&#34;&#34;&#34;Processes records in batches, with pagination&#34;&#34;&#34;</span>
    <span style="color:#000">rdr</span> <span style="color:#000">=</span> <span style="color:#000">reader</span>(<span style="color:#000">a</span>, <span style="color:#000">b</span>)
    <span style="color:#a90d91">for</span> <span style="color:#000">page</span> <span style="color:#000">in</span> <span style="color:#000">paginate</span>(<span style="color:#000">rdr</span>, <span style="color:#000">page_size</span>):
        <span style="color:#000">process_batch</span>(<span style="color:#000">page</span>)

<span style="color:#000">times</span> <span style="color:#000">=</span> <span style="color:#1c01ce">10</span>

<span style="color:#000">page_size</span> <span style="color:#000">=</span> <span style="color:#1c01ce">10_000</span>
<span style="color:#000">a</span> <span style="color:#000">=</span> <span style="color:#1c01ce">1_000_000</span>
<span style="color:#000">b</span> <span style="color:#000">=</span> <span style="color:#1c01ce">2_000_000</span>

<span style="color:#000">fn</span> <span style="color:#000">=</span> <span style="color:#a90d91">lambda</span>: <span style="color:#000">one_by_one</span>(<span style="color:#000">a</span>, <span style="color:#000">b</span>)
<span style="color:#000">total</span> <span style="color:#000">=</span> <span style="color:#000">timeit</span><span style="color:#000">.</span><span style="color:#000">timeit</span>(<span style="color:#000">fn</span>, <span style="color:#000">number</span><span style="color:#000">=</span><span style="color:#000">times</span>)
<span style="color:#000">it_time</span> <span style="color:#000">=</span> <span style="color:#a90d91">round</span>(<span style="color:#000">total</span> <span style="color:#000">*</span> <span style="color:#1c01ce">1000</span> <span style="color:#000">/</span> <span style="color:#000">times</span>)
<span style="color:#a90d91">print</span>(<span style="color:#c41a16">f</span><span style="color:#c41a16">&#34;One-by-one (baseline): </span><span style="color:#c41a16">{</span><span style="color:#000">it_time</span><span style="color:#c41a16">}</span><span style="color:#c41a16"> ms&#34;</span>)

<span style="color:#000">fn</span> <span style="color:#000">=</span> <span style="color:#a90d91">lambda</span>: <span style="color:#000">batch</span>(<span style="color:#000">page_size</span>, <span style="color:#000">a</span>, <span style="color:#000">b</span>)
<span style="color:#000">total</span> <span style="color:#000">=</span> <span style="color:#000">timeit</span><span style="color:#000">.</span><span style="color:#000">timeit</span>(<span style="color:#000">fn</span>, <span style="color:#000">number</span><span style="color:#000">=</span><span style="color:#000">times</span>)
<span style="color:#000">it_time</span> <span style="color:#000">=</span> <span style="color:#a90d91">round</span>(<span style="color:#000">total</span> <span style="color:#000">*</span> <span style="color:#1c01ce">1000</span> <span style="color:#000">/</span> <span style="color:#000">times</span>)
<span style="color:#a90d91">print</span>(<span style="color:#c41a16">f</span><span style="color:#c41a16">&#34;Fill page with append(): </span><span style="color:#c41a16">{</span><span style="color:#000">it_time</span><span style="color:#c41a16">}</span><span style="color:#c41a16"> ms&#34;</span>)
</code></pre></div><p>Here is the result for 1 million records and a page size of 10 thousand:</p>
<pre tabindex="0"><code>One-by-one (baseline):   161 ms
Fill page with append(): 227 ms
</code></pre><p>Page-by-page iteration is almost 1.5 times slower!</p>
<p>At each iteration of the loop, we create a new empty list and then gradually fill it in. Python has to constantly increase the size of the underlying array, and this is an expensive operation — O(n) of the number of elements in the list.</p>
<h2 id="fixed-page-size">Fixed page size</h2>
<p>Let&rsquo;s create a list of the required size in advance and use it for all pages:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">def</span> <span style="color:#000">paginate</span>(<span style="color:#000">iterable</span>, <span style="color:#000">page_size</span>):
    <span style="color:#000">page</span> <span style="color:#000">=</span> [<span style="color:#a90d91">None</span>] <span style="color:#000">*</span> <span style="color:#000">page_size</span>
    <span style="color:#000">idx</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>
    <span style="color:#a90d91">for</span> <span style="color:#000">item</span> <span style="color:#000">in</span> <span style="color:#000">iterable</span>:
        <span style="color:#000">page</span>[<span style="color:#000">idx</span>] <span style="color:#000">=</span> <span style="color:#000">item</span>
        <span style="color:#000">idx</span> <span style="color:#000">+=</span> <span style="color:#1c01ce">1</span>
        <span style="color:#a90d91">if</span> <span style="color:#000">idx</span> <span style="color:#000">==</span> <span style="color:#000">page_size</span>:
            <span style="color:#a90d91">yield</span> <span style="color:#000">page</span>
            <span style="color:#000">idx</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>
    <span style="color:#a90d91">yield</span> <span style="color:#000">page</span>[:<span style="color:#000">idx</span>]
</code></pre></div><p>Compare once again:</p>
<pre tabindex="0"><code>One-by-one (baseline):   161 ms
Fill page with append(): 227 ms
Use fixed-size page:     162 ms
</code></pre><p>Much faster! Fixed page algorithm is as fast as the ordinary one-by-one traversal.</p>
<h2 id="slicing-iterator">Slicing iterator</h2>
<p>Can we do even better? Algorithmically, no. But practically, yes — if we move most of the operations from Python code to C library code. The <code>itertools()</code> module and its <code>islice()</code> function may help:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">def</span> <span style="color:#000">paginate</span>(<span style="color:#000">iterable</span>, <span style="color:#000">page_size</span>):
    <span style="color:#000">it</span> <span style="color:#000">=</span> <span style="color:#a90d91">iter</span>(<span style="color:#000">iterable</span>)
    <span style="color:#000">slicer</span> <span style="color:#000">=</span> <span style="color:#a90d91">lambda</span>: <span style="color:#a90d91">list</span>(<span style="color:#000">itertools</span><span style="color:#000">.</span><span style="color:#000">islice</span>(<span style="color:#000">it</span>, <span style="color:#000">page_size</span>))
    <span style="color:#a90d91">return</span> <span style="color:#a90d91">iter</span>(<span style="color:#000">slicer</span>, [])
</code></pre></div><p>Here is what&rsquo;s going on:</p>
<ul>
<li><code>islice()</code> creates an iterator (let&rsquo;s call it a slicer) that traverses the passed sequence until it yields <code>page_size</code> elements;</li>
<li><code>list()</code> fetches elements from the slicer, thus creating a page;</li>
<li>since <code>islice()</code> runs on top of the main iterator, the next time it is called, it will continue from the same place where it left off before;</li>
<li>the <code>iter(slicer, [])</code> expression creates an iterator that calls the slicer at each step;</li>
<li>thus, the <code>paginate()</code> function returns an iterator, which at each step yields the next page through the slicer, traversing the main sequence until it ends.</li>
</ul>
<p>Look how good this implementation is:</p>
<pre tabindex="0"><code>One-by-one (baseline):   161 ms
Fill page with append(): 227 ms
Use fixed-size page:     162 ms
Use islice:               93 ms
</code></pre><p>40% faster than the one-by-one iterator!</p>
<h2 id="summary">Summary</h2>
<p>Page-by-page traversal works fine whenever a batch operation is much faster than a sequence of single operations. In order not to implement such traversal every time from scratch, it is convenient to use a <em>page iterator</em>.</p>
<p>Filling the page with <code>.append()</code> is slow due to array resizing. It is better to use a fixed-size list, or even better, iteration based on <code>itertools.islice()</code></p>
<p>Totally recommend it.</p>
<p><a href="https://replit.com/@antonz/page-iterator#main.py">Playground</a></p>
]]></content:encoded></item><item><title>Multi-line queries in SQLite shell</title><link>https://antonz.org/sqlite-multiline/</link><pubDate>Sun, 24 Apr 2022 21:30:00 +0000</pubDate><guid>https://antonz.org/sqlite-multiline/</guid><description>How to edit a big query without leaving the CLI</description><content:encoded><![CDATA[<p>Just after writing that debugging multi-line queries <a href="/sqlite-history/">in SQLite shell</a> is not easy, I discovered a cool trick on the sqlite forum:</p>
<p>Use <code>Ctrl+V</code>, <code>Ctrl+J</code> instead of <code>Enter</code> for new lines. After that, edit the query with the <code>↑</code> button.</p>
<div class="row">
<div class="col-xs-12 col-sm-7">
<figure>
  <img alt="SQLite shell" src="multiline.png" class="img-bordered-thin">
</figure>
</div>
</div>
<p>And here are some more ways to edit multi-line queries:</p>
<ul>
<li>Use external editor (<code>.shell &lt;editor&gt; &lt;file&gt;</code>)</li>
<li>Run query from file (<code>.read &lt;file&gt;</code>)</li>
<li>Consider DBeaver, DataGrip or other UI tool</li>
</ul>
]]></content:encoded></item><item><title>Caching slow functions in Python</title><link>https://antonz.org/functools-cache/</link><pubDate>Sat, 23 Apr 2022 19:10:00 +0000</pubDate><guid>https://antonz.org/functools-cache/</guid><description>With @lru_cache and @cache from the functools module</description><content:encoded><![CDATA[<p>Suppose you wrote a function that returns the user&rsquo;s email:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">def</span> <span style="color:#000">get_user_email</span>(<span style="color:#000">user_id</span>):
    <span style="color:#000">user</span> <span style="color:#000">=</span> <span style="color:#000">find_by_id</span>(<span style="color:#000">user_id</span>)
    <span style="color:#a90d91">return</span> <span style="color:#000">user</span>[<span style="color:#c41a16">&#34;email&#34;</span>]
</code></pre></div><p>But there is a problem. <code>find_by_id()</code> calls a terribly slow legacy system:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">def</span> <span style="color:#000">find_by_id</span>(<span style="color:#000">user_id</span>):
    <span style="color:#177500"># simulate a slow network request,</span>
    <span style="color:#177500"># returning a user by their id</span>
    <span style="color:#000">time</span><span style="color:#000">.</span><span style="color:#000">sleep</span>(<span style="color:#1c01ce">1</span>)
    <span style="color:#a90d91">return</span> { <span style="color:#c41a16">&#34;email&#34;</span>: <span style="color:#c41a16">&#34;...&#34;</span> }
</code></pre></div><p>100 calls for <code>get_user_email(42)</code> result in 100 slow requests. A single one should be quite enough, so let&rsquo;s attach a simple cache:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">cache</span> <span style="color:#000">=</span> {}

<span style="color:#a90d91">def</span> <span style="color:#000">get_user_email</span>(<span style="color:#000">user_id</span>):
    <span style="color:#a90d91">if</span> <span style="color:#000">user_id</span> <span style="color:#000">not</span> <span style="color:#000">in</span> <span style="color:#000">cache</span>:
        <span style="color:#000">user</span> <span style="color:#000">=</span> <span style="color:#000">find_by_id</span>(<span style="color:#000">user_id</span>)
        <span style="color:#000">cache</span>[<span style="color:#000">user_id</span>] <span style="color:#000">=</span> <span style="color:#000">user</span>[<span style="color:#c41a16">&#34;email&#34;</span>]
    <span style="color:#a90d91">return</span> <span style="color:#000">cache</span>[<span style="color:#000">user_id</span>]
</code></pre></div><p>Nothing too complicated (apart from the issue of cache expiration, let&rsquo;s not touch it). But imagine that there are a lot of slow functions, and you have to implement caching for every one of them. Not too inspiring.</p>
<p>Fortunately, there is an <code>@lru_cache</code> decorator in the <code>functools</code> module. That&rsquo;s what we need. Add one line to the original function, and be done with it:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000">@functools</span><span style="color:#000">.</span><span style="color:#000">lru_cache</span>(<span style="color:#000">maxsize</span><span style="color:#000">=</span><span style="color:#1c01ce">256</span>)
<span style="color:#a90d91">def</span> <span style="color:#000">get_user_email</span>(<span style="color:#000">user_id</span>):
    <span style="color:#000">user</span> <span style="color:#000">=</span> <span style="color:#000">find_by_id</span>(<span style="color:#000">user_id</span>)
    <span style="color:#a90d91">return</span> <span style="color:#000">user</span>[<span style="color:#c41a16">&#34;email&#34;</span>]
</code></pre></div><p>Now repeated calls to <code>get_user_email()</code> with the same <code>user_id</code> return the cached result without requesting <code>find_by_id()</code>.</p>
<div class="row">
<div class="col-xs-12 col-sm-6 col-md-5">
<figure>
  <img alt="Don't write your own cache" src="cache-1.png" class="img-bordered-thin">
  <figcaption>Don't write your own cache...</figcaption>
</figure>
</div>
<div class="col-xs-12 col-sm-6 col-md-5">
<figure>
  <img alt="Use functools @lru_cache" src="cache-2.png" class="img-bordered-thin">
  <figcaption>Use functools @lru_cache instead!</figcaption>
</figure>
</div>
</div>
<p><code>@lru_cache</code> automatically evicts old entries from the cache when there are more than <code>maxsize</code> entries. So the cache won&rsquo;t eat up all the memory.</p>
<p>Python 3.9 received another decorator — <code>@functools.cache</code>. It&rsquo;s similar to <code>@lru_cache</code>, only without the cache entry limit (which makes it work a little faster).</p>
<p>One can manage the cache — view hits/misses stats or clean it:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#177500"># cache management</span>

<span style="color:#000">stats</span> <span style="color:#000">=</span> <span style="color:#000">get_user_email</span><span style="color:#000">.</span><span style="color:#000">cache_info</span>()
<span style="color:#a90d91">print</span>(<span style="color:#000">stats</span>)
<span style="color:#177500"># CacheInfo(hits=2, misses=3, maxsize=256, currsize=3)</span>

<span style="color:#000">get_user_email</span><span style="color:#000">.</span><span style="color:#000">cache_clear</span>()
<span style="color:#177500"># CacheInfo(hits=0, misses=0, maxsize=256, currsize=0)</span>
</code></pre></div><p>The cache works in-process and will die with it. So if you need something more scalable, look at Redis or other external cache.</p>
<p><a href="https://devdocs.io/python/library/functools#functools.lru_cache">Documentation</a> •
<a href="https://replit.com/@antonz/functools-cache#main.py">Playground</a></p>
]]></content:encoded></item><item><title>SQLite CLI command history</title><link>https://antonz.org/sqlite-history/</link><pubDate>Sun, 17 Apr 2022 14:50:00 +0000</pubDate><guid>https://antonz.org/sqlite-history/</guid><description>Search for the query instead of typing it by hand.</description><content:encoded><![CDATA[<p>SQLite command line tool (<code>sqlite3</code> or <code>sqlite3.exe</code>) remembers the last 2000 executed commands. To repeat the last command, just press the <code>↑</code> key, to search for older ones — use <code>Ctrl+R</code> shortcut.</p>
<div class="row">
<div class="col-xs-12 col-sm-8">
<figure>
  <img alt="History search" src="search.jpg">
  <figcaption>It's faster to find a query than to type it again</figcaption>
</figure>
</div>
</div>
<p>By default, SQLite stores the history file in the user&rsquo;s home directory and names it <code>.sqlite_history</code>. It&rsquo;s in plain text, so you can view it in your favorite editor. If you prefer to save it elsewhere, specify the full path in the <code>SQLITE_HISTORY</code> environment variable.</p>
<div class="row">
<div class="col-xs-12 col-sm-8">
<figure>
  <img alt="History file" src="history.jpg">
  <figcaption>Sync the history file (via Dropbox etc.) to search for queries on all devices</figcaption>
</figure>
</div>
</div>
<p>SQLite writes the history to a file when the console exits normally, so in case of the computer or CLI crash the commands executed since the last <code>sqlite3</code> launch will be lost.</p>
<p>History recording is not the only feature of the console. SQLite CLI makes it easy to import and export data or work with several databases at the same time. Debugging <a href="/sqlite-multiline/">multi-line queries</a> is quite a challenge, though.</p>
]]></content:encoded></item></channel></rss>