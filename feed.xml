<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/"><channel><title>Anton Zhiyanov</title><description>Everything about SQLite, Python, open data and awesome software.</description><link>https://antonz.org/</link><image><url>https://antonz.org/assets/favicon/favicon.png</url><title>Anton Zhiyanov</title><link>https://antonz.org/</link></image><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Wed, 08 Feb 2023 13:30:00 +0000</lastBuildDate><atom:link href="https://antonz.org/index.xml" rel="self" type="application/rss+xml"/><item><title>SQL Window Functions: Ranking</title><link>https://antonz.org/sql-window-functions-ranking/</link><pubDate>Wed, 08 Feb 2023 13:30:00 +0000</pubDate><guid>https://antonz.org/sql-window-functions-ranking/</guid><description>Making ratings and dividing data into partitions.</description><content:encoded><![CDATA[<p><em>This is an excerpt from my book <a href="/sql-window-functions-book">SQL Window Functions Explained</a>. The book is a clear and visual introduction to the topic with lots of practical exercises.</em></p>
<p>Ranking means coming up with all kinds of ratings, starting from the winners of the World Swimming Championships and ending with the Forbes 500.</p>
<p>We will rank records from the toy <code>employees</code> table:</p>
<pre tabindex="0"><code>┌────┬───────┬────────┬────────────┬────────┐
│ id │ name  │  city  │ department │ salary │
├────┼───────┼────────┼────────────┼────────┤
│ 11 │ Diane │ London │ hr         │ 70     │
│ 12 │ Bob   │ London │ hr         │ 78     │
│ 21 │ Emma  │ London │ it         │ 84     │
│ 22 │ Grace │ Berlin │ it         │ 90     │
│ 23 │ Henry │ London │ it         │ 104    │
│ 24 │ Irene │ Berlin │ it         │ 104    │
│ 25 │ Frank │ Berlin │ it         │ 120    │
│ 31 │ Cindy │ Berlin │ sales      │ 96     │
│ 32 │ Dave  │ London │ sales      │ 96     │
│ 33 │ Alice │ Berlin │ sales      │ 100    │
└────┴───────┴────────┴────────────┴────────┘
</code></pre><p><a href="https://sqlime.org/#employees.db">playground</a> • <a href="/sql-window-functions-book/employees.sql">download</a></p>
<p>Table of contents:</p>
<ul>
<li><a href="#salary-rating">Salary rating</a></li>
<li><a href="#window-ordering-vs-result-ordering">Window ordering vs. result ordering</a></li>
<li><a href="#sorting-uniqueness">Sorting uniqueness</a></li>
<li><a href="#salary-rating-by-department">​​Salary rating by department</a></li>
<li><a href="#salary-groups">Salary groups</a></li>
<li><a href="#ranking-functions">Ranking functions</a></li>
<li><a href="#keep-it-up">Keep it up</a></li>
</ul>
<div class="boxed">
<h3>Databases</h3>
<p>All modern relational databases support window functions to some extent. I tested this article on three of them:</p>
<ul>
  <li>MySQL 8.0.2+ (MariaDB 10.2+)</li>
  <li>PostgreSQL 11+</li>
  <li>SQLite 3.28+</li>
</ul>
<p>Windows are fully implemented in PostgreSQL, and almost fully in SQLite. MySQL has all the core features but lacks some of the advanced ones.</p>
<p>Oracle 11g+, MS SQL 2012+, and Google BigQuery are also fine. They lack certain advanced capabilities, just like MySQL. If you use one of them — the article will also be helpful.</p>
<p>You can use any of the mentioned DBMS if you have one available. Or an <a href="https://sqlime.org/#employees.db">online playground</a>.</p>
</div>
<h2 id="salary-rating">Salary rating</h2>
<p>Let&rsquo;s make an employee rating by salary:</p>
<div class="row">
<div class="col-xs-12 col-sm-5">
    before<br/>
    <figure><img src="before.png" width="300" alt="Before ranking"/></figure>
</div>
<div class="col-xs-12 col-sm-5">
    after<br/>
    <figure><img src="rank-after.png" width="300" alt="After ranking"/></figure>
</div>
</div>
<p>Note that employees with the same salary received the same rank (Henry and Irene, Cindy and Dave).</p>
<p>How do we go from &ldquo;before&rdquo; to &ldquo;after&rdquo;?</p>
<p>First, let&rsquo;s sort the table in descending order of salary:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#a90d91">select</span>
  <span style="color:#a90d91">null</span> <span style="color:#a90d91">as</span> <span style="color:#c41a16">&#34;rank&#34;</span>,
  <span style="color:#000">name</span>, <span style="color:#000">department</span>, <span style="color:#000">salary</span>
<span style="color:#a90d91">from</span> <span style="color:#000">employees</span>
<span style="color:#a90d91">order</span> <span style="color:#a90d91">by</span> <span style="color:#000">salary</span> <span style="color:#a90d91">desc</span>, <span style="color:#000">id</span>;
</code></pre></div><pre tabindex="0"><code>┌──────┬───────┬────────────┬────────┐
│ rank │ name  │ department │ salary │
├──────┼───────┼────────────┼────────┤
│      │ Frank │ it         │ 120    │
│      │ Henry │ it         │ 104    │
│      │ Irene │ it         │ 104    │
│      │ Alice │ sales      │ 100    │
│      │ Cindy │ sales      │ 96     │
│      │ Dave  │ sales      │ 96     │
│      │ Grace │ it         │ 90     │
│      │ Emma  │ it         │ 84     │
│      │ Bob   │ hr         │ 78     │
│      │ Diane │ hr         │ 70     │
└──────┴───────┴────────────┴────────┘
</code></pre><p>Now let&rsquo;s go from the first row to the last and calculate the rank of each record. We will start with one and increase the rank every time the salary value is less than the previous one:</p>
<div class="row">
<div class="col-xs-12 col-sm-5">
    ➀<br/>
    <figure><img src="rank/03.png" width="300" alt="Ranking step #1"/></figure>
</div>
<div class="col-xs-12 col-sm-5">
    ➁<br/>
    <figure><img src="rank/04.png" width="300" alt="Ranking step #2"/></figure>
</div>
</div>
<div class="row">
<div class="col-xs-12 col-sm-5">
    ➂<br/>
    <figure><img src="rank/05.png" width="300" alt="Ranking step #3"/></figure>
</div>
<div class="col-xs-12 col-sm-5">
    ➃<br/>
    <figure><img src="rank/06.png" width="300" alt="Ranking step #4"/></figure>
</div>
</div>
<div class="row">
<div class="col-xs-12 col-sm-5">
    ➄<br/>
    <figure><img src="rank/07.png" width="300" alt="Ranking step #5"/></figure>
</div>
<div class="col-xs-12 col-sm-5">
    <p>and so on...</p>
</div>
</div>
<p>To compute the rank, at each step we will look at the <code>salary</code> values, highlighted with a blue frame. Let&rsquo;s call these values a <em>window</em>.</p>
<p>Let&rsquo;s describe the window contents in plain English:</p>
<ol>
<li>These are the values of the salary column.</li>
<li>They are ordered from larger to smaller values.</li>
</ol>
<p>Let&rsquo;s express it in SQL:</p>
<pre tabindex="0"><code>window w as (order by salary desc)
</code></pre><ul>
<li><code>window</code> — a keyword announcing that the window definition will follow;</li>
<li><code>w</code> — the name of the window (could be anything);</li>
<li><code>(order by salary desc)</code> — the window definition (&ldquo;values of the salary column in descending order&rdquo;).</li>
</ul>
<p>Our goal is to calculate the rank over the window <code>w</code>. In SQL, this is written as <code>dense_rank() over w</code>.</p>
<p><code>dense_rank()</code> is a <em>window function</em> that counts the rank over the specified <em>window</em>. The logic of <code>dense_rank()</code> is the same as when we counted manually — start with one and increase the rank every time the next window value differs from the previous one.</p>
<p>Let&rsquo;s add the window definition and the window function to the original query:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#a90d91">select</span>
  <span style="color:#000">dense_rank</span>() <span style="color:#000">over</span> <span style="color:#000">w</span> <span style="color:#a90d91">as</span> <span style="color:#c41a16">&#34;rank&#34;</span>,
  <span style="color:#000">name</span>, <span style="color:#000">department</span>, <span style="color:#000">salary</span>
<span style="color:#a90d91">from</span> <span style="color:#000">employees</span>
<span style="color:#000">window</span> <span style="color:#000">w</span> <span style="color:#a90d91">as</span> (<span style="color:#a90d91">order</span> <span style="color:#a90d91">by</span> <span style="color:#000">salary</span> <span style="color:#a90d91">desc</span>)
<span style="color:#a90d91">order</span> <span style="color:#a90d91">by</span> <span style="color:#c41a16">&#34;rank&#34;</span>, <span style="color:#000">id</span>;
</code></pre></div><pre tabindex="0"><code>┌──────┬───────┬────────────┬────────┐
│ rank │ name  │ department │ salary │
├──────┼───────┼────────────┼────────┤
│ 1    │ Frank │ it         │ 120    │
│ 2    │ Henry │ it         │ 104    │
│ 2    │ Irene │ it         │ 104    │
│ 3    │ Alice │ sales      │ 100    │
│ 4    │ Cindy │ sales      │ 96     │
│ 4    │ Dave  │ sales      │ 96     │
│ 5    │ Grace │ it         │ 90     │
│ 6    │ Emma  │ it         │ 84     │
│ 7    │ Bob   │ hr         │ 78     │
│ 8    │ Diane │ hr         │ 70     │
└──────┴───────┴────────────┴────────┘
</code></pre><p>Here&rsquo;s how the engine executes this query:</p>
<ol>
<li>Take the table specified in <code>from</code>.</li>
<li>Select all records from it.</li>
<li>Calculate the value of <code>dense_rank()</code> for each record using the window <code>w</code>.</li>
<li>Sort the result as specified in <code>order by</code>.</li>
</ol>
<p>Here&rsquo;s an animation of how the engine executes step 3, where the rank is assigned:</p>
<div class="row">
<div class="col-xs-12 col-sm-5">
<figure>
  <img src="rank.gif" width="300" alt="Ranking animation"/>
</figure>
</div>
</div>
<p>The <code>window</code> clause itself does not affect query results. It only defines the window that we can use in the query. If we remove the <code>dense_rank()</code> call, the query will work as if there is no window:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#a90d91">select</span>
  <span style="color:#a90d91">null</span> <span style="color:#a90d91">as</span> <span style="color:#c41a16">&#34;rank&#34;</span>,
  <span style="color:#000">name</span>, <span style="color:#000">department</span>, <span style="color:#000">salary</span>
<span style="color:#a90d91">from</span> <span style="color:#000">employees</span>
<span style="color:#000">window</span> <span style="color:#000">w</span> <span style="color:#a90d91">as</span> (<span style="color:#a90d91">order</span> <span style="color:#a90d91">by</span> <span style="color:#000">salary</span> <span style="color:#a90d91">desc</span>)
<span style="color:#a90d91">order</span> <span style="color:#a90d91">by</span> <span style="color:#000">salary</span> <span style="color:#a90d91">desc</span>, <span style="color:#000">id</span>;
</code></pre></div><pre tabindex="0"><code>┌──────┬───────┬────────────┬────────┐
│ rank │ name  │ department │ salary │
├──────┼───────┼────────────┼────────┤
│      │ Frank │ it         │ 120    │
│      │ Henry │ it         │ 104    │
│      │ Irene │ it         │ 104    │
│      │ Alice │ sales      │ 100    │
│      │ Cindy │ sales      │ 96     │
│      │ Dave  │ sales      │ 96     │
│      │ Grace │ it         │ 90     │
│      │ Emma  │ it         │ 84     │
│      │ Bob   │ hr         │ 78     │
│      │ Diane │ hr         │ 70     │
└──────┴───────┴────────────┴────────┘
</code></pre><p>The window starts working only when a window function in <code>select</code> uses it.</p>
<hr>
<p><strong>Window queries in Oracle and MS SQL Server databases</strong></p>
<p>Neither Oracle nor SQL Server support the <code>window</code> clause. To make a window query work in these databases, move the window definition inside the <code>over</code> clause.</p>
<p>Instead of this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#a90d91">select</span>
  <span style="color:#000">dense_rank</span>() <span style="color:#000">over</span> <span style="color:#000">w</span> <span style="color:#a90d91">as</span> <span style="color:#c41a16">&#34;rank&#34;</span>,
  <span style="color:#000">name</span>, <span style="color:#000">department</span>, <span style="color:#000">salary</span>
<span style="color:#a90d91">from</span> <span style="color:#000">employees</span>
<span style="color:#000">window</span> <span style="color:#000">w</span> <span style="color:#a90d91">as</span> (<span style="color:#a90d91">order</span> <span style="color:#a90d91">by</span> <span style="color:#000">salary</span> <span style="color:#a90d91">desc</span>)
<span style="color:#a90d91">order</span> <span style="color:#a90d91">by</span> <span style="color:#c41a16">&#34;rank&#34;</span>, <span style="color:#000">id</span>;
</code></pre></div><p>Do this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#a90d91">select</span>
  <span style="color:#000">dense_rank</span>() <span style="color:#000">over</span> (
    <span style="color:#a90d91">order</span> <span style="color:#a90d91">by</span> <span style="color:#000">salary</span> <span style="color:#a90d91">desc</span>
  ) <span style="color:#a90d91">as</span> <span style="color:#c41a16">&#34;rank&#34;</span>,
  <span style="color:#000">name</span>, <span style="color:#000">department</span>, <span style="color:#000">salary</span>
<span style="color:#a90d91">from</span> <span style="color:#000">employees</span>
<span style="color:#a90d91">order</span> <span style="color:#a90d91">by</span> <span style="color:#c41a16">&#34;rank&#34;</span>, <span style="color:#000">id</span>;
</code></pre></div><hr>
<h2 id="window-ordering-vs-result-ordering">Window ordering vs. result ordering</h2>
<p>People often have questions about window sorting. Let&rsquo;s break them down.</p>
<p>Here is a query that calculates a salary rating:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#a90d91">select</span>
  <span style="color:#000">dense_rank</span>() <span style="color:#000">over</span> <span style="color:#000">w</span> <span style="color:#a90d91">as</span> <span style="color:#c41a16">&#34;rank&#34;</span>,
  <span style="color:#000">name</span>, <span style="color:#000">department</span>, <span style="color:#000">salary</span>
<span style="color:#a90d91">from</span> <span style="color:#000">employees</span>
<span style="color:#000">window</span> <span style="color:#000">w</span> <span style="color:#a90d91">as</span> (<span style="color:#a90d91">order</span> <span style="color:#a90d91">by</span> <span style="color:#000">salary</span> <span style="color:#a90d91">desc</span>)
<span style="color:#a90d91">order</span> <span style="color:#a90d91">by</span> <span style="color:#c41a16">&#34;rank&#34;</span>, <span style="color:#000">id</span>;
</code></pre></div><pre tabindex="0"><code>┌──────┬───────┬────────────┬────────┐
│ rank │ name  │ department │ salary │
├──────┼───────┼────────────┼────────┤
│ 1    │ Frank │ it         │ 120    │
│ 2    │ Henry │ it         │ 104    │
│ 2    │ Irene │ it         │ 104    │
│ 3    │ Alice │ sales      │ 100    │
│ 4    │ Cindy │ sales      │ 96     │
│ 4    │ Dave  │ sales      │ 96     │
│ 5    │ Grace │ it         │ 90     │
│ 6    │ Emma  │ it         │ 84     │
│ 7    │ Bob   │ hr         │ 78     │
│ 8    │ Diane │ hr         │ 70     │
└──────┴───────┴────────────┴────────┘
</code></pre><p>Let&rsquo;s leave the <code>order by</code> in the window but remove it from the main query:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#a90d91">select</span>
  <span style="color:#000">dense_rank</span>() <span style="color:#000">over</span> <span style="color:#000">w</span> <span style="color:#a90d91">as</span> <span style="color:#c41a16">&#34;rank&#34;</span>,
  <span style="color:#000">name</span>, <span style="color:#000">department</span>, <span style="color:#000">salary</span>
<span style="color:#a90d91">from</span> <span style="color:#000">employees</span>
<span style="color:#000">window</span> <span style="color:#000">w</span> <span style="color:#a90d91">as</span> (<span style="color:#a90d91">order</span> <span style="color:#a90d91">by</span> <span style="color:#000">salary</span> <span style="color:#a90d91">desc</span>);
</code></pre></div><p>Nothing has changed:</p>
<pre tabindex="0"><code>┌──────┬───────┬────────────┬────────┐
│ rank │ name  │ department │ salary │
├──────┼───────┼────────────┼────────┤
│ 1    │ Frank │ it         │ 120    │
│ 2    │ Henry │ it         │ 104    │
│ 2    │ Irene │ it         │ 104    │
│ 3    │ Alice │ sales      │ 100    │
│ 4    │ Cindy │ sales      │ 96     │
│ 4    │ Dave  │ sales      │ 96     │
│ 5    │ Grace │ it         │ 90     │
│ 6    │ Emma  │ it         │ 84     │
│ 7    │ Bob   │ hr         │ 78     │
│ 8    │ Diane │ hr         │ 70     │
└──────┴───────┴────────────┴────────┘
</code></pre><p>So why use <code>order by</code> in the main query?</p>
<p>The window&rsquo;s <code>order by</code> defines the window sorting, while the main query&rsquo;s <code>order by</code> defines the final result sorting after the rest of the query is complete.</p>
<p>Let&rsquo;s say we want to assign a rank in descending order of salary but sort in the opposite, ascending order:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#a90d91">select</span>
  <span style="color:#000">dense_rank</span>() <span style="color:#000">over</span> <span style="color:#000">w</span> <span style="color:#a90d91">as</span> <span style="color:#c41a16">&#34;rank&#34;</span>,
  <span style="color:#000">name</span>, <span style="color:#000">department</span>, <span style="color:#000">salary</span>
<span style="color:#a90d91">from</span> <span style="color:#000">employees</span>
<span style="color:#000">window</span> <span style="color:#000">w</span> <span style="color:#a90d91">as</span> (<span style="color:#a90d91">order</span> <span style="color:#a90d91">by</span> <span style="color:#000">salary</span> <span style="color:#a90d91">desc</span>)
<span style="color:#a90d91">order</span> <span style="color:#a90d91">by</span> <span style="color:#000">salary</span> <span style="color:#a90d91">asc</span>;
</code></pre></div><pre tabindex="0"><code>┌──────┬───────┬────────────┬────────┐
│ rank │ name  │ department │ salary │
├──────┼───────┼────────────┼────────┤
│ 8    │ Diane │ hr         │ 70     │
│ 7    │ Bob   │ hr         │ 78     │
│ 6    │ Emma  │ it         │ 84     │
│ 5    │ Grace │ it         │ 90     │
│ 4    │ Cindy │ sales      │ 96     │
│ 4    │ Dave  │ sales      │ 96     │
│ 3    │ Alice │ sales      │ 100    │
│ 2    │ Henry │ it         │ 104    │
│ 2    │ Irene │ it         │ 104    │
│ 1    │ Frank │ it         │ 120    │
└──────┴───────┴────────────┴────────┘
</code></pre><p>As you can see, the rank is assigned according to the window sorting (<code>salary desc</code>), and the results are ordered according to the main query sorting (<code>salary asc</code>).</p>
<p>If the query&rsquo;s <code>order by</code> clause is not specified, the result order is undefined. Sometimes it might work out (as in the example with the ascending salary ranking), and sometimes it might not. It&rsquo;s not worth relying on luck, so always specify the order of results explicitly.</p>
<h2 id="sorting-uniqueness">Sorting uniqueness</h2>
<p>Another popular question is why to include the <code>id</code> column in the result ordering:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#a90d91">select</span>
  <span style="color:#000">dense_rank</span>() <span style="color:#000">over</span> <span style="color:#000">w</span> <span style="color:#a90d91">as</span> <span style="color:#c41a16">&#34;rank&#34;</span>,
  <span style="color:#000">name</span>, <span style="color:#000">department</span>, <span style="color:#000">salary</span>
<span style="color:#a90d91">from</span> <span style="color:#000">employees</span>
<span style="color:#000">window</span> <span style="color:#000">w</span> <span style="color:#a90d91">as</span> (<span style="color:#a90d91">order</span> <span style="color:#a90d91">by</span> <span style="color:#000">salary</span> <span style="color:#a90d91">desc</span>)
<span style="color:#a90d91">order</span> <span style="color:#a90d91">by</span> <span style="color:#c41a16">&#34;rank&#34;</span>, <span style="color:#000">id</span>;
</code></pre></div><pre tabindex="0"><code>┌──────┬───────┬────────────┬────────┐
│ rank │ name  │ department │ salary │
├──────┼───────┼────────────┼────────┤
│ 1    │ Frank │ it         │ 120    │
│ 2    │ Henry │ it         │ 104    │
│ 2    │ Irene │ it         │ 104    │
│ 3    │ Alice │ sales      │ 100    │
│ 4    │ Cindy │ sales      │ 96     │
│ 4    │ Dave  │ sales      │ 96     │
│ 5    │ Grace │ it         │ 90     │
│ 6    │ Emma  │ it         │ 84     │
│ 7    │ Bob   │ hr         │ 78     │
│ 8    │ Diane │ hr         │ 70     │
└──────┴───────┴────────────┴────────┘
</code></pre><p>Why use <code>order by rank, id</code> instead of <code>order by rank</code>? To know how to sort employees with the same rank. Without the <code>id</code>, the order of records &ldquo;Henry-Irene&rdquo; and &ldquo;Cindy-Dave&rdquo; is undefined, and the DB engine can arrange them in any order. But with the <code>id</code>, everything is clear: &ldquo;Henry, then Irene&rdquo; and &ldquo;Cindy, then Dave&rdquo;.</p>
<div class="boxed">
<h3>✎ Exercise: Ranking by name</h3>
<p>Practice is crucial in turning abstract knowledge into skills, making theory alone insufficient. The book, unlike this article, contains a lot of exercises; that's why I recommend <a href="https://antonz.gumroad.com/l/sql-windows">getting it</a>.</p>
<p>If you are okay with just theory for now, though — let's continue.</p>
</div>
<h2 id="salary-rating-by-department">​​Salary rating by department</h2>
<p>Let&rsquo;s make an employee salary rating independently for each department:</p>
<div class="row">
<div class="col-xs-12 col-sm-5">
    before<br/>
    <figure><img src="before.png" width="300" alt="Before partitioned ranking"/></figure>
</div>
<div class="col-xs-12 col-sm-5">
    after<br/>
    <figure><img src="partition-after.png" width="300" alt="After partitioned ranking"/></figure>
</div>
</div>
<p>How do we go from &ldquo;before&rdquo; to &ldquo;after&rdquo;?</p>
<p>First, let&rsquo;s sort the table by department. Within the same department, let&rsquo;s sort in descending order of salary:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#a90d91">select</span>
  <span style="color:#a90d91">null</span> <span style="color:#a90d91">as</span> <span style="color:#c41a16">&#34;rank&#34;</span>,
  <span style="color:#000">name</span>, <span style="color:#000">department</span>, <span style="color:#000">salary</span>
<span style="color:#a90d91">from</span> <span style="color:#000">employees</span>
<span style="color:#a90d91">order</span> <span style="color:#a90d91">by</span> <span style="color:#000">department</span>, <span style="color:#000">salary</span> <span style="color:#a90d91">desc</span>, <span style="color:#000">id</span>;
</code></pre></div><pre tabindex="0"><code>┌──────┬───────┬────────────┬────────┐
│ rank │ name  │ department │ salary │
├──────┼───────┼────────────┼────────┤
│      │ Bob   │ hr         │ 78     │
│      │ Diane │ hr         │ 70     │
│      │ Frank │ it         │ 120    │
│      │ Henry │ it         │ 104    │
│      │ Irene │ it         │ 104    │
│      │ Grace │ it         │ 90     │
│      │ Emma  │ it         │ 84     │
│      │ Alice │ sales      │ 100    │
│      │ Cindy │ sales      │ 96     │
│      │ Dave  │ sales      │ 96     │
└──────┴───────┴────────────┴────────┘
</code></pre><p>Now let&rsquo;s go from the first row to the last and calculate the rank of each record. We will start with one and increase the rank every time the <code>salary</code> value is less than the previous one. When switching between departments, we will reset the rank back to 1:</p>
<div class="row">
<div class="col-xs-12 col-sm-5">
    ➀<br/>
    <figure><img src="partition/03.png" width="300" alt="Partitioned ranking step #1"/></figure>
</div>
<div class="col-xs-12 col-sm-5">
    ➁<br/>
    <figure><img src="partition/04.png" width="300" alt="Partitioned ranking step #2"/></figure>
</div>
</div>
<div class="row">
<div class="col-xs-12 col-sm-5">
    ➂<br/>
    <figure><img src="partition/05.png" width="300" alt="Partitioned ranking step #3"/></figure>
</div>
<div class="col-xs-12 col-sm-5">
    ➃<br/>
    <figure><img src="partition/06.png" width="300" alt="Partitioned ranking step #4"/></figure>
</div>
</div>
<div class="row">
<div class="col-xs-12 col-sm-5">
    ➄<br/>
    <figure><img src="partition/07.png" width="300" alt="Partitioned ranking step #5"/></figure>
</div>
<div class="col-xs-12 col-sm-5">
    <p>and so on...</p>
</div>
</div>
<p>To compute the rank, at each step we will look at the <code>salary</code> values, highlighted with a blue frame. It is the <em>window</em> in this case.</p>
<p>The window changes depending on which department the current record belongs to. Let&rsquo;s describe it in plain English:</p>
<ol>
<li>The window is split into several independent partitions — one for each department.</li>
<li>Inside each partition, records are ordered by decreasing salary.</li>
</ol>
<p>Let&rsquo;s express it in SQL:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#000">window</span> <span style="color:#000">w</span> <span style="color:#a90d91">as</span> (
  <span style="color:#000">partition</span> <span style="color:#a90d91">by</span> <span style="color:#000">department</span>
  <span style="color:#a90d91">order</span> <span style="color:#a90d91">by</span> <span style="color:#000">salary</span> <span style="color:#a90d91">desc</span>
)
</code></pre></div><ul>
<li><code>partition by department</code> specifies how to split the window into partitions;</li>
<li><code>order by salary desc</code> sets the sorting within the partition.</li>
</ul>
<p>The rank calculation function remains the same — <code>dense_rank()</code>.</p>
<p>Let&rsquo;s add the window definition and the window function to the original query:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#a90d91">select</span>
  <span style="color:#000">dense_rank</span>() <span style="color:#000">over</span> <span style="color:#000">w</span> <span style="color:#a90d91">as</span> <span style="color:#c41a16">&#34;rank&#34;</span>,
  <span style="color:#000">name</span>, <span style="color:#000">department</span>, <span style="color:#000">salary</span>
<span style="color:#a90d91">from</span> <span style="color:#000">employees</span>
<span style="color:#000">window</span> <span style="color:#000">w</span> <span style="color:#a90d91">as</span> (
  <span style="color:#000">partition</span> <span style="color:#a90d91">by</span> <span style="color:#000">department</span>
  <span style="color:#a90d91">order</span> <span style="color:#a90d91">by</span> <span style="color:#000">salary</span> <span style="color:#a90d91">desc</span>
)
<span style="color:#a90d91">order</span> <span style="color:#a90d91">by</span> <span style="color:#000">department</span>, <span style="color:#c41a16">&#34;rank&#34;</span>, <span style="color:#000">id</span>;
</code></pre></div><pre tabindex="0"><code>┌──────┬───────┬────────────┬────────┐
│ rank │ name  │ department │ salary │
├──────┼───────┼────────────┼────────┤
│ 1    │ Bob   │ hr         │ 78     │
│ 2    │ Diane │ hr         │ 70     │
├──────┼───────┼────────────┼────────┤
│ 1    │ Frank │ it         │ 120    │
│ 2    │ Henry │ it         │ 104    │
│ 2    │ Irene │ it         │ 104    │
│ 3    │ Grace │ it         │ 90     │
│ 4    │ Emma  │ it         │ 84     │
├──────┼───────┼────────────┼────────┤
│ 1    │ Alice │ sales      │ 100    │
│ 2    │ Cindy │ sales      │ 96     │
│ 2    │ Dave  │ sales      │ 96     │
└──────┴───────┴────────────┴────────┘
</code></pre><p><em>I&rsquo;ve manually added the separators between departments for clarity</em></p>
<p>Here&rsquo;s an animation showing how the engine calculates the rank for each record:</p>
<div class="row">
<div class="col-xs-12 col-sm-5">
<figure>
    <img src="partition.gif" width="300" alt="Partitioned ranking animation"/>
</figure>
</div>
</div>
<div class="boxed">
<h3>✎ Exercise: Salary rating by city</h3>
<p>Practice is crucial in turning abstract knowledge into skills, making theory alone insufficient. The book, unlike this article, contains a lot of exercises; that's why I recommend <a href="https://antonz.gumroad.com/l/sql-windows">getting it</a>.</p>
<p>If you are okay with just theory for now, though — let's continue.</p>
</div>
<h2 id="salary-groups">Salary groups</h2>
<p>Let&rsquo;s divide the employees into three groups depending on the size of the salary:</p>
<ul>
<li>high-paid,</li>
<li>medium-paid,</li>
<li>low-paid.</li>
</ul>
<div class="row">
<div class="col-xs-12 col-sm-5">
    before<br/>
    <figure><img src="before.png" width="300" alt="Before tiles"/></figure>
</div>
<div class="col-xs-12 col-sm-5">
    after<br/>
    <figure><img src="ntile-after.png" width="300" alt="After tiles"/></figure>
</div>
</div>
<p>How do we go from &ldquo;before&rdquo; to &ldquo;after&rdquo;?</p>
<p>First, let&rsquo;s sort the table in descending order of salary:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#a90d91">select</span>
  <span style="color:#a90d91">null</span> <span style="color:#a90d91">as</span> <span style="color:#000">tile</span>,
  <span style="color:#000">name</span>, <span style="color:#000">department</span>, <span style="color:#000">salary</span>
<span style="color:#a90d91">from</span> <span style="color:#000">employees</span>
<span style="color:#a90d91">order</span> <span style="color:#a90d91">by</span> <span style="color:#000">salary</span> <span style="color:#a90d91">desc</span>, <span style="color:#000">id</span>;
</code></pre></div><pre tabindex="0"><code>┌──────┬───────┬────────────┬────────┐
│ tile │ name  │ department │ salary │
├──────┼───────┼────────────┼────────┤
│      │ Frank │ it         │ 120    │
│      │ Henry │ it         │ 104    │
│      │ Irene │ it         │ 104    │
│      │ Alice │ sales      │ 100    │
│      │ Cindy │ sales      │ 96     │
│      │ Dave  │ sales      │ 96     │
│      │ Grace │ it         │ 90     │
│      │ Emma  │ it         │ 84     │
│      │ Bob   │ hr         │ 78     │
│      │ Diane │ hr         │ 70     │
└──────┴───────┴────────────┴────────┘
</code></pre><p>There are 10 records and 3 groups — which means two groups of 3 records and one of 4 records. For example:</p>
<pre tabindex="0"><code>┌──────┬───────┬────────────┬────────┐
│ tile │ name  │ department │ salary │
├──────┼───────┼────────────┼────────┤
│      │ Frank │ it         │ 120    │
│      │ Henry │ it         │ 104    │
│      │ Irene │ it         │ 104    │
│      │ Alice │ sales      │ 100    │
├──────┼───────┼────────────┼────────┤
│      │ Cindy │ sales      │ 96     │
│      │ Dave  │ sales      │ 96     │
│      │ Grace │ it         │ 90     │
├──────┼───────┼────────────┼────────┤
│      │ Emma  │ it         │ 84     │
│      │ Bob   │ hr         │ 78     │
│      │ Diane │ hr         │ 70     │
└──────┴───────┴────────────┴────────┘
</code></pre><p>To draw the boundaries between the groups, we must analyze all the salaries, sorted in descending order. Therefore, the window is the same as we used for salary rating:</p>
<pre tabindex="0"><code>window w as (order by salary desc)
</code></pre><p>But the function is different — <code>ntile(n)</code>, where <code>n</code> is the number of groups. In our case <code>n = 3</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#a90d91">select</span>
  <span style="color:#000">ntile</span>(<span style="color:#1c01ce">3</span>) <span style="color:#000">over</span> <span style="color:#000">w</span> <span style="color:#a90d91">as</span> <span style="color:#000">tile</span>,
  <span style="color:#000">name</span>, <span style="color:#000">department</span>, <span style="color:#000">salary</span>
<span style="color:#a90d91">from</span> <span style="color:#000">employees</span>
<span style="color:#000">window</span> <span style="color:#000">w</span> <span style="color:#a90d91">as</span> (<span style="color:#a90d91">order</span> <span style="color:#a90d91">by</span> <span style="color:#000">salary</span> <span style="color:#a90d91">desc</span>)
<span style="color:#a90d91">order</span> <span style="color:#a90d91">by</span> <span style="color:#000">salary</span> <span style="color:#a90d91">desc</span>, <span style="color:#000">id</span>;
</code></pre></div><pre tabindex="0"><code>┌──────┬───────┬────────────┬────────┐
│ tile │ name  │ department │ salary │
├──────┼───────┼────────────┼────────┤
│ 1    │ Frank │ it         │ 120    │
│ 1    │ Henry │ it         │ 104    │
│ 1    │ Irene │ it         │ 104    │
│ 1    │ Alice │ sales      │ 100    │
├──────┼───────┼────────────┼────────┤
│ 2    │ Cindy │ sales      │ 96     │
│ 2    │ Dave  │ sales      │ 96     │
│ 2    │ Grace │ it         │ 90     │
├──────┼───────┼────────────┼────────┤
│ 3    │ Emma  │ it         │ 84     │
│ 3    │ Bob   │ hr         │ 78     │
│ 3    │ Diane │ hr         │ 70     │
└──────┴───────┴────────────┴────────┘
</code></pre><p><em>I&rsquo;ve manually added the separators between groups for clarity</em></p>
<p><code>ntile(n)</code> splits all records into <code>n</code> groups and returns the group number for each record. If the total number of records (10 in our case) is not divisible by the group size (3), then the former groups will be larger than the latter.</p>
<p><code>ntile()</code> always tries to split the data so that the groups are of the same size. So records with the same salary value may end up in different (adjacent) groups:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#a90d91">select</span>
  <span style="color:#000">ntile</span>(<span style="color:#1c01ce">2</span>) <span style="color:#000">over</span> <span style="color:#000">w</span> <span style="color:#a90d91">as</span> <span style="color:#000">tile</span>,
  <span style="color:#000">name</span>, <span style="color:#000">department</span>, <span style="color:#000">salary</span>
<span style="color:#a90d91">from</span> <span style="color:#000">employees</span>
<span style="color:#000">window</span> <span style="color:#000">w</span> <span style="color:#a90d91">as</span> (<span style="color:#a90d91">order</span> <span style="color:#a90d91">by</span> <span style="color:#000">salary</span> <span style="color:#a90d91">desc</span>, <span style="color:#000">id</span>)
<span style="color:#a90d91">order</span> <span style="color:#a90d91">by</span> <span style="color:#000">salary</span> <span style="color:#a90d91">desc</span>, <span style="color:#000">tile</span>;
</code></pre></div><pre tabindex="0"><code>┌──────┬───────┬────────────┬────────┐
│ tile │ name  │ department │ salary │
├──────┼───────┼────────────┼────────┤
│ 1    │ Frank │ it         │ 120    │
│ ...  │ ...   │ ...        │ ...    │
│ 1    │ Cindy │ sales      │ 96     │ &lt;-- (!)
├──────┼───────┼────────────┼────────┤
│ 2    │ Dave  │ sales      │ 96     │ &lt;-- (!)
│ ...  │ ...   │ ...        │ ...    │
│ 2    │ Diane │ hr         │ 70     │
└──────┴───────┴────────────┴────────┘
</code></pre><div class="boxed">
<h3>✎ Exercises: Salary groups in each of the cities (+1 more)</h3>
<p>Practice is crucial in turning abstract knowledge into skills, making theory alone insufficient. The book, unlike this article, contains a lot of exercises; that's why I recommend <a href="https://antonz.gumroad.com/l/sql-windows">getting it</a>.</p>
<p>If you are okay with just theory for now, though — let's continue.</p>
</div>
<h2 id="ranking-functions">Ranking functions</h2>
<p>Here are the ranking window functions:</p>
<table>
<thead>
<tr>
<th>Function</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>row_number()</code></td>
<td>returns the row ordinal number</td>
</tr>
<tr>
<td><code>dense_rank()</code></td>
<td>returns row rank</td>
</tr>
<tr>
<td><code>rank()</code></td>
<td>returns row rank with possible gaps (see below)</td>
</tr>
<tr>
<td><code>ntile(n)</code></td>
<td>splits all rows into <code>n</code> groups and returns the index of the group that the row belongs to</td>
</tr>
</tbody>
</table>
<p>We have already seen <code>dense_rank()</code> and <code>ntile()</code>.</p>
<p><code>row_number()</code> numbers the rows in the order specified in <code>order by</code>. No surprises here.</p>
<p><code>rank()</code> is similar to <code>dense_rank()</code>, and the difference is easier to explain with an example.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#a90d91">select</span>
  <span style="color:#000">•••</span> <span style="color:#000">over</span> <span style="color:#000">w</span> <span style="color:#a90d91">as</span> <span style="color:#c41a16">&#34;rank&#34;</span>,
  <span style="color:#000">name</span>, <span style="color:#000">salary</span>
<span style="color:#a90d91">from</span> <span style="color:#000">employees</span>
<span style="color:#000">window</span> <span style="color:#000">w</span> <span style="color:#a90d91">as</span> (<span style="color:#a90d91">order</span> <span style="color:#a90d91">by</span> <span style="color:#000">salary</span> <span style="color:#a90d91">desc</span>)
<span style="color:#a90d91">order</span> <span style="color:#a90d91">by</span> <span style="color:#c41a16">&#34;rank&#34;</span>, <span style="color:#000">id</span>;
</code></pre></div><p>Let&rsquo;s try substituting <code>•••</code> with <code>dense_rank()</code> and <code>rank()</code>:</p>
<div class="row">
<div class="col-xs-12 col-sm-6">
dense_rank()<br/>
<pre><code>┌──────┬───────┬────────┐
│ rank │ name  │ salary │
├──────┼───────┼────────┤
│ 1    │ Frank │ 120    │
│ 2    │ Henry │ 104    │
│ 2    │ Irene │ 104    │
│ 3    │ Alice │ 100    │ (!)
│ 4    │ Cindy │ 96     │
│ 4    │ Dave  │ 96     │
│ 5    │ Grace │ 90     │ (!)
│ 6    │ Emma  │ 84     │
│ 7    │ Bob   │ 78     │
│ 8    │ Diane │ 70     │
└──────┴───────┴────────┘</code></pre>
</div>
<div class="col-xs-12 col-sm-6">
rank()<br/>
<pre><code>┌──────┬───────┬────────┐
│ rank │ name  │ salary │
├──────┼───────┼────────┤
│ 1    │ Frank │ 120    │
│ 2    │ Henry │ 104    │
│ 2    │ Irene │ 104    │
│ 4    │ Alice │ 100    │ (!)
│ 5    │ Cindy │ 96     │
│ 5    │ Dave  │ 96     │
│ 7    │ Grace │ 90     │ (!)
│ 8    │ Emma  │ 84     │
│ 9    │ Bob   │ 78     │
│ 10   │ Diane │ 70     │
└──────┴───────┴────────┘</code></pre>
</div>
</div>
<p><code>dense_rank()</code> assigns Alice the third place, while <code>rank()</code> assigns the fourth because Henry and Irene already occupied the second and third. It is the same with Grace after Cindy and Dave. That&rsquo;s the whole difference.</p>
<h2 id="keep-it-up">Keep it up</h2>
<p>You have learned what &ldquo;window&rdquo; and &ldquo;window functions&rdquo; are and how to use them to rank data. In the <span class="color-gray">next chapter</span> (coming soon), we will deal with window offsets and comparisons!</p>
<p>
    <a class="button" href="https://antonz.gumroad.com/l/sql-windows">
        Get the book
    </a>
</p>
]]></content:encoded></item><item><title>Cherry-Picked Features from Go 1.20</title><link>https://antonz.org/go-1-20/</link><pubDate>Tue, 07 Feb 2023 12:00:00 +0000</pubDate><guid>https://antonz.org/go-1-20/</guid><description>Multi-errors, context cancellation cause, new date formats, and other notable changes.</description><content:encoded><![CDATA[<p>Go 1.20 brought a lot of new features and improvements. In this post, I&rsquo;d like to review the ones that caught my eye. This is by no means an exhaustive list; for that, see the official <a href="https://tip.golang.org/doc/go1.20">release notes</a>.</p>
<p>These are the topics for review:</p>
<ul>
<li><a href="#multi-errors">Multi-errors</a></li>
<li><a href="#context-canceled-cause">&lsquo;Context Canceled&rsquo; Cause</a></li>
<li><a href="#new-date-formats">New Date Formats</a></li>
<li><a href="#slice-to-array-conversion">Slice to Array Conversion</a></li>
<li><a href="#other-notable-changes">Other Notable Changes</a></li>
</ul>
<p>Each section has a playground link, so check those out.</p>
<h2 id="multi-errors">Multi-errors</h2>
<p>The &ldquo;errors as values&rdquo; concept (as opposed to exceptions) has gained renewed popularity in modern languages such as Go and Rust. You know this well because it&rsquo;s impossible to take a step without tripping over an error value in Go.</p>
<p>Go 1.20 has brought us new joy — the combination of errors through <code>errors.Join()</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#000">errRaining</span> <span style="color:#000">:=</span> <span style="color:#000">errors</span>.<span style="color:#000">New</span>(<span style="color:#c41a16">&#34;it&#39;s raining&#34;</span>)
<span style="color:#000">errWindy</span> <span style="color:#000">:=</span> <span style="color:#000">errors</span>.<span style="color:#000">New</span>(<span style="color:#c41a16">&#34;it&#39;s windy&#34;</span>)
<span style="color:#000">err</span> <span style="color:#000">:=</span> <span style="color:#000">errors</span>.<span style="color:#000">Join</span>(<span style="color:#000">errRaining</span>, <span style="color:#000">errWindy</span>)
</code></pre></div><p>Now <code>err</code> is both <code>errRaining</code> and <code>errWindy</code> at the same time. The standard functions <code>errors.Is()</code> and <code>errors.As()</code> can work with this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a90d91">if</span> <span style="color:#000">errors</span>.<span style="color:#000">Is</span>(<span style="color:#000">err</span>, <span style="color:#000">errRaining</span>) {
    <span style="color:#000">fmt</span>.<span style="color:#000">Println</span>(<span style="color:#c41a16">&#34;ouch!&#34;</span>)
}
<span style="color:#177500">// ouch!
</span></code></pre></div><p><code>fmt.Errorf()</code> has also learned to combine errors:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#000">err</span> <span style="color:#000">:=</span> <span style="color:#000">fmt</span>.<span style="color:#000">Errorf</span>(
    <span style="color:#c41a16">&#34;reasons to skip work: %w, %w&#34;</span>,
    <span style="color:#000">errRaining</span>,
    <span style="color:#000">errWindy</span>,
)
</code></pre></div><p>To accept multiple errors in your own error type, return <code>[]error</code> from the <code>Unwrap()</code> method:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a90d91">type</span> <span style="color:#000">RefusalErr</span> <span style="color:#a90d91">struct</span> {
    <span style="color:#000">reasons</span> []<span style="color:#a90d91">error</span>
}

<span style="color:#a90d91">func</span> (<span style="color:#000">e</span> <span style="color:#000">RefusalErr</span>) <span style="color:#000">Unwrap</span>() []<span style="color:#a90d91">error</span> {
    <span style="color:#a90d91">return</span> <span style="color:#000">e</span>.<span style="color:#000">reasons</span>
}

<span style="color:#a90d91">func</span> (<span style="color:#000">e</span> <span style="color:#000">RefusalErr</span>) <span style="color:#000">Error</span>() <span style="color:#a90d91">string</span> {
    <span style="color:#a90d91">return</span> <span style="color:#000">fmt</span>.<span style="color:#000">Sprintf</span>(<span style="color:#c41a16">&#34;refusing: %v&#34;</span>, <span style="color:#000">e</span>.<span style="color:#000">reasons</span>)
}
</code></pre></div><p>If you love errors, this change will definitely be to your liking. If not&hellip; well, you always have panic :)</p>
<p><a href="https://go.dev/play/p/CftXuesNA1q">playground</a></p>
<h2 id="context-canceled-cause">&lsquo;Context Canceled&rsquo; Cause</h2>
<p>A <code>context.Canceled</code> error occurs when the context is canceled. This is no news:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#000">ctx</span>, <span style="color:#000">cancel</span> <span style="color:#000">:=</span> <span style="color:#000">context</span>.<span style="color:#000">WithCancel</span>(<span style="color:#000">context</span>.<span style="color:#000">Background</span>())
<span style="color:#000">cancel</span>()

<span style="color:#000">fmt</span>.<span style="color:#000">Println</span>(<span style="color:#000">ctx</span>.<span style="color:#000">Err</span>())
<span style="color:#177500">// context canceled
</span></code></pre></div><p>Starting from 1.20, we can create a context using <code>context.WithCancelCause()</code>. Then <code>cancel()</code> will take one parameter — the root <em>cause</em> of the error:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#000">ctx</span>, <span style="color:#000">cancel</span> <span style="color:#000">:=</span> <span style="color:#000">context</span>.<span style="color:#000">WithCancelCause</span>(<span style="color:#000">context</span>.<span style="color:#000">Background</span>())
<span style="color:#000">cancel</span>(<span style="color:#000">errors</span>.<span style="color:#000">New</span>(<span style="color:#c41a16">&#34;the night is dark&#34;</span>))
</code></pre></div><p><code>context.Cause()</code> extracts the cause of the error from the context:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#000">fmt</span>.<span style="color:#000">Println</span>(<span style="color:#000">ctx</span>.<span style="color:#000">Err</span>())
<span style="color:#177500">// context canceled
</span><span style="color:#177500"></span>
<span style="color:#000">fmt</span>.<span style="color:#000">Println</span>(<span style="color:#000">context</span>.<span style="color:#000">Cause</span>(<span style="color:#000">ctx</span>))
<span style="color:#177500">// the night is dark
</span></code></pre></div><p>You may ask — why <code>context.Cause()</code>? It seems logical to add the <code>Cause()</code> method to the context itself, similar to the <code>Err()</code> method.</p>
<p>Sure. But <code>Context</code> is an interface. And any change to the interface breaks backward compatibility. That&rsquo;s why it was done differently.</p>
<p><a href="https://go.dev/play/p/oDLOGfzSUvS">playground</a></p>
<h2 id="new-date-formats">New Date Formats</h2>
<p><em>Please don&rsquo;t be offended by this section if you are a North American. We love you people, but sometimes your view of the world can be a bit&hellip; biased.</em></p>
<p>You surely know that the Go authors chose a quite unorthodox format for the date and time layout.</p>
<p>For example, parsing the date <code>2023-01-25 09:30</code> looks like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a90d91">const</span> <span style="color:#000">layout</span> = <span style="color:#c41a16">&#34;2006-01-02 15:04&#34;</span>
<span style="color:#000">t</span>, <span style="color:#000">_</span> <span style="color:#000">:=</span> <span style="color:#000">time</span>.<span style="color:#000">Parse</span>(<span style="color:#000">layout</span>, <span style="color:#c41a16">&#34;2023-01-25 09:30&#34;</span>)
<span style="color:#000">fmt</span>.<span style="color:#000">Println</span>(<span style="color:#000">t</span>)
<span style="color:#177500">// 2023-01-25 09:30:00 +0000 UTC
</span></code></pre></div><p>While <code>01/02 03:04:05PM '06</code> may be a nice mnemonic in the US, it&rsquo;s entirely cryptic for the European (or Asian) eye.</p>
<p>The Go authors have thoughtfully provided 12 standard date/time masks, of which only <code>RFC3339</code> and <code>RFC3339Nano</code> are suitable for non-Americans. Others are as mysterious as the imperial measurement system:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#000">Layout</span>      = <span style="color:#c41a16">&#34;01/02 03:04:05PM &#39;06 -0700&#34;</span>
<span style="color:#000">ANSIC</span>       = <span style="color:#c41a16">&#34;Mon Jan _2 15:04:05 2006&#34;</span>
<span style="color:#000">UnixDate</span>    = <span style="color:#c41a16">&#34;Mon Jan _2 15:04:05 MST 2006&#34;</span>
<span style="color:#000">RubyDate</span>    = <span style="color:#c41a16">&#34;Mon Jan 02 15:04:05 -0700 2006&#34;</span>
<span style="color:#000">RFC822</span>      = <span style="color:#c41a16">&#34;02 Jan 06 15:04 MST&#34;</span>
<span style="color:#000">RFC822Z</span>     = <span style="color:#c41a16">&#34;02 Jan 06 15:04 -0700&#34;</span>
<span style="color:#000">RFC850</span>      = <span style="color:#c41a16">&#34;Monday, 02-Jan-06 15:04:05 MST&#34;</span>
<span style="color:#000">RFC1123</span>     = <span style="color:#c41a16">&#34;Mon, 02 Jan 2006 15:04:05 MST&#34;</span>
<span style="color:#000">RFC1123Z</span>    = <span style="color:#c41a16">&#34;Mon, 02 Jan 2006 15:04:05 -0700&#34;</span>
<span style="color:#000">Kitchen</span>     = <span style="color:#c41a16">&#34;3:04PM&#34;</span>
</code></pre></div><p>Ten years have passed, and the Go development team began to suspect something. They learned that there are several other popular date formats worldwide. And, starting with version 1.20, they added three new masks:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#000">DateTime</span> = <span style="color:#c41a16">&#34;2006-01-02 15:04:05&#34;</span>
<span style="color:#000">DateOnly</span> = <span style="color:#c41a16">&#34;2006-01-02&#34;</span>
<span style="color:#000">TimeOnly</span> = <span style="color:#c41a16">&#34;15:04:05&#34;</span>
</code></pre></div><p>Now we can finally do this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#000">t</span>, <span style="color:#000">_</span> <span style="color:#000">:=</span> <span style="color:#000">time</span>.<span style="color:#000">Parse</span>(<span style="color:#000">time</span>.<span style="color:#000">DateOnly</span>, <span style="color:#c41a16">&#34;2023-01-25&#34;</span>)
<span style="color:#000">fmt</span>.<span style="color:#000">Println</span>(<span style="color:#000">t</span>)
<span style="color:#177500">// 2023-01-25 00:00:00 +0000 UTC
</span></code></pre></div><p>Nice!</p>
<p><a href="https://go.dev/play/p/d3Vfyt43c0v">playground</a></p>
<h2 id="slice-to-array-conversion">Slice to Array Conversion</h2>
<p>Starting from version 1.17, we can get a pointer to an array under the slice:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#000">s</span> <span style="color:#000">:=</span> []<span style="color:#a90d91">int</span>{<span style="color:#1c01ce">1</span>, <span style="color:#1c01ce">2</span>, <span style="color:#1c01ce">3</span>}
<span style="color:#000">arrp</span> <span style="color:#000">:=</span> (<span style="color:#000">*</span>[<span style="color:#1c01ce">3</span>]<span style="color:#a90d91">int</span>)(<span style="color:#000">s</span>)
</code></pre></div><p>By changing the array through the pointer, we are also changing the slice:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#000">arrp</span>[<span style="color:#1c01ce">2</span>] = <span style="color:#1c01ce">42</span>
<span style="color:#000">fmt</span>.<span style="color:#000">Println</span>(<span style="color:#000">s</span>)
<span style="color:#177500">// [1 2 42]
</span></code></pre></div><p>In Go 1.20, we can also get a copy of the array under the slice:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#000">s</span> <span style="color:#000">:=</span> []<span style="color:#a90d91">int</span>{<span style="color:#1c01ce">1</span>, <span style="color:#1c01ce">2</span>, <span style="color:#1c01ce">3</span>}
<span style="color:#000">arr</span> <span style="color:#000">:=</span> [<span style="color:#1c01ce">3</span>]<span style="color:#a90d91">int</span>(<span style="color:#000">s</span>)
</code></pre></div><p>Changes in such an array are not reflected in the slice:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#000">arr</span>[<span style="color:#1c01ce">2</span>] = <span style="color:#1c01ce">42</span>
<span style="color:#000">fmt</span>.<span style="color:#000">Println</span>(<span style="color:#000">arr</span>)
<span style="color:#177500">// [1 2 42]
</span><span style="color:#177500"></span><span style="color:#000">fmt</span>.<span style="color:#000">Println</span>(<span style="color:#000">s</span>)
<span style="color:#177500">// [1 2 3]
</span></code></pre></div><p>This is, in essence, syntactic sugar because we could get a copy of the array before:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#000">s</span> <span style="color:#000">:=</span> []<span style="color:#a90d91">int</span>{<span style="color:#1c01ce">1</span>, <span style="color:#1c01ce">2</span>, <span style="color:#1c01ce">3</span>}
<span style="color:#000">arr</span> <span style="color:#000">:=</span> <span style="color:#000">*</span>(<span style="color:#000">*</span>[<span style="color:#1c01ce">3</span>]<span style="color:#a90d91">int</span>)(<span style="color:#000">s</span>)
</code></pre></div><p>The new notation is cleaner, of course.</p>
<p><a href="https://go.dev/play/p/9eTgSj2MO4V">playground</a></p>
<h2 id="other-notable-changes">Other Notable Changes</h2>
<p><strong>bytes.Clone()</strong> function clones a byte slice:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#000">b</span> <span style="color:#000">:=</span> []<span style="color:#a90d91">byte</span>(<span style="color:#c41a16">&#34;abc&#34;</span>)
<span style="color:#000">clone</span> <span style="color:#000">:=</span> <span style="color:#000">bytes</span>.<span style="color:#000">Clone</span>(<span style="color:#000">b</span>)
</code></pre></div><p><strong>math/rand</strong> package now automatically initializes the random number generator with a random starting value, so there is no need for a separate <code>rand.Seed()</code> call.</p>
<p><strong>strings.CutPrefix()</strong> and <code>strings.CutSuffix()</code> functions trim a prefix/suffix from a string similarly to <code>TrimPrefix</code>/<code>TrimSuffix</code>, but they also indicate whether the prefix was present in the string:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#000">s</span> <span style="color:#000">:=</span> <span style="color:#c41a16">&#34;&gt; go!&#34;</span>
<span style="color:#000">s</span>, <span style="color:#000">found</span> <span style="color:#000">:=</span> <span style="color:#000">strings</span>.<span style="color:#000">CutPrefix</span>(<span style="color:#000">s</span>, <span style="color:#c41a16">&#34;&gt; &#34;</span>)
<span style="color:#000">fmt</span>.<span style="color:#000">Println</span>(<span style="color:#000">s</span>, <span style="color:#000">found</span>)
<span style="color:#177500">// go! true
</span></code></pre></div><p><strong>sync.Map</strong> now has atomic methods <code>Swap</code>, <code>CompareAndSwap</code>, and <code>CompareAndDelete</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a90d91">var</span> <span style="color:#000">m</span> <span style="color:#000">sync</span>.<span style="color:#000">Map</span>
<span style="color:#000">m</span>.<span style="color:#000">Store</span>(<span style="color:#c41a16">&#34;name&#34;</span>, <span style="color:#c41a16">&#34;Alice&#34;</span>)
<span style="color:#000">prev</span>, <span style="color:#000">ok</span> <span style="color:#000">:=</span> <span style="color:#000">m</span>.<span style="color:#000">Swap</span>(<span style="color:#c41a16">&#34;name&#34;</span>, <span style="color:#c41a16">&#34;Bob&#34;</span>)
<span style="color:#000">fmt</span>.<span style="color:#000">Println</span>(<span style="color:#000">prev</span>, <span style="color:#000">ok</span>)
<span style="color:#177500">// Alice true
</span></code></pre></div><p><strong>time.Compare()</strong> function compares two times and returns -1/0/1 based on the comparison results:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#000">t1</span> <span style="color:#000">:=</span> <span style="color:#000">time</span>.<span style="color:#000">Now</span>()
<span style="color:#000">t2</span> <span style="color:#000">:=</span> <span style="color:#000">t1</span>.<span style="color:#000">Add</span>(<span style="color:#1c01ce">10</span> <span style="color:#000">*</span> <span style="color:#000">time</span>.<span style="color:#000">Minute</span>)
<span style="color:#000">cmp</span> <span style="color:#000">:=</span> <span style="color:#000">t2</span>.<span style="color:#000">Compare</span>(<span style="color:#000">t1</span>)
<span style="color:#000">fmt</span>.<span style="color:#000">Println</span>(<span style="color:#000">cmp</span>)
<span style="color:#177500">// 1
</span></code></pre></div><p>Overall, a great release! Looking forward to trying everything in production.</p>
]]></content:encoded></item><item><title>Regular Expressions in SQLite</title><link>https://antonz.org/sqlean-regexp/</link><pubDate>Sat, 04 Feb 2023 11:20:00 +0000</pubDate><guid>https://antonz.org/sqlean-regexp/</guid><description>Use a robust pattern matching and text replacement tool from SQL.</description><content:encoded><![CDATA[<p>Regular expressions are probably the most powerful text processing tool without programming.</p>
<p>SQLite does not support regular expressions by default. But you can easily enable them using the <code>regexp</code> extension.</p>
<p><strong>Note</strong>. Unlike other DBMS, adding extensions in SQLite is a breeze. Download a file, run one database command — and you are good to go.</p>
<p>With <code>regexp</code>, matching a string against a pattern becomes as easy as:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#177500">-- count messages containing digits
</span><span style="color:#177500"></span><span style="color:#a90d91">select</span> <span style="color:#a90d91">count</span>(<span style="color:#000">*</span>) <span style="color:#a90d91">from</span> <span style="color:#000">messages</span>
<span style="color:#a90d91">where</span> <span style="color:#000">msg_text</span> <span style="color:#000">regexp</span> <span style="color:#c41a16">&#39;\d+&#39;</span>;
<span style="color:#177500">-- 42
</span></code></pre></div><h2 id="pattern-matching-and-text-replacement">Pattern matching and text replacement</h2>
<p>There are three main tasks people usually solve using regular expressions:</p>
<ol>
<li>Match a string against the pattern.</li>
<li>Extract a part of the string that matches the pattern.</li>
<li>Replace all parts of the string that match the pattern.</li>
</ol>
<p><code>regexp</code> provides a separate function for each of these tasks.</p>
<h3 id="regexp_likesource-pattern"><code>regexp_like(source, pattern)</code></h3>
<p>Checks if the source string matches the pattern.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#a90d91">select</span> <span style="color:#000">regexp_like</span>(<span style="color:#c41a16">&#39;Meet me at 10:30&#39;</span>, <span style="color:#c41a16">&#39;\d+:\d+&#39;</span>);
<span style="color:#177500">-- 1
</span><span style="color:#177500"></span><span style="color:#a90d91">select</span> <span style="color:#000">regexp_like</span>(<span style="color:#c41a16">&#39;Meet me at the cinema&#39;</span>, <span style="color:#c41a16">&#39;\d+:\d+&#39;</span>);
<span style="color:#177500">-- 0
</span></code></pre></div><h3 id="regexp_substrsource-pattern"><code>regexp_substr(source, pattern)</code></h3>
<p>Returns a substring of the source string that matches the pattern.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#a90d91">select</span> <span style="color:#000">regexp_substr</span>(<span style="color:#c41a16">&#39;Meet me at 10:30&#39;</span>, <span style="color:#c41a16">&#39;\d+:\d+&#39;</span>);
<span style="color:#177500">-- 10:30
</span><span style="color:#177500"></span>
<span style="color:#a90d91">select</span> <span style="color:#000">regexp_substr</span>(<span style="color:#c41a16">&#39;Meet me at 17:05&#39;</span>, <span style="color:#c41a16">&#39;\d+:\d+&#39;</span>);
<span style="color:#177500">-- 17:05
</span></code></pre></div><h3 id="regexp_replacesource-pattern-replacement"><code>regexp_replace(source, pattern, replacement)</code></h3>
<p>Replaces all matching substrings with the replacement string.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#a90d91">select</span> <span style="color:#000">regexp_replace</span>(<span style="color:#c41a16">&#39;password = &#34;123456&#34;&#39;</span>, <span style="color:#c41a16">&#39;&#34;[^&#34;]+&#34;&#39;</span>, <span style="color:#c41a16">&#39;***&#39;</span>);
<span style="color:#177500">-- password = ***
</span><span style="color:#177500"></span>
<span style="color:#a90d91">select</span> <span style="color:#000">regexp_replace</span>(<span style="color:#c41a16">&#39;1 2 3 4&#39;</span>, <span style="color:#c41a16">&#39;[2468]&#39;</span>, <span style="color:#c41a16">&#39;even&#39;</span>);
<span style="color:#177500">-- 1 even 3 even
</span></code></pre></div><h2 id="pattern-syntax">Pattern syntax</h2>
<p><code>regexp</code> supports pretty advanced syntax, including various groups, lazy quantifiers, and look-arounds:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#a90d91">select</span> <span style="color:#000">regexp_substr</span>(<span style="color:#c41a16">&#39;the year is 2020&#39;</span>, <span style="color:#c41a16">&#39;(\d{2})\1&#39;</span>);
<span style="color:#177500">-- 2020
</span><span style="color:#177500"></span><span style="color:#a90d91">select</span> <span style="color:#000">regexp_substr</span>(<span style="color:#c41a16">&#39;the year is 2021&#39;</span>, <span style="color:#c41a16">&#39;(\d{2})\1&#39;</span>);
<span style="color:#177500">-- (null)
</span><span style="color:#177500"></span>
<span style="color:#a90d91">select</span> <span style="color:#000">regexp_substr</span>(<span style="color:#c41a16">&#39;1 2 3 2 4 5&#39;</span>, <span style="color:#c41a16">&#39;.*2&#39;</span>);
<span style="color:#177500">-- 1 2 3 2
</span><span style="color:#177500"></span><span style="color:#a90d91">select</span> <span style="color:#000">regexp_substr</span>(<span style="color:#c41a16">&#39;1 2 3 2 4 5&#39;</span>, <span style="color:#c41a16">&#39;.*?2&#39;</span>);
<span style="color:#177500">-- 1 2
</span><span style="color:#177500"></span>
<span style="color:#a90d91">select</span> <span style="color:#000">regexp_substr</span>(<span style="color:#c41a16">&#39;new year&#39;</span>, <span style="color:#c41a16">&#39;(\w+)\s(?=year)&#39;</span>);
<span style="color:#177500">-- new
</span><span style="color:#177500"></span><span style="color:#a90d91">select</span> <span style="color:#000">regexp_substr</span>(<span style="color:#c41a16">&#39;last year&#39;</span>, <span style="color:#c41a16">&#39;(\w+)\s(?=year)&#39;</span>);
<span style="color:#177500">-- last
</span></code></pre></div><h2 id="installation-and-usage">Installation and Usage</h2>
<ol>
<li>
<p>Download the <a href="https://github.com/nalgeon/sqlean/releases/latest">latest release</a></p>
</li>
<li>
<p>Use with SQLite command-line interface:</p>
</li>
</ol>
<pre tabindex="0"><code>sqlite&gt; .load ./regexp
sqlite&gt; select regexp_like('abcdef', 'b.d');
</code></pre><p>See <a href="https://github.com/nalgeon/sqlean/blob/main/docs/install.md">How to Install an Extension</a> for usage with IDE, Python, etc.</p>
<p>See <a href="https://github.com/nalgeon/sqlean/blob/main/docs/regexp.md">Extension Documentation</a> for reference.</p>
]]></content:encoded></item><item><title>Why Use SQL Window Functions</title><link>https://antonz.org/why-use-sql-window-functions/</link><pubDate>Tue, 31 Jan 2023 08:30:00 +0000</pubDate><guid>https://antonz.org/why-use-sql-window-functions/</guid><description>To build great analytical reports without Excel.</description><content:encoded><![CDATA[<p><em>This is an excerpt from my book <a href="/sql-window-functions-book">SQL Window Functions Explained</a>. The book is a clear and visual introduction to the topic with lots of practical exercises.</em></p>
<p>​In short, window functions assist in building great analytical reports without Excel.</p>
<p>The easiest way to explain it is through concrete examples. We will work with a toy employee table:</p>
<pre tabindex="0"><code>┌────┬──────────┬────────┬────────────┬────────┐
│ id │   name   │  city  │ department │ salary │
├────┼──────────┼────────┼────────────┼────────┤
│ 11 │ Diane    │ London │ hr         │ 70     │
│ 12 │ Bob      │ London │ hr         │ 78     │
│ 21 │ Emma     │ London │ it         │ 84     │
│ 22 │ Grace    │ Berlin │ it         │ 90     │
│ 23 │ Henry    │ London │ it         │ 104    │
│ 24 │ Irene    │ Berlin │ it         │ 104    │
│ 25 │ Frank    │ Berlin │ it         │ 120    │
│ 31 │ Cindy    │ Berlin │ sales      │ 96     │
│ 32 │ Dave     │ London │ sales      │ 96     │
│ 33 │ Alice    │ Berlin │ sales      │ 100    │
└────┴──────────┴────────┴────────────┴────────┘
</code></pre><p>Let&rsquo;s look at some tasks that are convenient to solve with the help of SQL window functions. We&rsquo;ll save the technical details for the following chapters. For now, let&rsquo;s review the use cases.</p>
<h2 id="ranking">Ranking</h2>
<p>Ranking means coming up with all kinds of ratings, starting from the winners of the World Swimming Championships and ending with the Forbes 500.</p>
<p>We will rank employees.</p>
<h3 id="overall-salary-rating">Overall salary rating</h3>
<p>Let&rsquo;s make a rating of employees by salary:</p>
<div class="row">
<div class="col-xs-12 col-sm-6">
    <figure>
        <img src="ranking-1.png" alt="Ranking example #1"/>
    </figure>
</div>
</div>
<p>The <code>rank</code> column shows each employee&rsquo;s position in the overall rating.</p>
<p>Some colleagues have the same salary (Henry and Irene, Cindy and Dave) — so they receive the same rank.</p>
<h3 id="salary-rating-by-department">Salary rating by department</h3>
<p>Similar rating, but created for each department separately instead of the whole company:</p>
<div class="row">
<div class="col-xs-12 col-sm-6">
    <figure>
        <img src="ranking-2.png" alt="Ranking example #2"/>
    </figure>
</div>
</div>
<p>The <code>rank</code> column shows each employee&rsquo;s position in the department&rsquo;s rating.</p>
<h3 id="salary-groups">Salary groups</h3>
<p>Let&rsquo;s split the employees into three groups according to their salary:</p>
<ul>
<li>highly-paid,</li>
<li>medium-paid,</li>
<li>low-paid.</li>
</ul>
<div class="row">
<div class="col-xs-12 col-sm-6">
    <figure>
        <img src="ranking-3.png" alt="Ranking example #3"/>
    </figure>
</div>
</div>
<p>The <code>tile</code> column shows which group each employee belongs to.</p>
<h3 id="the-most-precious-colleagues">The most &ldquo;precious&rdquo; colleagues</h3>
<p>Let&rsquo;s find the highest-paid people in each department:</p>
<div class="row">
<div class="col-xs-12 col-sm-6">
    <figure>
        <img src="ranking-4.png" alt="Ranking example #4"/>
    </figure>
</div>
</div>
<p>No more salary raise for them, I guess.</p>
<h2 id="comparison-with-offset">Comparison with offset</h2>
<p>Comparing by offset means looking at the difference between neighboring values. For example, comparing the countries that occupy the 5th and 6th places in the world GDP rating — how different are they? What about 1st and 6th place?</p>
<p>Sometimes we compare with boundaries instead of neighbors. For example, there are 50 top tennis players worldwide, and Maria Sakkari is ranked 10th. How do her stats compare to Iga Swiatek, who is ranked 1st? How does she compare to Lin Zhou, who is ranked 50th?</p>
<p>We will compare employees.</p>
<h3 id="salary-difference-with-the-neighbor">Salary difference with the neighbor</h3>
<p>Let&rsquo;s arrange employees by salary and check whether the gap between neighbors is large:</p>
<div class="row">
<div class="col-xs-12 col-sm-6">
    <figure>
        <img src="offset-1.png" alt="Offset example #1"/>
    </figure>
</div>
</div>
<p>The <code>diff</code> column shows how much an employee&rsquo;s salary differs from the previous colleague&rsquo;s. As you can see, there are no significant gaps. The largest ones are Diane and Bob (11%) and Irene and Frank (15%).</p>
<h3 id="salary-range-in-the-department">Salary range in the department</h3>
<p>Let&rsquo;s see how an employee&rsquo;s salary compares to the minimum and maximum wages in his department:</p>
<div class="row">
<div class="col-xs-12 col-sm-6">
    <figure>
        <img src="offset-2.png" alt="Offset example #2"/>
    </figure>
</div>
</div>
<p>For each employee, the <code>low</code> column shows the minimum salary in the department, and the <code>high</code> column shows the maximum. As you can see, the HR and Sales salary ranges are narrow, but the IT range is much broader.</p>
<h2 id="aggregation">Aggregation</h2>
<p>Aggregation means counting totals or averages. For example, the average salary per city. Or the total number of gold medals for each country in the Olympic Games standings.</p>
<p>We will aggregate employee salaries.</p>
<h3 id="comparing-with-the-salary-fund">Comparing with the salary fund</h3>
<p>Each department has a salary fund — money spent monthly on paying employees' salaries. Let&rsquo;s see what percentage of this fund amounts to the salary of each employee:</p>
<div class="row">
<div class="col-xs-12 col-sm-6">
    <figure>
        <img src="aggregation-1.png" alt="Aggregation example #1"/>
    </figure>
</div>
</div>
<p>The <code>fund</code> column shows the department&rsquo;s salary fund, and the <code>perc</code> column shows the employee&rsquo;s salary share of this fund. As you can see, everything is more or less even in HR and Sales, but IT has a noticeable spread of salaries.</p>
<h3 id="comparing-to-the-average-salary">Comparing to the average salary</h3>
<p>I wonder how large is the spread of salaries inside departments. Let&rsquo;s calculate the deviation of each employee&rsquo;s salary from the average department salary:</p>
<div class="row">
<div class="col-xs-12 col-sm-6">
    <figure>
        <img src="aggregation-2.png" alt="Aggregation example #2"/>
    </figure>
</div>
</div>
<p>The result confirms the previous observation: IT salaries range from -16% to +20% of the average, while other departments are within 5%.</p>
<h2 id="rolling-aggregates">Rolling aggregates</h2>
<p>​Rolling aggregates (aka sliding or moving aggregates) are just totals — sum or average. But instead of calculating them across all elements, we use a different approach.</p>
<p>Consider the company our employees work for. Here is a table with its income and expenses for nine months of the year:</p>
<pre tabindex="0"><code>┌──────┬───────┬────────┬─────────┐
│ year │ month │ income │ expense │
├──────┼───────┼────────┼─────────┤
│ 2020 │ 1     │ 94     │ 82      │
│ 2020 │ 2     │ 94     │ 75      │
│ 2020 │ 3     │ 94     │ 104     │
│ 2020 │ 4     │ 100    │ 94      │
│ 2020 │ 5     │ 100    │ 99      │
│ 2020 │ 6     │ 100    │ 105     │
│ 2020 │ 7     │ 100    │ 95      │
│ 2020 │ 8     │ 100    │ 110     │
│ 2020 │ 9     │ 104    │ 104     │
└──────┴───────┴────────┴─────────┘
</code></pre><h3 id="expenses-moving-average">Expenses moving average</h3>
<p>Judging by the data, the income is growing: 94 in January → 104 in September. But are the expenses growing as well? It&rsquo;s hard to say right away: expenses differ month by month. To smooth out these spikes, we&rsquo;ll use the &ldquo;3-month average&rdquo; — the average between the previous, current, and next month&rsquo;s expenses for each month:</p>
<ul>
<li>moving average for February = (January + February + March) / 3;</li>
<li>for March = (February + March + April) / 3;</li>
<li>for April = (March + April + May) / 3;</li>
<li>etc.</li>
</ul>
<p>Let&rsquo;s calculate the moving average for all months:</p>
<div class="row">
<div class="col-xs-12 col-sm-6">
    <figure>
        <img src="rolling-1.png" alt="Rolling aggregates example #1"/>
    </figure>
</div>
</div>
<p>Now it is clear that expenses are steadily growing.</p>
<h3 id="cumulative-income">Cumulative income</h3>
<p>Thanks to the moving average, we know that income and expenses are growing. But how do they relate to each other? We want to understand whether the company is &ldquo;in the black&rdquo; or &ldquo;in the red&rdquo;, considering all the money earned and spent.</p>
<p>It is essential to see the values for each month, not only for the end of the year. If at the end of the year everything is OK, but in June the company went into negative — this is a potential problem (companies call this situation a &ldquo;cash gap&rdquo;).</p>
<p>Let&rsquo;s calculate income and expenses by month as a cumulative total:</p>
<ul>
<li>cumulative income for January = January;</li>
<li>for February = January + February;</li>
<li>for March = January + February + March;</li>
<li>for April = January + February + March + April;</li>
<li>etc.</li>
</ul>
<div class="row">
<div class="col-xs-12 col-sm-8">
    <figure>
        <img src="rolling-2.png" alt="Rolling aggregates example #2"/>
    </figure>
</div>
</div>
<p>Now it is clear the company is doing well. In some months, expenses exceed income, but thanks to the accumulated cash reserve, there is no gap.</p>
<h2 id="summary">Summary</h2>
<p>SQL window functions help to solve the following tasks:</p>
<ul>
<li>Ranking (all kinds of ratings).</li>
<li>Comparison with offset (neighboring elements and boundaries).</li>
<li>Aggregation (sum and average).</li>
<li>Rolling aggregates (sum and average in dynamics).</li>
</ul>
<p>Of course, this is not an exhaustive list. But I hope now it is clear why window functions are beneficial for data analysis. In the next chapter, we will examine what windows are and how to use them.</p>
<p>
    <a class="button valign-middle" href="https://antonz.gumroad.com/l/sql-windows">
        Get the book
    </a>
     or
    <span class="color-gray">continue reading</span> (coming soon)
</p>
]]></content:encoded></item><item><title>SQL Window Functions Explained</title><link>https://antonz.org/sql-window-functions-book/</link><pubDate>Sun, 22 Jan 2023 18:00:00 +0000</pubDate><guid>https://antonz.org/sql-window-functions-book/</guid><description>A clear and visual introduction to window functions in SQL.</description><content:encoded><![CDATA[<p>Window functions are probably the most confusing section of SQL. You might think, &ldquo;So what? They just came up with some additional functions&rdquo;. Not really. &ldquo;Window functions&rdquo; is a separate language built into regular SQL. And it&rsquo;s more complicated than everything you know about SELECTs.</p>
<p>In short, window functions assist in making great analytical reports without Excel. Maybe you want to calculate monthly sales percentages over the year? Window functions. Split marketing channels into effective and ineffective ones? Window functions. Choose the top 10 clients for each segment? Same.</p>
<div class="row">
<div class="col-xs-12 col-sm-8">
    <p>I've read several dozen articles explaining SQL window functions. They all suffered from one of two problems:</p>
    <ol>
        <li>Easy read without much practical value, describing 10% of features.</li>
        <li>Difficult to comprehend. If I did not know the subject — I would not understand a thing.</li>
    </ol>
</div>
<div class="col-xs-12 col-sm-4">
    <figure>
        <img src="queries.png" alt="How I see complex queries" class="img-bordered-thin"/>
        <figcaption>
            <small>SQL window queries can look like this for an unfamiliar reader.</small>
        </figcaption>
    </figure>
</div>
</div>
<p>I want people to understand SQL windows better. So I wrote a book — <em>SQL Window Functions Explained</em>.</p>
<h2 id="about-the-book">About the book</h2>
<p>It is a clear and visual introduction to window functions. Clear — because I can describe complex topics in a readable way. Visual — because I have prepared a hundred pictures and GIFs to help you understand SQL windows.</p>
<p>Window functions are a complex topic. So the book only teaches a little at a time. It gives just enough theory and a lot of practice — because it&rsquo;s the only way to turn abstract knowledge into skills.</p>
<p>Here is what you will learn:</p>
<div class="row">
<div class="col-xs-12 col-sm-6">
<ol>
    <li><a href="/why-use-sql-window-functions">Why use window functions</a></li>
    <li>Windows and functions
        <ul>
            <li>Ranking</li>
            <li>Offset</li>
            <li>Aggregation</li>
            <li>Rolling aggregates</li>
            <li>Statistics</li>
        </ul>
    </li>
    <li>Frames
        <ul>
            <li>ROWS and GROUPS</li>
            <li>RANGE</li>
            <li>EXCLUDE</li>
            <li>FILTER</li>
        </ul>
    </li>
    <li>Practice
        <ul>
            <li>Product analytics</li>
            <li>Clustering</li>
        </ul>
    </li>
</ol>
</div>
<div class="col-xs-12 col-sm-6">
    <figure>
        <img src="poster.png" alt="Book poster" class="img-bordered-thin"/>
        <figcaption>Every chapter covers a single topic in depth</figcaption>
    </figure>
</div>
</div>
<p>To preview the first few chapters, visit the links in the table of contents above.</p>
<p>10 of the 13 chapters are ready, and I&rsquo;ll publish the rest by May 2023. You can buy an early access release for $10.</p>
<p>
    <a class="button" href="https://antonz.gumroad.com/l/sql-windows">
        Get the book
    </a>
</p>
]]></content:encoded></item><item><title>Atomic operations composition in Go</title><link>https://antonz.org/atomics-composition/</link><pubDate>Tue, 17 Jan 2023 09:20:00 +0000</pubDate><guid>https://antonz.org/atomics-composition/</guid><description>Examining atomicity and predictability of operations in a concurrent environment.</description><content:encoded><![CDATA[<p>An atomic operation in a concurrent program is a great thing. Such operation transforms into a single processor instruction, so it does not require locks. You can safely call it from different goroutines and receive a predictable result.</p>
<p>But what happens if you misuse atomics? Let&rsquo;s figure it out.</p>
<h2 id="atomicity">Atomicity</h2>
<p>Let&rsquo;s look at a function that increments a counter:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a90d91">var</span> <span style="color:#000">counter</span> <span style="color:#a90d91">int32</span>

<span style="color:#a90d91">func</span> <span style="color:#000">increment</span>() {
    <span style="color:#000">counter</span> <span style="color:#000">+=</span> <span style="color:#1c01ce">1</span>
    <span style="color:#177500">// random sleep up to 10 ms
</span><span style="color:#177500"></span>    <span style="color:#000">sleep</span>(<span style="color:#1c01ce">10</span>)
    <span style="color:#000">counter</span> <span style="color:#000">+=</span> <span style="color:#1c01ce">1</span>
}
</code></pre></div><p>If we call it 100 times in a single goroutine:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a90d91">for</span> <span style="color:#000">i</span> <span style="color:#000">:=</span> <span style="color:#1c01ce">0</span>; <span style="color:#000">i</span> &lt; <span style="color:#1c01ce">100</span>; <span style="color:#000">i</span><span style="color:#000">++</span> {
    <span style="color:#000">increment</span>()
}
</code></pre></div><p>then <code>counter</code> is guaranteed to equal 200.</p>
<p>In a concurrent environment, <code>increment()</code> is unsafe due to races on <code>counter += 1</code>. Now I will try to fix it and propose several options.</p>
<p>In each case, answer the question: if you call <code>increment()</code> from 100 goroutines, is the final value of the <code>counter</code> guaranteed?</p>
<p><strong>Example 1</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a90d91">var</span> <span style="color:#000">counter</span> <span style="color:#000">atomic</span>.<span style="color:#000">Int32</span>

<span style="color:#a90d91">func</span> <span style="color:#000">increment</span>() {
    <span style="color:#000">counter</span>.<span style="color:#000">Add</span>(<span style="color:#1c01ce">1</span>)
    <span style="color:#000">sleep</span>(<span style="color:#1c01ce">10</span>)
    <span style="color:#000">counter</span>.<span style="color:#000">Add</span>(<span style="color:#1c01ce">1</span>)
}
</code></pre></div><p>Is the <code>counter</code> value guaranteed?</p>
<details>
    <summary>Answer</summary>
    <p>It is guaranteed.</p>
</details>
<p><strong>Example 2</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a90d91">var</span> <span style="color:#000">counter</span> <span style="color:#000">atomic</span>.<span style="color:#000">Int32</span>

<span style="color:#a90d91">func</span> <span style="color:#000">increment</span>() {
    <span style="color:#a90d91">if</span> <span style="color:#000">counter</span>.<span style="color:#000">Load</span>()<span style="color:#000">%</span><span style="color:#1c01ce">2</span> <span style="color:#000">==</span> <span style="color:#1c01ce">0</span> {
        <span style="color:#000">sleep</span>(<span style="color:#1c01ce">10</span>)
        <span style="color:#000">counter</span>.<span style="color:#000">Add</span>(<span style="color:#1c01ce">1</span>)
    } <span style="color:#a90d91">else</span> {
        <span style="color:#000">sleep</span>(<span style="color:#1c01ce">10</span>)
        <span style="color:#000">counter</span>.<span style="color:#000">Add</span>(<span style="color:#1c01ce">2</span>)
    }
}
</code></pre></div><p>Is the <code>counter</code> value guaranteed?</p>
<details>
    <summary>Answer</summary>
    <p>It's not guaranteed.</p>
</details>
<p><strong>Example 3</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a90d91">var</span> <span style="color:#000">delta</span> <span style="color:#000">atomic</span>.<span style="color:#000">Int32</span>
<span style="color:#a90d91">var</span> <span style="color:#000">counter</span> <span style="color:#000">atomic</span>.<span style="color:#000">Int32</span>

<span style="color:#a90d91">func</span> <span style="color:#000">increment</span>() {
    <span style="color:#000">delta</span>.<span style="color:#000">Add</span>(<span style="color:#1c01ce">1</span>)
    <span style="color:#000">sleep</span>(<span style="color:#1c01ce">10</span>)
    <span style="color:#000">counter</span>.<span style="color:#000">Add</span>(<span style="color:#000">delta</span>.<span style="color:#000">Load</span>())
}
</code></pre></div><p>Is the <code>counter</code> value guaranteed?</p>
<details>
    <summary>Answer</summary>
    <p>It's not guaranteed.</p>
</details>
<h2 id="composition-of-atomic-operations">Composition of Atomic Operations</h2>
<p>People sometimes think that the composition of atomics also magically becomes an atomic operation. But this is not the case.</p>
<p>For example, the second of the above examples:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a90d91">var</span> <span style="color:#000">counter</span> <span style="color:#000">atomic</span>.<span style="color:#000">Int32</span>

<span style="color:#a90d91">func</span> <span style="color:#000">increment</span>() {
    <span style="color:#a90d91">if</span> <span style="color:#000">counter</span>.<span style="color:#000">Load</span>()<span style="color:#000">%</span><span style="color:#1c01ce">2</span> <span style="color:#000">==</span> <span style="color:#1c01ce">0</span> {
        <span style="color:#000">sleep</span>(<span style="color:#1c01ce">10</span>)
        <span style="color:#000">counter</span>.<span style="color:#000">Add</span>(<span style="color:#1c01ce">1</span>)
    } <span style="color:#a90d91">else</span> {
        <span style="color:#000">sleep</span>(<span style="color:#1c01ce">10</span>)
        <span style="color:#000">counter</span>.<span style="color:#000">Add</span>(<span style="color:#1c01ce">2</span>)
    }
}
</code></pre></div><p>Call <code>increment()</code> 100 times from different goroutines:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a90d91">var</span> <span style="color:#000">wg</span> <span style="color:#000">sync</span>.<span style="color:#000">WaitGroup</span>
<span style="color:#000">wg</span>.<span style="color:#000">Add</span>(<span style="color:#1c01ce">100</span>)

<span style="color:#a90d91">for</span> <span style="color:#000">i</span> <span style="color:#000">:=</span> <span style="color:#1c01ce">0</span>; <span style="color:#000">i</span> &lt; <span style="color:#1c01ce">100</span>; <span style="color:#000">i</span><span style="color:#000">++</span> {
    <span style="color:#a90d91">go</span> <span style="color:#a90d91">func</span>() {
        <span style="color:#000">increment</span>()
        <span style="color:#000">wg</span>.<span style="color:#000">Done</span>()
    }()

}

<span style="color:#000">wg</span>.<span style="color:#000">Wait</span>()
<span style="color:#000">fmt</span>.<span style="color:#000">Println</span>(<span style="color:#000">counter</span>.<span style="color:#000">Load</span>())
</code></pre></div><p>Run with the <code>-race</code> flag — there are no races. But can we guarantee what the <code>counter</code> value will be in the end? Nope.</p>
<pre tabindex="0"><code>% go run atomic-2.go
192
% go run atomic-2.go
191
% go run atomic-2.go
189
</code></pre><p>Despite the absence of races, <code>increment()</code> is not atomic.</p>
<p>Check yourself by answering the question: in which example is <code>increment()</code> an atomic operation?</p>
<details>
    <summary>Answer</summary>
    <p>In none of them.</p>
</details>
<h2 id="atomicity-and-sequence-independence">Atomicity and Sequence-Independence</h2>
<p>In all examples, <code>increment()</code> is not an atomic operation. The composition of atomics is always non-atomic.</p>
<p>The first example, however, guarantees the final value of the <code>counter</code> in a concurrent environment:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a90d91">var</span> <span style="color:#000">counter</span> <span style="color:#000">atomic</span>.<span style="color:#000">Int32</span>

<span style="color:#a90d91">func</span> <span style="color:#000">increment</span>() {
    <span style="color:#000">counter</span>.<span style="color:#000">Add</span>(<span style="color:#1c01ce">1</span>)
    <span style="color:#000">sleep</span>(<span style="color:#1c01ce">10</span>)
    <span style="color:#000">counter</span>.<span style="color:#000">Add</span>(<span style="color:#1c01ce">1</span>)
}
</code></pre></div><p>If we run 100 goroutines, the <code>counter</code> will ultimately equal 200 (if there were no errors during execution).</p>
<p>The reason is that <code>Add()</code> is a sequence-independent operation. The runtime can perform such operations in any order, and the result will not change.</p>
<p>The second and third examples use sequence-dependent operations. When we run 100 goroutines, the order of operations is different each time. Therefore, the result is also different.</p>
<p>In general, despite the apparent simplicity of atomics, use them cautiously. Mutex is less shiny but more error-proof.</p>
]]></content:encoded></item><item><title>Idempotent Close in Go</title><link>https://antonz.org/idempotent-close/</link><pubDate>Wed, 11 Jan 2023 11:00:00 +0000</pubDate><guid>https://antonz.org/idempotent-close/</guid><description>How to free the resources safely.</description><content:encoded><![CDATA[<p><em>Idempotence</em> is when a repeated call to an operation on an object does not result in changes or errors. Idempotence is a handy development tool.</p>
<p>Let&rsquo;s see how idempotence helps to free the occupied resources safely.</p>
<h2 id="idempotent-close">Idempotent Close</h2>
<p>Suppose we have a gate:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a90d91">type</span> <span style="color:#000">Gate</span> <span style="color:#a90d91">struct</span>{
    <span style="color:#177500">// internal state
</span><span style="color:#177500"></span>    <span style="color:#177500">// ...
</span><span style="color:#177500"></span>}
</code></pre></div><p>The <code>NewGate()</code> constructor opens the gate, acquires some system resources, and returns an instance of the <code>Gate</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#000">g</span> <span style="color:#000">:=</span> <span style="color:#000">NewGate</span>()
</code></pre></div><p>In the end, we must release the occupied resources:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a90d91">func</span> (<span style="color:#000">g</span> <span style="color:#000">*</span><span style="color:#000">Gate</span>) <span style="color:#000">Close</span>() <span style="color:#a90d91">error</span> {
    <span style="color:#177500">// free acquired resources
</span><span style="color:#177500"></span>    <span style="color:#177500">// ...
</span><span style="color:#177500"></span>    <span style="color:#a90d91">return</span> <span style="color:#a90d91">nil</span>
}

<span style="color:#000">g</span> <span style="color:#000">:=</span> <span style="color:#000">NewGate</span>()
<span style="color:#a90d91">defer</span> <span style="color:#000">g</span>.<span style="color:#000">Close</span>()
<span style="color:#177500">// do stuff
</span><span style="color:#177500">// ...
</span></code></pre></div><p>Problems arise when in some branch of the code, we want to close the gate explicitly:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#000">g</span> <span style="color:#000">:=</span> <span style="color:#000">NewGate</span>()
<span style="color:#a90d91">defer</span> <span style="color:#000">g</span>.<span style="color:#000">Close</span>()

<span style="color:#000">err</span> <span style="color:#000">:=</span> <span style="color:#000">checkSomething</span>()
<span style="color:#a90d91">if</span> <span style="color:#000">err</span> <span style="color:#000">!=</span> <span style="color:#a90d91">nil</span> {
    <span style="color:#000">g</span>.<span style="color:#000">Close</span>()
    <span style="color:#177500">// do something else
</span><span style="color:#177500"></span>    <span style="color:#177500">// ...
</span><span style="color:#177500"></span>    <span style="color:#a90d91">return</span>
}

<span style="color:#177500">// do more stuff
</span><span style="color:#177500">// ...
</span></code></pre></div><p>The first <code>Close()</code> will work, but the second (via <code>defer</code>) will break because the resources have already been released.</p>
<p>The solution is to make <code>Close()</code> idempotent so that repeated calls do nothing if the gate is already closed:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a90d91">type</span> <span style="color:#000">Gate</span> <span style="color:#a90d91">struct</span>{
    <span style="color:#000">closed</span> <span style="color:#a90d91">bool</span>
    <span style="color:#177500">// internal state
</span><span style="color:#177500"></span>    <span style="color:#177500">// ...
</span><span style="color:#177500"></span>}

<span style="color:#a90d91">func</span> (<span style="color:#000">g</span> <span style="color:#000">*</span><span style="color:#000">Gate</span>) <span style="color:#000">Close</span>() <span style="color:#a90d91">error</span> {
    <span style="color:#a90d91">if</span> <span style="color:#000">g</span>.<span style="color:#000">closed</span> {
        <span style="color:#a90d91">return</span> <span style="color:#a90d91">nil</span>
    }
    <span style="color:#177500">// free acquired resources
</span><span style="color:#177500"></span>    <span style="color:#177500">// ...
</span><span style="color:#177500"></span>    <span style="color:#000">g</span>.<span style="color:#000">closed</span> = <span style="color:#a90d91">true</span>
    <span style="color:#a90d91">return</span> <span style="color:#a90d91">nil</span>
}
</code></pre></div><p><a href="https://go.dev/play/p/LFEThpm1nTs">playground</a></p>
<p>Now we can call <code>Close()</code> repeatedly without any problems. Until we try to close the gate from different goroutines — then everything will fall apart.</p>
<h2 id="idempotency-in-a-concurrent-environment">Idempotency in a concurrent environment</h2>
<p>We have made the gate closing idempotent — safe for repeated calls:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a90d91">func</span> (<span style="color:#000">g</span> <span style="color:#000">*</span><span style="color:#000">Gate</span>) <span style="color:#000">Close</span>() <span style="color:#a90d91">error</span> {
    <span style="color:#a90d91">if</span> <span style="color:#000">g</span>.<span style="color:#000">closed</span> {
        <span style="color:#a90d91">return</span> <span style="color:#a90d91">nil</span>
    }
    <span style="color:#177500">// free acquired resources
</span><span style="color:#177500"></span>    <span style="color:#177500">// ...
</span><span style="color:#177500"></span>    <span style="color:#000">g</span>.<span style="color:#000">closed</span> = <span style="color:#a90d91">true</span>
    <span style="color:#a90d91">return</span> <span style="color:#a90d91">nil</span>
}
</code></pre></div><p>But if several goroutines use the same <code>Gate</code> instance, a simultaneous call to <code>Close()</code> will lead to races — a concurrent modification of the <code>closed</code> field. We don&rsquo;t want this.</p>
<p>We have to protect the <code>closed</code> field access with a mutex:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a90d91">type</span> <span style="color:#000">Gate</span> <span style="color:#a90d91">struct</span> {
    <span style="color:#000">mu</span>     <span style="color:#000">sync</span>.<span style="color:#000">Mutex</span>
    <span style="color:#000">closed</span> <span style="color:#a90d91">bool</span>
    <span style="color:#177500">// internal state
</span><span style="color:#177500"></span>    <span style="color:#177500">// ...
</span><span style="color:#177500"></span>}

<span style="color:#a90d91">func</span> (<span style="color:#000">g</span> <span style="color:#000">*</span><span style="color:#000">Gate</span>) <span style="color:#000">Close</span>() <span style="color:#a90d91">error</span> {
    <span style="color:#000">g</span>.<span style="color:#000">mu</span>.<span style="color:#000">Lock</span>()

    <span style="color:#a90d91">if</span> <span style="color:#000">g</span>.<span style="color:#000">closed</span> {
        <span style="color:#000">g</span>.<span style="color:#000">mu</span>.<span style="color:#000">Unlock</span>()
        <span style="color:#a90d91">return</span> <span style="color:#a90d91">nil</span>
    }
    <span style="color:#177500">// free acquired resources
</span><span style="color:#177500"></span>    <span style="color:#177500">// ...
</span><span style="color:#177500"></span>
    <span style="color:#000">g</span>.<span style="color:#000">closed</span> = <span style="color:#a90d91">true</span>
    <span style="color:#000">g</span>.<span style="color:#000">mu</span>.<span style="color:#000">Unlock</span>()
    <span style="color:#a90d91">return</span> <span style="color:#a90d91">nil</span>
}
</code></pre></div><p><a href="https://go.dev/play/p/i3pFy362YEi">playground</a></p>
<p>The mutex ensures that only a single goroutine executes the code between <code>Lock()</code> and <code>Unlock()</code> at any given time.</p>
<p>Now multiple calls to <code>Close()</code> work correctly in a concurrent environment.</p>
<p>That&rsquo;s it!</p>
]]></content:encoded></item><item><title>Speed of algorithms (with cats)</title><link>https://antonz.org/big-o/</link><pubDate>Wed, 21 Dec 2022 16:50:00 +0000</pubDate><guid>https://antonz.org/big-o/</guid><description>Analyzing fast and slow algorithms with silly cat examples.</description><content:encoded><![CDATA[<p>Let&rsquo;s see how programmers evaluate fast and slow algorithms. Since the topic is pretty boring, we&rsquo;ll use silly cat examples.</p>
<h2 id="constant-time-o1">Constant time: O(1)</h2>
<p>This is your best option. The algorithm speed does not depend on the number of cats.</p>
<div class="row">
<div class="col-xs-12 col-sm-6 flex">
<div class="boxed">
    <p><strong>🐾 Example</strong></p>
    <p>You are the lucky owner of <code>N</code> cats. Every kitten knows their name. If you call "Felix!", only one will come running, and the rest of the <code>N-1</code> fluffs don't care.</p>
</div>
</div>
<div class="col-xs-12 col-sm-6">
<figure>
  <img alt="Constant time" src="01-constant.jpg" class="img-bordered-thin">
</figure>
</div>
</div>
<h2 id="logarithmic-time-ologn">Logarithmic time: O(log n)</h2>
<p>On <code>N</code> cats the algorithm completes in <code>log(N)</code> steps. It&rsquo;s fast! 1,000,000 kittens → 20 operations total.</p>
<div class="row">
<div class="col-xs-12 col-sm-6 flex">
<div class="boxed">
    <p><strong>🐾 Example</strong></p>
    <p>Cat's bowls are arranged alphabetically. When you adopt a new cat, the place for its bowl can be found in <code>log(N)</code> steps.</p>
</div>
</div>
<div class="col-xs-12 col-sm-6">
<figure>
  <img alt="Logarithmic time" src="02-log.jpg" class="img-bordered-thin">
</figure>
</div>
</div>
<h2 id="linear-time-on">Linear time: O(n)</h2>
<p>On <code>N</code> cats the algorithm completes in <code>N</code> steps. It means that every time you have to traverse all cats. Not great, not terrible.</p>
<div class="row">
<div class="col-xs-12 col-sm-6 flex">
<div class="boxed">
    <p><strong>🐾 Example</strong></p>
    <p>Your kittens rebelled and stopped responding to nicknames. Now you have to look through <code>N</code> fluffs to find the right one.</p>
</div>
</div>
<div class="col-xs-12 col-sm-6">
<figure>
  <img alt="Linear time" src="03-linear.jpg" class="img-bordered-thin">
</figure>
</div>
</div>
<h2 id="log-linear-time-onlogn">Log-linear time: O(n log n)</h2>
<p>On <code>N</code> cats the algorithm completes in <code>N</code> × <code>log(N)</code> steps. This is slower than in linear time, but not by much (the logarithm of <code>N</code> is much smaller than <code>N</code>, remember?).</p>
<div class="row">
<div class="col-xs-12 col-sm-6 flex">
<div class="boxed">
    <p><strong>🐾 Example</strong></p>
    <p>Waiting for guests, you decided to seat kittens in the order of their size. The quick sort algorithm will handle this in <code>N</code> × <code>log(N)</code> steps.</p>
</div>
</div>
<div class="col-xs-12 col-sm-6">
<figure>
  <img alt="Log-linear time" src="04-log-linear.jpg" class="img-bordered-thin">
</figure>
</div>
</div>
<p>Next in line, we have lazy polynomial cats and snail-speed superpolynomial ones.</p>
<h2 id="quadratic-time-on">Quadratic time: O(n²)</h2>
<p>On <code>N</code> cats the algorithm completes in <code>N²</code> steps. So slow.</p>
<div class="row">
<div class="col-xs-12 col-sm-6 flex">
<div class="boxed">
    <p><strong>🐾 Example</strong></p>
    <p>Your competitor claims that his <code>N</code> kittens are smoother and happier than yours. A special commission will compare the cats in pairs and make a fair verdict. You will need ~ <code>N²</code> comparisons.</p>
</div>
</div>
<div class="col-xs-12 col-sm-6">
<figure>
  <img alt="Quadratic time" src="05-quadratic.jpg" class="img-bordered-thin">
</figure>
</div>
</div>
<h2 id="polynomial-time-onᵏ">Polynomial time: O(nᵏ)</h2>
<p>On <code>N</code> cats the algorithm completes in <code>N³</code> steps, <code>N⁴</code> steps, <code>N⁵</code> steps, or even longer. Ugh. Don&rsquo;t be like that.</p>
<div class="row">
<div class="col-xs-12 col-sm-6 flex">
<div class="boxed">
    <p><strong>🐾 Example</strong></p>
    <p>Photoshoot! Each of the <code>N</code> kittens will be photographed in pairs with others, and the photographer takes <code>N</code> pictures for each pair. <code>N</code> × <code>N</code> × <code>N</code> ≃ <code>N³</code> steps.</p>
</div>
</div>
<div class="col-xs-12 col-sm-6">
<figure>
  <img alt="Polynomial time" src="06-polinomial.jpg" class="img-bordered-thin">
</figure>
</div>
</div>
<p>Polynomial algorithms are not famous for their speed. But compared to superpolynomial ones, they are as fast as a Flash. Sadly, the only &ldquo;super&rdquo; part of superpolynomial algorithms is a name. Let me show you.</p>
<h2 id="exponential-time-o2ⁿ">Exponential time: O(2ⁿ)</h2>
<p>On <code>N</code> cats the algorithm completes in <code>2ⁿ</code> steps. It&rsquo;s a long time, you&rsquo;re probably not gonna wait.</p>
<div class="row">
<div class="col-xs-12 col-sm-6 flex">
<div class="boxed">
    <p><strong>🐾 Example</strong></p>
    <p>Kittens are going to the cat show. Everyone will be weighed and rated in stars. But the cat transport can handle a maximum of X kilograms (or pounds). How to choose the most stellar cast? The answer will require <code>2ⁿ</code> steps.</p>
</div>
</div>
<div class="col-xs-12 col-sm-6">
<figure>
  <img alt="Exponential time" src="07-exponential.jpg" class="img-bordered-thin">
</figure>
</div>
</div>
<h2 id="factorial-time-on">Factorial time: O(n!)</h2>
<p>On <code>N</code> cats the algorithm completes in <code>N</code> ×<code>(N-1)</code> ×<code>(N-2)</code> ×&hellip; × <code>1</code> steps. This is crazy! With 20 cats it&rsquo;s already a couple of quintillion operations.</p>
<div class="row">
<div class="col-xs-12 col-sm-6 flex">
<div class="boxed">
    <p><strong>🐾 Example</strong></p>
    <p>Kittens spread out across the apartment. You want to pet everyone, but you're lazy and don't like walking. What is the shortest route to visit all fluffs? This is ~ <code>N!</code> comparisons.</p>
</div>
</div>
<div class="col-xs-12 col-sm-6">
<figure>
  <img alt="Factorial time" src="08-factorial.jpg" class="img-bordered-thin">
</figure>
</div>
</div>
<h2 id="summary">Summary</h2>
<p>Here are the algorithms we&rsquo;ve covered:</p>
<ul>
<li>Constant <code>O(1)</code></li>
<li>Logarithmic <code>O(log n)</code></li>
<li>Linear <code>O(n)</code></li>
<li>Log-Linear <code>O(n log n)</code></li>
<li>Quadratic <code>O(n²)</code></li>
<li>Polynomial <code>O(nᵏ)</code></li>
<li>Exponential <code>O(2ⁿ)</code></li>
<li>Factorial <code>O(n!)</code></li>
</ul>
<p>A constant algorithm is always the best option, and a logarithmic one is almost always. Linear and polynomial ones are more complex — it all depends on the task with them. Sometimes it&rsquo;s a shame to choose <code>O(n)</code>, and sometimes <code>O(n²)</code> is a huge success.</p>
<p><code>O(2ⁿ)</code> and <code>O(n!)</code> are insanely slow. So in practice, people often use suboptimal but fast algorithms.</p>
]]></content:encoded></item><item><title>User-Defined Functions in SQLite</title><link>https://antonz.org/sqlean-define/</link><pubDate>Thu, 08 Sep 2022 15:30:00 +0000</pubDate><guid>https://antonz.org/sqlean-define/</guid><description>Write functions in plain SQL.</description><content:encoded><![CDATA[<p>Most database engines provide a lot of built-in functions. Still, sometimes they are not enough, and people turn to writing their own — <em>user-defined</em> — functions in plain SQL or some SQL-based language (like pl/sql in Oracle or pl/pgsql in Postgres).</p>
<p>SQLite does not support user-defined functions by default. But you can easily enable them using the <code>define</code> extension.</p>
<p><strong>Note</strong>. Unlike other DBMS, adding extensions in SQLite is a breeze. Download a file, run one database command — and you are good to go.</p>
<h2 id="custom-functions">Custom Functions</h2>
<p>With <code>define</code> writing a custom function becomes as easy as:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#a90d91">select</span> <span style="color:#000">define</span>(<span style="color:#c41a16">&#39;sumn&#39;</span>, <span style="color:#c41a16">&#39;:n * (:n + 1) / 2&#39;</span>);
</code></pre></div><p>And then using it as any built-in function:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#a90d91">select</span> <span style="color:#000">sumn</span>(<span style="color:#1c01ce">5</span>);
<span style="color:#177500">-- 15
</span></code></pre></div><p>User-defined functions can take multiple parameters and call other functions.</p>
<p>Generate a random <code>N</code> such that <code>a ≤ N ≤ b</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#a90d91">select</span> <span style="color:#000">define</span>(<span style="color:#c41a16">&#39;randint&#39;</span>, <span style="color:#c41a16">&#39;:a + abs(random()) % (:b - :a + 1)&#39;</span>);
<span style="color:#a90d91">select</span> <span style="color:#000">randint</span>(<span style="color:#1c01ce">10</span>, <span style="color:#1c01ce">99</span>);
<span style="color:#177500">-- 42
</span><span style="color:#177500"></span><span style="color:#a90d91">select</span> <span style="color:#000">randint</span>(<span style="color:#1c01ce">10</span>, <span style="color:#1c01ce">99</span>);
<span style="color:#177500">-- 17
</span><span style="color:#177500"></span><span style="color:#a90d91">select</span> <span style="color:#000">randint</span>(<span style="color:#1c01ce">10</span>, <span style="color:#1c01ce">99</span>);
<span style="color:#177500">-- 29
</span></code></pre></div><p>List user-defined functions:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#a90d91">select</span> <span style="color:#000">*</span> <span style="color:#a90d91">from</span> <span style="color:#000">sqlean_define</span>;
</code></pre></div><p>Delete a function:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#a90d91">select</span> <span style="color:#000">undefine</span>(<span style="color:#c41a16">&#39;sumn&#39;</span>);
</code></pre></div><p>There is even a way to return multiple values from a function!</p>
<h2 id="dynamic-sql">Dynamic SQL</h2>
<p>To dynamically compose an SQL query and execute it without creating a function, use <code>eval()</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#a90d91">select</span> <span style="color:#000">eval</span>(<span style="color:#c41a16">&#39;select 10 + 32&#39;</span>);
<span style="color:#177500">-- 42
</span></code></pre></div><p>Supports any DDL or DML queries:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#a90d91">select</span> <span style="color:#000">eval</span>(<span style="color:#c41a16">&#39;create table tmp(value int)&#39;</span>);
<span style="color:#a90d91">select</span> <span style="color:#000">eval</span>(<span style="color:#c41a16">&#39;insert into tmp(value) values (1), (2), (3)&#39;</span>);
<span style="color:#a90d91">select</span> <span style="color:#000">eval</span>(<span style="color:#c41a16">&#39;select value from tmp&#39;</span>);
<span style="color:#a90d91">select</span> <span style="color:#000">eval</span>(<span style="color:#c41a16">&#39;drop table tmp&#39;</span>);
</code></pre></div><h2 id="installation-and-usage">Installation and Usage</h2>
<ol>
<li>
<p>Download the <a href="https://github.com/nalgeon/sqlean/releases/latest">latest release</a></p>
</li>
<li>
<p>Use with SQLite command-line interface:</p>
</li>
</ol>
<pre tabindex="0"><code>sqlite&gt; .load ./define
sqlite&gt; select define('sumn', ':n * (:n + 1) / 2');
sqlite&gt; select sumn(5);
</code></pre><p>See <a href="https://github.com/nalgeon/sqlean/blob/main/docs/install.md">How to Install an Extension</a> for usage with IDE, Python, etc.</p>
<p>See <a href="https://github.com/nalgeon/sqlean/blob/main/docs/define.md">Extension Documentation</a> for reference.</p>
]]></content:encoded></item><item><title>JSON Lines</title><link>https://antonz.org/json-lines/</link><pubDate>Thu, 04 Aug 2022 18:30:00 +0000</pubDate><guid>https://antonz.org/json-lines/</guid><description>CSV on steroids.</description><content:encoded><![CDATA[<p>Worked with the <a href="https://jsonlines.org/">JSON Lines</a> format the other day. It&rsquo;s a CSV on steroids:</p>
<ul>
<li>each entry is a separate line, as in CSV;</li>
<li>at the same time it is a full-fledged JSON.</li>
</ul>
<p>For example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{ <span style="color:#000">&#34;id&#34;</span>:<span style="color:#1c01ce">11</span>, <span style="color:#000">&#34;name&#34;</span>:<span style="color:#c41a16">&#34;Diane&#34;</span>, <span style="color:#000">&#34;city&#34;</span>:<span style="color:#c41a16">&#34;London&#34;</span>, <span style="color:#000">&#34;department&#34;</span>:<span style="color:#c41a16">&#34;hr&#34;</span>, <span style="color:#000">&#34;salary&#34;</span>:<span style="color:#1c01ce">70</span> }
{ <span style="color:#000">&#34;id&#34;</span>:<span style="color:#1c01ce">12</span>, <span style="color:#000">&#34;name&#34;</span>:<span style="color:#c41a16">&#34;Bob&#34;</span>, <span style="color:#000">&#34;city&#34;</span>:<span style="color:#c41a16">&#34;London&#34;</span>, <span style="color:#000">&#34;department&#34;</span>:<span style="color:#c41a16">&#34;hr&#34;</span>, <span style="color:#000">&#34;salary&#34;</span>:<span style="color:#1c01ce">78</span> }
{ <span style="color:#000">&#34;id&#34;</span>:<span style="color:#1c01ce">21</span>, <span style="color:#000">&#34;name&#34;</span>:<span style="color:#c41a16">&#34;Emma&#34;</span>, <span style="color:#000">&#34;city&#34;</span>:<span style="color:#c41a16">&#34;London&#34;</span>, <span style="color:#000">&#34;department&#34;</span>:<span style="color:#c41a16">&#34;it&#34;</span>, <span style="color:#000">&#34;salary&#34;</span>:<span style="color:#1c01ce">84</span> }
{ <span style="color:#000">&#34;id&#34;</span>:<span style="color:#1c01ce">22</span>, <span style="color:#000">&#34;name&#34;</span>:<span style="color:#c41a16">&#34;Grace&#34;</span>, <span style="color:#000">&#34;city&#34;</span>:<span style="color:#c41a16">&#34;Berlin&#34;</span>, <span style="color:#000">&#34;department&#34;</span>:<span style="color:#c41a16">&#34;it&#34;</span>, <span style="color:#000">&#34;salary&#34;</span>:<span style="color:#1c01ce">90</span>}
{ <span style="color:#000">&#34;id&#34;</span>:<span style="color:#1c01ce">23</span>, <span style="color:#000">&#34;name&#34;</span>:<span style="color:#c41a16">&#34;Henry&#34;</span>, <span style="color:#000">&#34;city&#34;</span>:<span style="color:#c41a16">&#34;London&#34;</span>, <span style="color:#000">&#34;department&#34;</span>:<span style="color:#c41a16">&#34;it&#34;</span>, <span style="color:#000">&#34;salary&#34;</span>:<span style="color:#1c01ce">104</span>}
</code></pre></div><p>Great stuff:</p>
<ul>
<li>Suitable for objects of complex structure (unlike csv);</li>
<li>Easy to stream read without loading the entire file into memory (unlike json);</li>
<li>Easy to append new entries to an existing file (unlike json).</li>
</ul>
<p>JSON can also be streamed. But look how much easier it is with JSON Lines:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a90d91">import</span> <span style="color:#000">json</span>
<span style="color:#a90d91">from</span> <span style="color:#000">typing</span> <span style="color:#a90d91">import</span> <span style="color:#000">Iterator</span>


<span style="color:#a90d91">def</span> <span style="color:#000">jl_reader</span>(<span style="color:#000">fname</span>: <span style="color:#a90d91">str</span>) <span style="color:#000">-&gt;</span> <span style="color:#000">Iterator</span>[<span style="color:#a90d91">dict</span>]:
    <span style="color:#a90d91">with</span> <span style="color:#a90d91">open</span>(<span style="color:#000">fname</span>) <span style="color:#a90d91">as</span> <span style="color:#000">file</span>:
        <span style="color:#a90d91">for</span> <span style="color:#000">line</span> <span style="color:#000">in</span> <span style="color:#000">file</span>:
            <span style="color:#000">obj</span> <span style="color:#000">=</span> <span style="color:#000">json</span><span style="color:#000">.</span><span style="color:#000">loads</span>(<span style="color:#000">line</span><span style="color:#000">.</span><span style="color:#000">strip</span>())
            <span style="color:#a90d91">yield</span> <span style="color:#000">obj</span>


<span style="color:#a90d91">if</span> <span style="color:#000">__name__</span> <span style="color:#000">==</span> <span style="color:#c41a16">&#34;__main__&#34;</span>:
    <span style="color:#000">reader</span> <span style="color:#000">=</span> <span style="color:#000">jl_reader</span>(<span style="color:#c41a16">&#34;employees.jl&#34;</span>)
    <span style="color:#a90d91">for</span> <span style="color:#000">employee</span> <span style="color:#000">in</span> <span style="color:#000">reader</span>:
        <span style="color:#a90d91">id</span> <span style="color:#000">=</span> <span style="color:#000">employee</span>[<span style="color:#c41a16">&#34;id&#34;</span>]
        <span style="color:#000">name</span> <span style="color:#000">=</span> <span style="color:#000">employee</span>[<span style="color:#c41a16">&#34;name&#34;</span>]
        <span style="color:#000">dept</span> <span style="color:#000">=</span> <span style="color:#000">employee</span>[<span style="color:#c41a16">&#34;department&#34;</span>]
        <span style="color:#a90d91">print</span>(<span style="color:#c41a16">f</span><span style="color:#c41a16">&#34;#</span><span style="color:#c41a16">{</span><span style="color:#a90d91">id</span><span style="color:#c41a16">}</span><span style="color:#c41a16"> - </span><span style="color:#c41a16">{</span><span style="color:#000">name</span><span style="color:#c41a16">}</span><span style="color:#c41a16"> (</span><span style="color:#c41a16">{</span><span style="color:#000">dept</span><span style="color:#c41a16">}</span><span style="color:#c41a16">)&#34;</span>)
</code></pre></div><pre tabindex="0"><code>#11 - Diane (hr)
#12 - Bob (hr)
#21 - Emma (it)
#22 - Grace (it)
#23 - Henry (it)
</code></pre><p><a href="https://replit.com/@antonz/json-lines#main.py">playground</a></p>
<p>Great fit for logs and data processing pipelines.</p>
]]></content:encoded></item></channel></rss>