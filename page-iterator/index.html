<!doctype html><html lang=en>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Page iterator in Python</title>
<meta name=description content="Traverse dataset in pages for faster batch processing.">
<meta name=robots content="index, follow">
<link rel=stylesheet type=text/css href=/assets/css/style.7d56395be0aff259a969d2f462b790a6013305c4529081baa7da9e04775a50fd.css>
<link rel=icon href=/assets/favicon/favicon.ico sizes=any>
<link rel=icon type=image/svg+xml href=/assets/favicon/favicon.svg>
<link rel=apple-touch-icon href=/assets/favicon/apple-touch-icon.png>
<link rel=manifest href=/assets/favicon/manifest.json>
<link rel=canonical href=https://antonz.org/page-iterator/>
<meta name=author content="Anton Zhiyanov">
<meta property="og:type" content="article">
<meta property="og:title" content="Page iterator in Python">
<meta property="og:description" content="Traverse dataset in pages for faster batch processing.">
<meta property="og:url" content="https://antonz.org/page-iterator/">
<meta property="og:image" content="https://antonz.org/page-iterator/cover.png">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:title content="Page iterator in Python">
<meta name=twitter:description content="Traverse dataset in pages for faster batch processing.">
<meta name=twitter:url content="https://antonz.org/page-iterator/">
<meta name=twitter:site content="@ohmypy">
<meta name=twitter:image content="https://antonz.org/page-iterator/cover.png"></head>
<body>
<div class=header>
<div class=container>
<div class=row>
<div class="col-xs-6 col-sm-3">
<a class=img-link href=/>
<img src=/assets/logo.svg class=header-icon>
</a>Â 
<a href=/>
<strong>Anton Zhiyanov</strong>
</a>
</div>
<div class="col-xs-12 col-sm-6 col-md-4 hidden-mobile">
<a class=menu__link href=/all/>
<span>blog</span>
</a>
<a class=menu__link href=/#about>
<span>contacts</span>
</a>
<a class=menu__link href=https://antonz.ru>
<span>ru</span>
</a>
</div>
</div>
</div>
</div>
<div class=storey>
<div class=container>
<article class=post>
<div class=row>
<div class="col-xs-12 col-sm-10 article">
<header>
<h1>Page iterator in Python</h1>
</header>
<p>Suppose you are counting stats for a huge dataset of toys sold across the country over the past year:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#000>reader</span> <span style=color:#000>=</span> <span style=color:#000>fetch_toys</span>()
<span style=color:#a90d91>for</span> <span style=color:#000>item</span> <span style=color:#000>in</span> <span style=color:#000>reader</span>:
    <span style=color:#000>process_single</span>(<span style=color:#000>item</span>)
</code></pre></div><p><code>process_single()</code> takes 10Â ms, so 400Â million toys will be processed in 46Â days ðŸ˜±</p>
<p>After a number of intense conversations, you manage to convince the developers that it&rsquo;s not very fast. <code>process_batch()</code> function enters the scene. It processes 10,000 toys in 1Â second. It means 11Â hours for all the toys â€” much nicer.</p>
<p>Now we need to iterate over the dataset in batches of 10Â thousand records. This is where the page iterator comes in handy!</p>
<h2 id=naive-paginator>Naive paginator</h2>
<p>Let&rsquo;s go through the initial sequence, gradually filling the page. As soon as it is filled, return it through <code>yield</code> and start filling in the next one. Continue until the original sequence is exhausted:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#a90d91>def</span> <span style=color:#000>paginate</span>(<span style=color:#000>iterable</span>, <span style=color:#000>page_size</span>):
    <span style=color:#000>page</span> <span style=color:#000>=</span> []
    <span style=color:#a90d91>for</span> <span style=color:#000>item</span> <span style=color:#000>in</span> <span style=color:#000>iterable</span>:
        <span style=color:#000>page</span><span style=color:#000>.</span><span style=color:#000>append</span>(<span style=color:#000>item</span>)
        <span style=color:#a90d91>if</span> <span style=color:#a90d91>len</span>(<span style=color:#000>page</span>) <span style=color:#000>==</span> <span style=color:#000>page_size</span>:
            <span style=color:#a90d91>yield</span> <span style=color:#000>page</span>
            <span style=color:#000>page</span> <span style=color:#000>=</span> []
    <span style=color:#a90d91>yield</span> <span style=color:#000>page</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#000>reader</span> <span style=color:#000>=</span> <span style=color:#000>fetch_toys</span>()
<span style=color:#000>page_size</span> <span style=color:#000>=</span> <span style=color:#1c01ce>10_000</span>
<span style=color:#a90d91>for</span> <span style=color:#000>page</span> <span style=color:#000>in</span> <span style=color:#000>paginate</span>(<span style=color:#000>reader</span>, <span style=color:#000>page_size</span>):
    <span style=color:#000>process_batch</span>(<span style=color:#000>page</span>)
</code></pre></div><p>The implementation is working, but there is a problem. Such page-by-page traversal is noticeably slower than the one-by-one iteration.</p>
<h2 id=iteration-speed>Iteration speed</h2>
<p>Let&rsquo;s compare two traversals â€” one-by-one and paginated:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#a90d91>def</span> <span style=color:#000>one_by_one</span>(<span style=color:#000>a</span>, <span style=color:#000>b</span>):
    <span style=color:#c41a16>&#34;&#34;&#34;Processes records one-by-one, without pagination&#34;&#34;&#34;</span>
    <span style=color:#000>rdr</span> <span style=color:#000>=</span> <span style=color:#000>reader</span>(<span style=color:#000>a</span>, <span style=color:#000>b</span>)
    <span style=color:#a90d91>for</span> <span style=color:#000>record</span> <span style=color:#000>in</span> <span style=color:#000>rdr</span>:
        <span style=color:#000>process_single</span>(<span style=color:#000>record</span>)

<span style=color:#a90d91>def</span> <span style=color:#000>batch</span>(<span style=color:#000>page_size</span>, <span style=color:#000>a</span>, <span style=color:#000>b</span>):
    <span style=color:#c41a16>&#34;&#34;&#34;Processes records in batches, with pagination&#34;&#34;&#34;</span>
    <span style=color:#000>rdr</span> <span style=color:#000>=</span> <span style=color:#000>reader</span>(<span style=color:#000>a</span>, <span style=color:#000>b</span>)
    <span style=color:#a90d91>for</span> <span style=color:#000>page</span> <span style=color:#000>in</span> <span style=color:#000>paginate</span>(<span style=color:#000>rdr</span>, <span style=color:#000>page_size</span>):
        <span style=color:#000>process_batch</span>(<span style=color:#000>page</span>)

<span style=color:#000>times</span> <span style=color:#000>=</span> <span style=color:#1c01ce>10</span>

<span style=color:#000>page_size</span> <span style=color:#000>=</span> <span style=color:#1c01ce>10_000</span>
<span style=color:#000>a</span> <span style=color:#000>=</span> <span style=color:#1c01ce>1_000_000</span>
<span style=color:#000>b</span> <span style=color:#000>=</span> <span style=color:#1c01ce>2_000_000</span>

<span style=color:#000>fn</span> <span style=color:#000>=</span> <span style=color:#a90d91>lambda</span>: <span style=color:#000>one_by_one</span>(<span style=color:#000>a</span>, <span style=color:#000>b</span>)
<span style=color:#000>total</span> <span style=color:#000>=</span> <span style=color:#000>timeit</span><span style=color:#000>.</span><span style=color:#000>timeit</span>(<span style=color:#000>fn</span>, <span style=color:#000>number</span><span style=color:#000>=</span><span style=color:#000>times</span>)
<span style=color:#000>it_time</span> <span style=color:#000>=</span> <span style=color:#a90d91>round</span>(<span style=color:#000>total</span> <span style=color:#000>*</span> <span style=color:#1c01ce>1000</span> <span style=color:#000>/</span> <span style=color:#000>times</span>)
<span style=color:#a90d91>print</span>(<span style=color:#c41a16>f</span><span style=color:#c41a16>&#34;One-by-one (baseline): </span><span style=color:#c41a16>{</span><span style=color:#000>it_time</span><span style=color:#c41a16>}</span><span style=color:#c41a16> ms&#34;</span>)

<span style=color:#000>fn</span> <span style=color:#000>=</span> <span style=color:#a90d91>lambda</span>: <span style=color:#000>batch</span>(<span style=color:#000>page_size</span>, <span style=color:#000>a</span>, <span style=color:#000>b</span>)
<span style=color:#000>total</span> <span style=color:#000>=</span> <span style=color:#000>timeit</span><span style=color:#000>.</span><span style=color:#000>timeit</span>(<span style=color:#000>fn</span>, <span style=color:#000>number</span><span style=color:#000>=</span><span style=color:#000>times</span>)
<span style=color:#000>it_time</span> <span style=color:#000>=</span> <span style=color:#a90d91>round</span>(<span style=color:#000>total</span> <span style=color:#000>*</span> <span style=color:#1c01ce>1000</span> <span style=color:#000>/</span> <span style=color:#000>times</span>)
<span style=color:#a90d91>print</span>(<span style=color:#c41a16>f</span><span style=color:#c41a16>&#34;Fill page with append(): </span><span style=color:#c41a16>{</span><span style=color:#000>it_time</span><span style=color:#c41a16>}</span><span style=color:#c41a16> ms&#34;</span>)
</code></pre></div><p>Here is the result for 1Â million records and a page size of 10Â thousand:</p>
<pre tabindex=0><code>One-by-one (baseline):   161 ms
Fill page with append(): 227 ms
</code></pre><p>Page-by-page iteration is almost 1.5 times slower!</p>
<p>At each iteration of the loop, we create a new empty list and then gradually fill it in. Python has to constantly increase the size of the underlying array, and this is an expensive operation â€” O(n) of the number of elements in the list.</p>
<h2 id=fixed-page-size>Fixed page size</h2>
<p>Let&rsquo;s create a list of the required size in advance and use it for all pages:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#a90d91>def</span> <span style=color:#000>paginate</span>(<span style=color:#000>iterable</span>, <span style=color:#000>page_size</span>):
    <span style=color:#000>page</span> <span style=color:#000>=</span> [<span style=color:#a90d91>None</span>] <span style=color:#000>*</span> <span style=color:#000>page_size</span>
    <span style=color:#000>idx</span> <span style=color:#000>=</span> <span style=color:#1c01ce>0</span>
    <span style=color:#a90d91>for</span> <span style=color:#000>item</span> <span style=color:#000>in</span> <span style=color:#000>iterable</span>:
        <span style=color:#000>page</span>[<span style=color:#000>idx</span>] <span style=color:#000>=</span> <span style=color:#000>item</span>
        <span style=color:#000>idx</span> <span style=color:#000>+=</span> <span style=color:#1c01ce>1</span>
        <span style=color:#a90d91>if</span> <span style=color:#000>idx</span> <span style=color:#000>==</span> <span style=color:#000>page_size</span>:
            <span style=color:#a90d91>yield</span> <span style=color:#000>page</span>
            <span style=color:#000>idx</span> <span style=color:#000>=</span> <span style=color:#1c01ce>0</span>
    <span style=color:#a90d91>yield</span> <span style=color:#000>page</span>[:<span style=color:#000>idx</span>]
</code></pre></div><p>Compare once again:</p>
<pre tabindex=0><code>One-by-one (baseline):   161 ms
Fill page with append(): 227 ms
Use fixed-size page:     162 ms
</code></pre><p>Much faster! Fixed page algorithm is as fast as the ordinary one-by-one traversal.</p>
<h2 id=slicing-iterator>Slicing iterator</h2>
<p>Can we do even better? Algorithmically, no. But practically, yes â€” if we move most of the operations from Python code to C library code. The <code>itertools()</code> module and its <code>islice()</code> function may help:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#a90d91>def</span> <span style=color:#000>paginate</span>(<span style=color:#000>iterable</span>, <span style=color:#000>page_size</span>):
    <span style=color:#000>it</span> <span style=color:#000>=</span> <span style=color:#a90d91>iter</span>(<span style=color:#000>iterable</span>)
    <span style=color:#000>slicer</span> <span style=color:#000>=</span> <span style=color:#a90d91>lambda</span>: <span style=color:#a90d91>list</span>(<span style=color:#000>itertools</span><span style=color:#000>.</span><span style=color:#000>islice</span>(<span style=color:#000>it</span>, <span style=color:#000>page_size</span>))
    <span style=color:#a90d91>return</span> <span style=color:#a90d91>iter</span>(<span style=color:#000>slicer</span>, [])
</code></pre></div><p>Here is what&rsquo;s going on:</p>
<ul>
<li><code>islice()</code> creates an iterator (let&rsquo;s call it a slicer) that traverses the passed sequence until it yields <code>page_size</code> elements;</li>
<li><code>list()</code> fetches elements from the slicer, thus creating a page;</li>
<li>since <code>islice()</code> runs on top of the main iterator, the next time it is called, it will continue from the same place where it left off before;</li>
<li>the <code>iter(slicer, [])</code> expression creates an iterator that calls the slicer at each step;</li>
<li>thus, the <code>paginate()</code> function returns an iterator, which at each step yields the next page through the slicer, traversing the main sequence until it ends.</li>
</ul>
<p>Look how good this implementation is:</p>
<pre tabindex=0><code>One-by-one (baseline):   161 ms
Fill page with append(): 227 ms
Use fixed-size page:     162 ms
Use islice:               93 ms
</code></pre><p>40% faster than the one-by-one iterator!</p>
<h2 id=summary>Summary</h2>
<p>Page-by-page traversal works fine whenever a batch operation is much faster than a sequence of single operations. In order not to implement such traversal every time from scratch, it is convenient to use a <em>page iterator</em>.</p>
<p>Filling the page with <code>.append()</code> is slow due to array resizing. It is better to use a fixed-size list, or even better, iteration based on <code>itertools.islice()</code></p>
<p>Totally recommend it.</p>
<p><a href=https://replit.com/@antonz/page-iterator#main.py>Playground</a></p>
<p><em>Follow <a href=https://twitter.com/ohmypy><strong>@ohmypy</strong></a> on Twitter to keep up with new posts</em>Â ðŸš€</p>
</div>
</div><footer class=post__footer>
<div class=row>
<div class=col-xs-12>
<div class=post__date>
<time datetime="2022-05-02 13:00:00 +0000 UTC">02 May, 2022</time>
</div>
<div class=post__tags>
<a href=https://antonz.org/tags/python/>python</a>&nbsp;
</div>
</div>
</div>
</footer></article>
<aside class=post__related>
<div class="post__nav article">
<div class=row>
<div class="col-xs-12 col-sm-6">
<p>&larr;&nbsp;<a href=https://antonz.org/sqlite-multiline/>Multi-line queries in SQLite shell</a></p>
</div>
<div class="col-xs-12 col-sm-6">
<p><a href=https://antonz.org/generated-columns/>Generated columns in SQLite</a>&nbsp;&rarr;</p>
</div>
</div>
</div>
<div class=article>
<div class=row>
<div class="col-xs-12 col-sm-8 col-md-6">
<h3>See also</h3>
<p><a href=/functools-cache/>Caching slow functions in Python</a></p>
<p><a href=/list-internals/>How Python List Works</a></p>
<p><a href=/python-packaging/>How to make an awesome Python package</a></p>
</div>
</div>
</div>
</aside>
</div>
</div>
<footer class="container footer">
<ul class=naked-list>
<li class=footer__item>Subscribe:
<a href=https://twitter.com/ohmypy class=footer__social-link><i class="fab fa-twitter"></i><span>Twitter</span></a>
<a href=/index.xml class=footer__social-link><i class="fas fa-rss"></i><span>RSS</span></a>
</li>
<li class=footer__item>Email: <a href=mailto:m@antonz.org>m@antonz.org</a></li>
</ul>
</footer>
<script async src=//gc.zgo.at/count.js data-goatcounter=https://antonzorg.goatcounter.com/count></script></body>
</html>