<!doctype html><html lang=en>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Building a Pivot Table in SQLite</title>
<meta name=description content="Three ways to create a pivot table in plain SQL.">
<meta name=robots content="index, follow">
<link rel=stylesheet type=text/css href=/assets/css/style.7b92d52bc84587cbff51e4a3ef245f9969b935c1661c909b93dc72fd0fb4b717.css>
<link rel=icon href=/assets/favicon/favicon.ico sizes=any>
<link rel=icon type=image/svg+xml href=/assets/favicon/favicon.svg>
<link rel=apple-touch-icon href=/assets/favicon/apple-touch-icon.png>
<link rel=manifest href=/assets/favicon/manifest.json>
<link rel=canonical href=https://antonz.org/sqlite-pivot-table/>
<meta name=author content="Anton Zhiyanov">
<meta property="og:type" content="article">
<meta property="og:title" content="Building a Pivot Table in SQLite">
<meta property="og:description" content="Three ways to create a pivot table in plain SQL.">
<meta property="og:url" content="https://antonz.org/sqlite-pivot-table/">
<meta property="og:image" content="https://antonz.org/sqlite-pivot-table/cover.png">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:title content="Building a Pivot Table in SQLite">
<meta name=twitter:description content="Three ways to create a pivot table in plain SQL.">
<meta name=twitter:url content="https://antonz.org/sqlite-pivot-table/">
<meta name=twitter:site content="@ohmypy">
<meta name=twitter:image content="https://antonz.org/sqlite-pivot-table/cover.png"></head>
<body>
<div class=header>
<div class=container>
<div class=row>
<div class="col-xs-6 col-sm-3">
<a class=img-link href=/>
<img src=/assets/logo.svg class=header-icon>
</a>Â 
<a href=/>
<strong>Anton Zhiyanov</strong>
</a>
</div>
<div class="col-xs-12 col-sm-6 col-md-4 hidden-mobile">
<a class=menu__link href=/all/>
<span>blog</span>
</a>
<a class=menu__link href=/#about>
<span>contacts</span>
</a>
<a class=menu__link href=https://antonz.ru>
<span>ru</span>
</a>
</div>
<div class="col-xs-6 col-sm-3"><div class=search-module>
<form action=https://duckduckgo.com/>
<input type=hidden name=kf value=-1>
<input type=hidden name=kz value=-1>
<input type=hidden name=kaf value=1>
<input type=hidden name=ko value=-2>
<input type=hidden name=k1 value=-1>
<input type=hidden name=sites value=antonz.org>
<input type=search name=q autocomplete=off placeholder=Search aria-label=Search>
</form>
</div></div>
</div>
</div>
</div>
<div class=storey>
<div class=container>
<article class=post>
<div class=row>
<div class="col-xs-12 col-sm-10 article">
<header>
<h1>Building a Pivot Table in SQLite</h1>
</header>
<p>Suppose we have a <code>sales</code> table with product incomes for the years 2020-2023:</p>
<pre tabindex=0><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ product â”‚ year â”‚ income â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ alpha   â”‚ 2020 â”‚ 100    â”‚
â”‚ alpha   â”‚ 2021 â”‚ 120    â”‚
â”‚ alpha   â”‚ 2022 â”‚ 130    â”‚
â”‚ alpha   â”‚ 2023 â”‚ 140    â”‚
â”‚ beta    â”‚ 2020 â”‚ 10     â”‚
â”‚ beta    â”‚ 2021 â”‚ 20     â”‚
â”‚ beta    â”‚ 2022 â”‚ 40     â”‚
â”‚ beta    â”‚ 2023 â”‚ 80     â”‚
â”‚ gamma   â”‚ 2020 â”‚ 80     â”‚
â”‚ gamma   â”‚ 2021 â”‚ 75     â”‚
â”‚ gamma   â”‚ 2022 â”‚ 78     â”‚
â”‚ gamma   â”‚ 2023 â”‚ 80     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre><p><a href=https://sqlime.org/#gist:4a46833d948e8635593fec028eb178ba>playground</a> â€¢ <a href=./sales.sql>download</a></p>
<p>And we want to transform it into a so-called <em>pivot table</em>, where products serve as rows and years serve as columns:</p>
<pre tabindex=0><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”
â”‚ product â”‚ 2020 â”‚ 2021 â”‚ 2022 â”‚ 2023 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤
â”‚ alpha   â”‚ 100  â”‚ 120  â”‚ 130  â”‚ 140  â”‚
â”‚ beta    â”‚ 10   â”‚ 20   â”‚ 40   â”‚ 80   â”‚
â”‚ gamma   â”‚ 80   â”‚ 75   â”‚ 78   â”‚ 80   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜
</code></pre><p>Some DBMS, like SQL Server, have a custom <code>pivot</code> operator to do this. SQLite does not. Still, there are multiple ways to solve the problem. Let&rsquo;s examine them.</p>
<h2 id=1-filtered-totals>1. Filtered totals</h2>
<p>Let&rsquo;s manually extract each year in a separate column and calculate a filtered total income for that year:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#a90d91>select</span>
  <span style=color:#000>product</span>,
  <span style=color:#a90d91>sum</span>(<span style=color:#000>income</span>) <span style=color:#000>filter</span> (<span style=color:#a90d91>where</span> <span style=color:#a90d91>year</span> <span style=color:#000>=</span> <span style=color:#1c01ce>2020</span>) <span style=color:#a90d91>as</span> <span style=color:#c41a16>&#34;2020&#34;</span>,
  <span style=color:#a90d91>sum</span>(<span style=color:#000>income</span>) <span style=color:#000>filter</span> (<span style=color:#a90d91>where</span> <span style=color:#a90d91>year</span> <span style=color:#000>=</span> <span style=color:#1c01ce>2021</span>) <span style=color:#a90d91>as</span> <span style=color:#c41a16>&#34;2021&#34;</span>,
  <span style=color:#a90d91>sum</span>(<span style=color:#000>income</span>) <span style=color:#000>filter</span> (<span style=color:#a90d91>where</span> <span style=color:#a90d91>year</span> <span style=color:#000>=</span> <span style=color:#1c01ce>2022</span>) <span style=color:#a90d91>as</span> <span style=color:#c41a16>&#34;2022&#34;</span>,
  <span style=color:#a90d91>sum</span>(<span style=color:#000>income</span>) <span style=color:#000>filter</span> (<span style=color:#a90d91>where</span> <span style=color:#a90d91>year</span> <span style=color:#000>=</span> <span style=color:#1c01ce>2023</span>) <span style=color:#a90d91>as</span> <span style=color:#c41a16>&#34;2023&#34;</span>
<span style=color:#a90d91>from</span> <span style=color:#000>sales</span>
<span style=color:#a90d91>group</span> <span style=color:#a90d91>by</span> <span style=color:#000>product</span>
<span style=color:#a90d91>order</span> <span style=color:#a90d91>by</span> <span style=color:#000>product</span>;
</code></pre></div><p>Here is our pivot table:</p>
<pre tabindex=0><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”
â”‚ product â”‚ 2020 â”‚ 2021 â”‚ 2022 â”‚ 2023 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤
â”‚ alpha   â”‚ 100  â”‚ 120  â”‚ 130  â”‚ 140  â”‚
â”‚ beta    â”‚ 10   â”‚ 20   â”‚ 40   â”‚ 80   â”‚
â”‚ gamma   â”‚ 80   â”‚ 75   â”‚ 78   â”‚ 80   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜
</code></pre><p>This universal method works in every DBMS, not only SQLite. Even if your DB engine does not support <code>filter</code>, you can always resort to using <code>case</code>:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#a90d91>select</span>
  <span style=color:#000>product</span>,
  <span style=color:#a90d91>sum</span>(<span style=color:#a90d91>case</span> <span style=color:#a90d91>when</span> <span style=color:#a90d91>year</span> <span style=color:#000>=</span> <span style=color:#1c01ce>2020</span> <span style=color:#a90d91>then</span> <span style=color:#000>income</span> <span style=color:#a90d91>end</span>) <span style=color:#a90d91>as</span> <span style=color:#c41a16>&#34;2020&#34;</span>,
  <span style=color:#a90d91>sum</span>(<span style=color:#a90d91>case</span> <span style=color:#a90d91>when</span> <span style=color:#a90d91>year</span> <span style=color:#000>=</span> <span style=color:#1c01ce>2021</span> <span style=color:#a90d91>then</span> <span style=color:#000>income</span> <span style=color:#a90d91>end</span>) <span style=color:#a90d91>as</span> <span style=color:#c41a16>&#34;2021&#34;</span>,
  <span style=color:#a90d91>sum</span>(<span style=color:#a90d91>case</span> <span style=color:#a90d91>when</span> <span style=color:#a90d91>year</span> <span style=color:#000>=</span> <span style=color:#1c01ce>2022</span> <span style=color:#a90d91>then</span> <span style=color:#000>income</span> <span style=color:#a90d91>end</span>) <span style=color:#a90d91>as</span> <span style=color:#c41a16>&#34;2022&#34;</span>,
  <span style=color:#a90d91>sum</span>(<span style=color:#a90d91>case</span> <span style=color:#a90d91>when</span> <span style=color:#a90d91>year</span> <span style=color:#000>=</span> <span style=color:#1c01ce>2023</span> <span style=color:#a90d91>then</span> <span style=color:#000>income</span> <span style=color:#a90d91>end</span>) <span style=color:#a90d91>as</span> <span style=color:#c41a16>&#34;2023&#34;</span>
<span style=color:#a90d91>from</span> <span style=color:#000>sales</span>
<span style=color:#a90d91>group</span> <span style=color:#a90d91>by</span> <span style=color:#000>product</span>
<span style=color:#a90d91>order</span> <span style=color:#a90d91>by</span> <span style=color:#000>product</span>;
</code></pre></div><details>
<summary class=summary-ai>explain</summary>
<div class=boxed>
<p><strong><abbr title="Generated by AI, verified by human">Human-verified explanation</abbr></strong></p>
<p>This SQL query shows the total income of each product for each year.</p>
<p>The first line of the query selects the <code>product</code> column from the table.</p>
<p>The next four lines use the <code>sum</code> function to calculate the total <code>income</code> for each year (2020, 2021, 2022, and 2023) using a <code>case</code> statement to only include income values where the <code>year</code> matches the specified year. The <code>as</code> keyword is used to give each calculated sum a column alias that corresponds to the year.</p>
<p>The <code>from</code> clause specifies that the data is being selected from the <code>sales</code> table.</p>
<p>The <code>group by</code> clause groups the data by <code>product</code>, which means that the query will return one row for each unique <code>product</code> value in the <code>sales</code> table.</p>
<p>Finally, the <code>order by</code> clause orders the results by <code>product</code> in ascending order.</p>
</div>
</details>
<p>Using <code>filter</code> is probably the easiest way when we know the columns in advance. But what if we don&rsquo;t?</p>
<h2 id=2-dynamic-sql>2. Dynamic SQL</h2>
<p>Let&rsquo;s build our query dynamically without hardcoding year values:</p>
<ol>
<li>Extract distinct year values.</li>
<li>Generate a <code>...filter (where year = X) as "X"</code> query line for each year.</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#a90d91>with</span> <span style=color:#000>years</span> <span style=color:#a90d91>as</span> (
  <span style=color:#a90d91>select</span> <span style=color:#a90d91>distinct</span> <span style=color:#a90d91>year</span> <span style=color:#a90d91>as</span> <span style=color:#a90d91>year</span>
  <span style=color:#a90d91>from</span> <span style=color:#000>sales</span>
),
<span style=color:#000>lines</span> <span style=color:#a90d91>as</span> (
  <span style=color:#a90d91>select</span> <span style=color:#c41a16>&#39;select product &#39;</span> <span style=color:#a90d91>as</span> <span style=color:#000>part</span>
  <span style=color:#a90d91>union</span> <span style=color:#a90d91>all</span>
  <span style=color:#a90d91>select</span> <span style=color:#c41a16>&#39;, sum(income) filter (where year = &#39;</span> <span style=color:#000>||</span> <span style=color:#a90d91>year</span> <span style=color:#000>||</span> <span style=color:#c41a16>&#39;) as &#34;&#39;</span> <span style=color:#000>||</span> <span style=color:#a90d91>year</span> <span style=color:#000>||</span> <span style=color:#c41a16>&#39;&#34; &#39;</span>
  <span style=color:#a90d91>from</span> <span style=color:#000>years</span>
  <span style=color:#a90d91>union</span> <span style=color:#a90d91>all</span>
  <span style=color:#a90d91>select</span> <span style=color:#c41a16>&#39;from sales group by product order by product;&#39;</span>
)
<span style=color:#a90d91>select</span> <span style=color:#000>group_concat</span>(<span style=color:#000>part</span>, <span style=color:#c41a16>&#39;&#39;</span>)
<span style=color:#a90d91>from</span> <span style=color:#000>lines</span>;
</code></pre></div><p>This query returns the same SQL we wrote manually at the previous step (minus formatting):</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#a90d91>select</span> <span style=color:#000>product</span> , <span style=color:#a90d91>sum</span>(<span style=color:#000>income</span>) <span style=color:#000>filter</span> (<span style=color:#a90d91>where</span> <span style=color:#a90d91>year</span> <span style=color:#000>=</span> <span style=color:#1c01ce>2020</span>) <span style=color:#a90d91>as</span> <span style=color:#c41a16>&#34;2020&#34;</span> , <span style=color:#a90d91>sum</span>(<span style=color:#000>income</span>) <span style=color:#000>filter</span> (<span style=color:#a90d91>where</span> <span style=color:#a90d91>year</span> <span style=color:#000>=</span> <span style=color:#1c01ce>2021</span>) <span style=color:#a90d91>as</span> <span style=color:#c41a16>&#34;2021&#34;</span> , <span style=color:#a90d91>sum</span>(<span style=color:#000>income</span>) <span style=color:#000>filter</span> (<span style=color:#a90d91>where</span> <span style=color:#a90d91>year</span> <span style=color:#000>=</span> <span style=color:#1c01ce>2022</span>) <span style=color:#a90d91>as</span> <span style=color:#c41a16>&#34;2022&#34;</span> , <span style=color:#a90d91>sum</span>(<span style=color:#000>income</span>) <span style=color:#000>filter</span> (<span style=color:#a90d91>where</span> <span style=color:#a90d91>year</span> <span style=color:#000>=</span> <span style=color:#1c01ce>2023</span>) <span style=color:#a90d91>as</span> <span style=color:#c41a16>&#34;2023&#34;</span> <span style=color:#a90d91>from</span> <span style=color:#000>sales</span> <span style=color:#a90d91>group</span> <span style=color:#a90d91>by</span> <span style=color:#000>product</span> <span style=color:#a90d91>order</span> <span style=color:#a90d91>by</span> <span style=color:#000>product</span>;
</code></pre></div><p>Now we have to execute it. For that, let&rsquo;s use the <code>eval(sql)</code> function available as part of the <a href=https://github.com/nalgeon/sqlean/blob/main/docs/define.md><code>define</code></a> extension:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#a90d91>select</span> <span style=color:#000>load_extension</span>(<span style=color:#c41a16>&#39;./define&#39;</span>);

<span style=color:#a90d91>with</span> <span style=color:#000>years</span> <span style=color:#a90d91>as</span> (
  <span style=color:#a90d91>select</span> <span style=color:#a90d91>distinct</span> <span style=color:#a90d91>year</span> <span style=color:#a90d91>as</span> <span style=color:#a90d91>year</span>
  <span style=color:#a90d91>from</span> <span style=color:#000>sales</span>
),
<span style=color:#000>lines</span> <span style=color:#a90d91>as</span> (
  <span style=color:#a90d91>select</span> <span style=color:#c41a16>&#39;drop view if exists v_sales; &#39;</span> <span style=color:#a90d91>as</span> <span style=color:#000>part</span>
  <span style=color:#a90d91>union</span> <span style=color:#a90d91>all</span>
  <span style=color:#a90d91>select</span> <span style=color:#c41a16>&#39;create view v_sales as &#39;</span>
  <span style=color:#a90d91>union</span> <span style=color:#a90d91>all</span>
  <span style=color:#a90d91>select</span> <span style=color:#c41a16>&#39;select product &#39;</span>
  <span style=color:#a90d91>union</span> <span style=color:#a90d91>all</span>
  <span style=color:#a90d91>select</span> <span style=color:#c41a16>&#39;, sum(income) filter (where year = &#39;</span> <span style=color:#000>||</span> <span style=color:#a90d91>year</span> <span style=color:#000>||</span> <span style=color:#c41a16>&#39;) as &#34;&#39;</span> <span style=color:#000>||</span> <span style=color:#a90d91>year</span> <span style=color:#000>||</span> <span style=color:#c41a16>&#39;&#34; &#39;</span>
  <span style=color:#a90d91>from</span> <span style=color:#000>years</span>
  <span style=color:#a90d91>union</span> <span style=color:#a90d91>all</span>
  <span style=color:#a90d91>select</span> <span style=color:#c41a16>&#39;from sales group by product order by product;&#39;</span>
)
<span style=color:#a90d91>select</span> <span style=color:#000>eval</span>(<span style=color:#000>group_concat</span>(<span style=color:#000>part</span>, <span style=color:#c41a16>&#39;&#39;</span>))
<span style=color:#a90d91>from</span> <span style=color:#000>lines</span>;
</code></pre></div><details>
<summary class=summary-ai>explain</summary>
<div class=boxed>
<p><strong><abbr title="Generated by AI, verified by human">Human-verified explanation</abbr></strong></p>
<p>This SQL query creates a view named <code>v_sales</code> that shows the total income of each product for each year. The query uses a common table expression (CTE) to generate a list of distinct years from the <code>sales</code> table. Then, it defines another CTE named <code>lines</code> that contains a series of unioned select statements to generate the SQL commands to create the view.</p>
<p>The first select statement in <code>lines</code> generates a <code>drop view if exists</code> command to ensure that any previous version of the view is removed before creating the new one.</p>
<p>The second select statement generates a <code>create view</code> command to create the <code>v_sales</code> view.</p>
<p>The third select statement generates a <code>select</code> command to select the product column from the <code>sales</code> table.</p>
<p>The fourth select statement generates a <code>sum</code> command that sums the income for each product for a given year. It uses the <code>filter</code> clause to filter the sum by year. The year value is passed in from the <code>years</code> CTE using string concatenation.</p>
<p>The fifth select statement specifies the <code>from</code> and <code>group by</code> clauses for the SQL statement. It groups the results by product and orders them by product.</p>
<p>Finally, the last select statement concatenates all the SQL commands generated in the <code>lines</code> CTE using the <code>group_concat</code> function and evaluates the resulting SQL string using the <code>eval</code> function. The resulting SQL commands create the <code>v_sales</code> view with the desired structure.</p>
</div>
</details>
<p>Here, we are building a <code>v_sales</code> view which executes the query we&rsquo;ve constructed previously. Let&rsquo;s select the data from it:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#a90d91>select</span> <span style=color:#000>*</span> <span style=color:#a90d91>from</span> <span style=color:#000>v_sales</span>;
</code></pre></div><pre tabindex=0><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”
â”‚ product â”‚ 2020 â”‚ 2021 â”‚ 2022 â”‚ 2023 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤
â”‚ alpha   â”‚ 100  â”‚ 120  â”‚ 130  â”‚ 140  â”‚
â”‚ beta    â”‚ 10   â”‚ 20   â”‚ 40   â”‚ 80   â”‚
â”‚ gamma   â”‚ 80   â”‚ 75   â”‚ 78   â”‚ 80   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜
</code></pre><blockquote>
<p>Note: extensions do not work in the playground, so you&rsquo;ll have to use your local SQLite to reproduce this step.</p>
</blockquote>
<p>Nice!</p>
<h2 id=3-pivot-extension>3. Pivot extension</h2>
<p>If dynamic SQL seems too much for you, there is a more straightforward solution â€” the <a href=https://github.com/nalgeon/sqlean/issues/27#issuecomment-997052157><code>pivotvtab</code></a> extension.</p>
<p>With it, we only have to provide three selects to build a pivot:</p>
<ol>
<li>Select row values.</li>
<li>Select column values.</li>
<li>Select cell values.</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#a90d91>select</span> <span style=color:#000>load_extension</span>(<span style=color:#c41a16>&#39;./pivotvtab&#39;</span>);

<span style=color:#a90d91>create</span> <span style=color:#000>virtual</span> <span style=color:#a90d91>table</span> <span style=color:#000>v_sales</span> <span style=color:#a90d91>using</span> <span style=color:#000>pivot_vtab</span> (
  <span style=color:#177500>-- rows
</span><span style=color:#177500></span>  (<span style=color:#a90d91>select</span> <span style=color:#a90d91>distinct</span> <span style=color:#000>product</span> <span style=color:#a90d91>from</span> <span style=color:#000>sales</span>),
  <span style=color:#177500>-- columns
</span><span style=color:#177500></span>  (<span style=color:#a90d91>select</span> <span style=color:#a90d91>distinct</span> <span style=color:#a90d91>year</span>, <span style=color:#a90d91>year</span> <span style=color:#a90d91>from</span> <span style=color:#000>sales</span>),
  <span style=color:#177500>-- cells
</span><span style=color:#177500></span>  (<span style=color:#a90d91>select</span> <span style=color:#a90d91>sum</span>(<span style=color:#000>income</span>) <span style=color:#a90d91>from</span> <span style=color:#000>sales</span> <span style=color:#a90d91>where</span> <span style=color:#000>product</span> <span style=color:#000>=</span> <span style=color:#000>?</span><span style=color:#1c01ce>1</span> <span style=color:#a90d91>and</span> <span style=color:#a90d91>year</span> <span style=color:#000>=</span> <span style=color:#000>?</span><span style=color:#1c01ce>2</span>)
);
</code></pre></div><details>
<summary class=summary-ai>explain</summary>
<div class=boxed>
<p><strong><abbr title="Generated by AI, verified by human">Human-verified explanation</abbr></strong></p>
<p>This SQL query creates a virtual table called <code>v_sales</code> using the <code>pivot_vtab</code> module from the <code>pivotvtab</code> extension. A virtual table is a special type of table that does not store data on disk, but rather generates it on the fly based on a query.</p>
<p>The <code>pivot_vtab</code> command takes three arguments:</p>
<ol>
<li>A subquery that specifies the rows of the virtual table. In this case, the subquery selects all distinct values from the <code>product</code> column of the <code>sales</code> table.</li>
<li>A subquery that specifies the columns of the virtual table. In this case, the subquery selects all distinct values from the <code>year</code> column of the <code>sales</code> table, and duplicates them. This is because the <code>pivot_vtab</code> module expects two values for each column, one for the column value and one for the column name. By duplicating the <code>year</code> value, we are effectively using it as both the value and name for the column.</li>
<li>A subquery that specifies the values of the virtual table. In this case, the subquery selects the sum of the <code>income</code> column from the <code>sales</code> table for a specific <code>product</code> and <code>year</code> combination. The <code>?1</code> and <code>?2</code> placeholders in the subquery represent parameters that will be filled in at runtime with the actual values for <code>product</code> and <code>year</code>.</li>
</ol>
<p>Overall, this query creates a virtual table that pivots the data from the <code>sales</code> table, with the <code>product</code> values as rows, the <code>year</code> values as columns, and the sum of <code>income</code> as the cell values.</p>
</div>
</details>
<p>The extension does the rest:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#a90d91>select</span> <span style=color:#000>*</span> <span style=color:#a90d91>from</span> <span style=color:#000>v_sales</span>;
</code></pre></div><pre tabindex=0><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”
â”‚ product â”‚ 2020 â”‚ 2021 â”‚ 2022 â”‚ 2023 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤
â”‚ alpha   â”‚ 100  â”‚ 120  â”‚ 130  â”‚ 140  â”‚
â”‚ beta    â”‚ 10   â”‚ 20   â”‚ 40   â”‚ 80   â”‚
â”‚ gamma   â”‚ 80   â”‚ 75   â”‚ 78   â”‚ 80   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜
</code></pre><p>That&rsquo;s even easier than the <code>pivot</code> operator in SQL Server!</p>
<h2 id=summary>Summary</h2>
<p>There are three ways to build a pivot table in SQLite:</p>
<ol>
<li>Using plain SQL and <code>sum()</code> + <code>filter</code> expressions.</li>
<li>Building and executing a dynamic query with the <code>eval()</code> function.</li>
<li>Utilizing the <code>pivotvtab</code> extension.</li>
</ol>
<p>P.S. Interested in using SQL for data analytics? Check out my book â€” <a href=/sql-window-functions-book>SQLÂ WindowÂ FunctionsÂ Explained</a></p>
<p><em>Follow <a href=https://twitter.com/ohmypy><strong>@ohmypy</strong></a> on Twitter to keep up with new posts</em>Â ğŸš€</p>
</div>
</div><footer class=post__footer>
<div class=row>
<div class=col-xs-12>
<div class=post__date>
<time datetime="2023-02-09 14:00:00 +0000 UTC">09 Feb, 2023</time>
</div>
<div class=post__tags>
<a href=https://antonz.org/tags/sqlite/>sqlite</a>&nbsp;
</div>
</div>
</div>
</footer></article>
<aside class=post__related>
<div class="post__nav article">
<div class=row>
<div class="col-xs-12 col-sm-6">
<p>&larr;&nbsp;<a href=https://antonz.org/sql-window-functions-ranking/>Ranking Data with SQL Window Functions</a></p>
</div>
<div class="col-xs-12 col-sm-6">
<p><a href=https://antonz.org/sql-window-functions-offset/>Comparing by Offset with SQL Window Functions</a>&nbsp;&rarr;</p>
</div>
</div>
</div>
<div class=article>
<div class=row>
<div class="col-xs-12 col-sm-8 col-md-6">
<h3>See also</h3>
<p><a href=/sqlean-regexp/>Regular Expressions in SQLite</a></p>
<p><a href=/sqlean-define/>User-Defined Functions in SQLite</a></p>
<p><a href=/cte/>Common Table Expressions in SQL</a></p>
</div>
</div>
</div>
</aside>
</div>
</div>
<footer class="container footer">
<ul class=naked-list>
<li class=footer__item>Subscribe:
<a href=https://twitter.com/ohmypy class=footer__social-link>
<i class="fab fa-twitter-1"></i><span>Twitter</span>
</a>
<a href=https://github.com/nalgeon class=footer__social-link>
<i class="fab fa-github-1"></i><span>GitHub</span>
</a>
<a href=https://www.linkedin.com/in/nalgeon/ class=footer__social-link>
<i class="fab fa-linkedin-2"></i><span>LinkedIn</span>
</a>
<a href=/index.xml class=footer__social-link><i class="fas fa-rss"></i><span>RSS</span></a>
</li>
<li class=footer__item>Email: <a href=mailto:m@antonz.org>m@antonz.org</a></li>
</ul>
</footer>
<script async src=//gc.zgo.at/count.js data-goatcounter=https://antonzorg.goatcounter.com/count></script></body>
</html>